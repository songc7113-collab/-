<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>粉嫩小手机</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style id="custom-chat-bubble-styles"></style>
    <style id="custom-font-face-style"></style>
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'PingFang SC', 'Hirino Sans GB', 'Microsoft YaHei', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .resizable-container {
            resize: both;
            overflow: auto;
            min-width: 380px;
            min-height: 820px;
            width: 414px;
            height: 896px;
            max-width: 90vw;
            max-height: 85vh;
            padding: 1rem;
            border: 1px dashed #ccc;
            border-radius: 1rem;
        }
        .phone-frame {
            box-shadow: 0 20px 40px rgba(0,0,0,0.2), 0 15px 12px rgba(0,0,0,0.1);
            width: 100%;
            height: 100%;
        }
        .background-container {
            background-size: cover;
            background-position: center;
            transition: all 0.3s ease;
        }
        .icon-base { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .icon-base:active { transform: scale(0.85); }
        .screen { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .screen.hidden { opacity: 0; pointer-events: none; transform: translateX(20px); }
        .screen.main-hidden { opacity: 0; pointer-events: none; } /* For main screens */
        .screen.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
        .icon-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-bubble { max-width: 75%; }
        .chat-bubble-user { background-color: #A9E97A; }
        .chat-bubble-ai { background-color: #FFFFFF; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Night Mode & Beautification Styles */
        .phone-frame.night-mode .bg-white,
        .phone-frame.night-mode .bg-gray-100, .phone-frame.night-mode .bg-gray-50,
        .phone-frame.night-mode .bg-sky-50,
        .phone-frame.night-mode .bg-indigo-50 {
            background-color: #121212 !important;
        }
        .phone-frame.night-mode .text-gray-800,
        .phone-frame.night-mode .text-gray-700,
        .phone-frame.night-mode .font-bold,
        .phone-frame.night-mode h1, .phone-frame.night-mode h2, .phone-frame.night-mode h3,
        .phone-frame.night-mode span, .phone-frame.night-mode p, .phone-frame.night-mode button,
        .phone-frame.night-mode input, .phone-frame.night-mode textarea, .phone-frame.night-mode select {
            color: #e0e0e0;
        }
        .phone-frame.night-mode .text-gray-500 { color: #888888; }
        .phone-frame.night-mode .text-blue-500 { color: #60a5fa; }
        .phone-frame.night-mode .bg-white\/60 { background-color: rgba(26, 26, 26, 0.7); }
        .phone-frame.night-mode .bg-white\/30 { background-color: rgba(50, 50, 50, 0.5); }
        .phone-frame.night-mode .chat-bubble-ai { background-color: #333333; color: #f1f1f1; }
        .phone-frame.night-mode .border, .phone-frame.night-mode .border-b, .phone-frame.night-mode .border-t, .phone-frame.night-mode .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: #333333 !important; }
        .phone-frame.night-mode #wechat-screen { background-color: #000000; }
        .phone-frame.night-mode .bg-gray-200 { background-color: #222 !important; }
        .phone-frame.night-mode .bg-green-500 { background-color: #166534; }
        .phone-frame.night-mode input, .phone-frame.night-mode textarea, .phone-frame.night-mode select { background-color: #333; border-color: #555; }
        .phone-frame.night-mode input::placeholder, .phone-frame.night-mode textarea::placeholder { color: #888; }
        .phone-frame.night-mode .settings-change-btn, .phone-frame.night-mode .settings-menu-item { border-color: #444; }
        .phone-frame.night-mode .settings-change-btn:hover, .phone-frame.night-mode .settings-menu-item:hover { background-color: #333; }
        .phone-frame.night-mode .bg-purple-500 { background-color: #581c87; }
        .phone-frame.night-mode .bg-gray-500 { background-color: #4b5563; }

        /* Chat bubble styles */
        .chat-bubble-style-rounded .chat-bubble { border-radius: 20px; }
        .chat-bubble-style-gradient .chat-bubble-user { background: linear-gradient(to right, #6EE7B7, #3B82F6); color: white; }
        .chat-bubble-style-gradient .chat-bubble-ai { background: linear-gradient(to right, #4B5563, #1F2937); color: white; }
        .settings-header { flex-shrink: 0; padding: 1rem; background-color: rgba(255,255,255,0.8); backdrop-filter: blur(10px); box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e5e7eb; }
        .phone-frame.night-mode .settings-header { background-color: rgba(18,18,18,0.8); border-bottom-color: #333; }
        /* Generic toggle switch style */
        .toggle-switch { width: 2.75rem; height: 1.5rem; }
        .toggle-switch-dot { width: 1.25rem; height: 1.25rem; }

        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=ZCOOL+KuaiLe&display=swap');

        /* --- STYLES FROM REPLACED INTERFACE --- */
        #wechat-screen {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #wechat-screen .mobile-container {
            border: none;
            box-shadow: none;
            resize: none;
            border-radius: 0;
            max-height: 100%;
            width: 100%;
            height: 100%;
        }
        #wechat-screen :root {
            --bg-color: #fdf6f8; --card-bg-color: #ffffff; --primary-text-color: #333;
            --secondary-text-color: #999; --accent-pink-light: #fdeaf2; --accent-pink-medium: #f8cde0;
            --accent-pink-dark: #f3b4d0; --delete-red: #fca5a5; --like-blue: #576b95;
        }
        #wechat-screen * { box-sizing: border-box; margin: 0; padding: 0; }
        #wechat-screen .page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; background-color: var(--bg-color); }
        #wechat-screen .page.active { opacity: 1; pointer-events: auto; }
        
        #wechat-screen .status-bar { position: absolute; top: 0; left: 0; width: 100%; height: 81px; z-index: 105; background-size: cover; background-position: center; background-image: url('https://i.imgs.ovh/2025/08/22/Gz2gY.jpeg'); }
        #wechat-screen .status-bar-overlay { position: absolute; top: 0; left: 0; width: 100%; z-index: 110; color: #555; font-weight: 500; font-size: 15px; padding: 15px 25px 0; display: flex; justify-content: space-between; align-items: center; }
        #wechat-screen .dynamic-island-container { position: absolute; top: 45px; left: 0; width: 100%; height: 36px; z-index: 120; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        #wechat-screen .dynamic-island { width: 280px; height: 100%; border-radius: 25px; display: flex; justify-content: center; align-items: center; background: rgba(255, 240, 245, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 3px 10px rgba(243, 180, 208, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.6); color: #ca8eb5; font-size: 14px; font-weight: 500; }
        #wechat-screen .add-heart-btn { width: 32px; height: 32px; position: absolute; right: 25px; top: 48px; background: rgba(252, 231, 243, 0.8); backdrop-filter: blur(5px); border-radius: 50%; color: #fff; display: flex; justify-content: center; align-items: center; font-size: 18px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 125; }
        #wechat-screen .status-bar-icons-container { display: flex; align-items: center; gap: 5px; }
        #wechat-screen .heart-battery {
            position: relative; width: 24px; height: 22px; background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px); border-radius: 3px;
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
            filter: drop-shadow(0 0 1px rgba(0, 0, 0, 0.4));
        }
        #wechat-screen .heart-battery-level { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background-color: #f8cde0; transition: height 0.5s ease; }
        #wechat-screen .heart-battery-text { font-size: 12px; font-weight: 500; color: #555;}
        #wechat-screen .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; display: none; justify-content: center; align-items: center; }
        #wechat-screen .modal-content { background: white; padding: 20px; border-radius: 20px; width: 80%; max-width: 350px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); }
        #wechat-screen .modal-content h3 { font-size: 16px; margin-bottom: 15px; text-align: center; color: var(--primary-text-color); }
        #wechat-screen .modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; }
        #wechat-screen .modal-content label { font-size: 13px; color: #555; margin-bottom: 5px; display: block; }
        #wechat-screen .modal-selector { display: flex; justify-content: space-around; margin-bottom: 20px; }
        #wechat-screen .modal-selector label { display: flex; align-items: center; cursor: pointer; }
        #wechat-screen .modal-selector input[type="radio"] { display: none; }
        #wechat-screen .custom-radio { width: 18px; height: 18px; border: 2px solid #ddd; border-radius: 50%; margin-right: 8px; position: relative; }
        #wechat-screen .modal-selector input[type="radio"]:checked + .custom-radio { border-color: #f472b6; }
        #wechat-screen .modal-selector input[type="radio"]:checked + .custom-radio::after { content: ''; position: absolute; top: 3px; left: 3px; width: 8px; height: 8px; background: #f472b6; border-radius: 50%; }
        #wechat-screen .modal-actions { display: flex; justify-content: space-around; margin-top: 10px; }
        #wechat-screen .modal-btn { width: 40%; padding: 10px; border-radius: 15px; border: none; font-size: 20px; cursor: pointer; }
        #wechat-screen .modal-save-btn { background: #a7f3d0; color: #059669; }
        #wechat-screen .modal-cancel-btn { background: #fecaca; color: #dc2626; }
        #wechat-screen .upload-label-btn { display: block; text-align: center; margin-bottom: 15px; background: var(--accent-pink-medium); color: white; padding: 10px; border-radius: 10px; cursor: pointer; }
        #wechat-screen #edit-profile-modal .upload-label-btn {
            border: 1px solid #fbcfe8;
            border-bottom: 3px solid #f3b4d0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.1s ease-in-out;
        }
        #wechat-screen #edit-profile-modal .upload-label-btn:active {
            transform: translateY(2px);
            border-bottom-width: 1px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #wechat-screen .page-content-scrollable { width: 100%; height: 100%; padding-top: 90px; padding-bottom: 80px; overflow-y: auto; position: relative; }
        #wechat-screen .page-content-scrollable::-webkit-scrollbar { width: 5px; }
        #wechat-screen .page-content-scrollable::-webkit-scrollbar-track { background: transparent; }
        #wechat-screen .page-content-scrollable::-webkit-scrollbar-thumb { background: #f8cde0; border-radius: 10px; }
        #wechat-screen .chat-page-header { padding: 15px 15px 0; }
        #wechat-screen .search-container { padding: 10px; }
        #wechat-screen .search-bar { background: white; padding: 8px 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); color: var(--secondary-text-color); text-align: center; font-size: 15px; }
        #wechat-screen .chat-tabs { display: flex; justify-content: flex-start; gap: 20px; padding: 15px 10px; }
        #wechat-screen .tab-item { color: #f3b4d0; font-size: 15px; font-weight: 500; cursor: pointer; position: relative; padding-bottom: 5px; }
        #wechat-screen .tab-item.active { color: #333; }
        #wechat-screen .tab-item.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: #a7f3d0; border-radius: 2px; }
        #wechat-screen .chat-section { background: var(--card-bg-color); border-radius: 20px; margin-bottom: 15px; overflow: hidden; padding: 5px; }
        #wechat-screen .chat-item-wrapper { position: relative; }
        #wechat-screen .chat-item { display: flex; align-items: center; padding: 10px; background-color: #ffffff; position: relative; z-index: 2; transition: transform 0.3s ease, background-color 0.3s ease; cursor: pointer; border-radius: 15px; will-change: transform; }
        #wechat-screen .chat-item.pinned { background-color: #ffffff; }
        #wechat-screen .chat-avatar img { width: 50px; height: 50px; border-radius: 15px; margin-right: 15px; object-fit: cover; }
        #wechat-screen .chat-details { flex-grow: 1; min-width: 0; }
        #wechat-screen .chat-name { font-size: 16px; font-weight: 500; color: var(--primary-text-color); }
        #wechat-screen .chat-preview { font-size: 14px; color: var(--secondary-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #wechat-screen .chat-info { text-align: right; } #wechat-screen .chat-time { font-size: 12px; color: var(--secondary-text-color); }
        #wechat-screen .unread-badge { background-color: var(--delete-red); color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; margin-top: 5px; display: inline-block; }
        #wechat-screen .swipe-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; align-items: center; z-index: 1; padding: 0 5px;}
        #wechat-screen .swipe-actions button { border: none; color: white; font-size: 14px; font-weight: 500; height: calc(100% - 10px); width: 80px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        /* 这是新的“置顶”按钮样式 */
        #wechat-screen .action-pin { 
            background-color: #E5C9C9; /* 莫兰迪粉色 (浅) */
            border-radius: 15px 0 0 15px; 
            font-size: 13px;         /* 调整了字体大小 */
            font-weight: bold;       /* 字体加粗 */
        }
        
        /* 这是新的“删除”按钮样式 */
        #wechat-screen .action-delete { 
            background-color: #E1C5C5; /* 莫兰迪粉色 (深) */
            color: white;              /* 字体颜色改为白色，确保能看清 */
            border-radius: 0 15px 15px 0;
            font-size: 13px;         /* 调整了字体大小 */
            font-weight: bold;       /* 字体加粗 */
        }
        #wechat-screen .bottom-nav { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; background-color: #ffffff; background-size: cover; background-position: center; border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: center; padding-bottom: 15px; z-index: 105; background-image: none; }
        #wechat-screen .nav-item { display: flex; flex-direction: column; align-items: center; color: #c28aa4; font-size: 11px; cursor: pointer; position: relative; }
        #wechat-screen .nav-item.active { color: #f06292; }
        #wechat-screen .nav-item .icon { width: 28px; height: 28px; margin-bottom: 3px; object-fit: contain; }
        #wechat-screen .nav-badge { position: absolute; top: -2px; right: -8px; background-color: var(--delete-red); color: white; border-radius: 50%; font-size: 11px; padding: 2px 5px; font-weight: bold; }
        #wechat-screen #profile-page .page-content-scrollable { background-color: var(--accent-pink-light); padding-left: 15px; padding-right: 15px; }
        #wechat-screen .profile-main-card, #wechat-screen .profile-list-item { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.9); border-radius: 20px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        #wechat-screen .profile-list-item { padding: 12px 15px; border-radius: 18px; cursor: pointer;}
        #wechat-screen .profile-avatar-wrapper { position: relative; width: 70px; height: 70px; margin-right: 15px; flex-shrink: 0; }
        #wechat-screen .profile-avatar { position: absolute; top:0; left:0; width: 100%; height: 100%; border-radius: 50%; object-fit: cover; cursor: pointer; z-index: 1; }
        #wechat-screen .avatar-frame {  position: absolute; top: 0; left: 0;width: 100%; height: 100%;pointer-events: none; z-index: 2; transform: scale(1.15); /* 新增：将头像框从中心放大1.15倍 */}
        #wechat-screen .profile-details { flex-grow: 1; }
        #wechat-screen .profile-name { font-size: 18px; font-weight: 500; color: var(--primary-text-color); }
        #wechat-screen .profile-id { font-size: 14px; color: var(--secondary-text-color); margin-top: 4px; }
        #wechat-screen .profile-status { font-size: 12px; background: var(--accent-pink-light); color: var(--accent-pink-dark); padding: 4px 10px; border-radius: 12px; margin-top: 8px; display: inline-block; cursor: pointer; position: relative; }
        #wechat-screen .decoration-icon { width: 32px; height: 32px; flex-shrink: 0; }
        #wechat-screen .status-switcher-popup { position: absolute; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 8px; width: 150px; z-index: 2000; opacity: 0; transform: translateY(-10px); transition: opacity 0.2s, transform 0.2s; pointer-events: none; }
        #wechat-screen .status-switcher-popup.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        #wechat-screen .status-switcher-popup ul { list-style: none; max-height: 150px; overflow-y: auto; }
        #wechat-screen .status-switcher-popup ul::-webkit-scrollbar { width: 4px; }
        #wechat-screen .status-switcher-popup ul::-webkit-scrollbar-thumb { background: #f8cde0; border-radius: 4px; }
        #wechat-screen .status-switcher-popup li { padding: 10px; font-size: 14px; border-radius: 10px; cursor: pointer; }
        #wechat-screen .status-switcher-popup li:hover { background-color: var(--accent-pink-light); }
        #wechat-screen #discover-page .page-content-scrollable { padding: 0; padding-top: 0; background-color: #ffffff; }
        #wechat-screen .page-back-btn { display: none; }
        #wechat-screen .moments-header { position: relative; margin-bottom: 20px; }
        #wechat-screen .cover-photo { width: 100%; height: 300px; object-fit: cover; display: block; }
        #wechat-screen .user-info { position: absolute; bottom: -15px; right: 15px; display: flex; align-items: center; }
        #wechat-screen .user-info .name { color: white; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.4); margin-right: 15px; }
        #wechat-screen .user-info .avatar { width: 70px; height: 70px; border-radius: 10px; border: 2px solid white; object-fit: cover; }
        #wechat-screen .moments-feed { padding: 15px 0; }
        #wechat-screen .moment-post { display: flex; border-bottom: 1px solid #f0f0f0; background: white; margin: 0 10px 15px; border-radius: 15px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
        #wechat-screen .moment-avatar { width: 45px; height: 45px; border-radius: 8px; margin-right: 12px; object-fit: cover; }
        #wechat-screen .moment-content { flex-grow: 1; }
        #wechat-screen .moment-author { font-weight: 500; color: var(--like-blue); margin-bottom: 5px; }
        #wechat-screen .moment-text { margin-bottom: 8px; line-height: 1.5; font-size: 15px; white-space: pre-wrap; }
        #wechat-screen .moment-media img { width: 120px; height: 120px; object-fit: cover; border-radius: 6px; }
        #wechat-screen .moment-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 13px; color: #999; }
        #wechat-screen .moment-location { margin-right: auto; padding-right: 10px; }
        #wechat-screen .moment-interactions { background-color: #f7f7f7; border-radius: 6px; margin-top: 8px; font-size: 13px; line-height: 1.5; overflow: hidden; }
        #wechat-screen .moment-likes, #wechat-screen .moment-comments-list { padding: 8px 12px; }
        #wechat-screen .moment-likes { color: var(--like-blue); border-bottom: 1px solid #eee; }
        #wechat-screen .moment-likes:empty, #wechat-screen .moment-comments-list:empty { display: none; }
        #wechat-screen .moment-likes:not(:empty) + #wechat-screen .moment-comments-list { border-top: none; }
        #wechat-screen .comment-item { margin-bottom: 2px; }
        #wechat-screen .comment-author { color: var(--like-blue); font-weight: 500; }
        #wechat-screen .comment-input-wrapper { margin: -5px 10px 15px 10px; display: flex; gap: 5px; }
        #wechat-screen .comment-input { flex-grow: 1; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 13px; }
        #wechat-screen .comment-input-btn { background: none; border: none; font-size: 20px; cursor: pointer; }
        #wechat-screen .moment-action-popup {
            position: absolute; display: none; background: #4c4c4c; border-radius: 6px; height: 35px;
            width: 140px; align-items: center; z-index: 10; color: white; font-size: 13px; overflow: hidden;
        }
        #wechat-screen .moment-action-popup button { background: none; border: none; color: white; padding: 0 15px; height: 100%; cursor: pointer; flex-grow: 1; }
        #wechat-screen .moment-action-popup button:first-child { border-right: 1px solid #555; }
        #wechat-screen .moment-action-popup button:hover { background: #333; }
        #wechat-screen .moments-settings-btn {
            position: absolute;
            top: 95px;
            left: 15px;
            width: 36px;
            height: 36px;
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 5;
            border: 1px solid rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(4px);
        }
        #wechat-screen #contacts-page .page-content-scrollable { background-color: var(--accent-pink-light); padding-left:0; padding-right:0; padding-top: 145px;}
        #wechat-screen .contacts-header {
            position: absolute; top: 90px; left: 0; width: 100%;
            padding: 10px 15px; background-color: var(--accent-pink-light);
            display: flex; align-items: center; gap: 10px; z-index: 5;
        }
        #wechat-screen #contact-search-input {
            flex-grow: 1; border: none; padding: 10px 15px;
            border-radius: 18px; box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        #wechat-screen #contact-search-input:focus { outline: 1px solid var(--accent-pink-medium); }
        /* MODIFIED: Contacts page sort button color */
        #wechat-screen #sort-contacts-btn {
            background-color: var(--accent-pink-medium); /* Changed to peach-pink */
            color: white; border: none; width: 36px; height: 36px;
            border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; line-height: 1;
        }
        #wechat-screen #sort-options-popup {
            position: absolute; top: 100%; right: 0; margin-top: 5px; background: white; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 5px; z-index: 6; display: none; width: 120px;
        }
        #wechat-screen #sort-options-popup button {
            display: block; width: 100%; background: none; border: none; text-align: left; padding: 8px 12px;
            font-size: 14px; border-radius: 8px; cursor: pointer;
        }
        #wechat-screen #sort-options-popup button:hover { background-color: var(--accent-pink-light); }
        #wechat-screen .contact-list { padding-bottom: 20px; }
        #wechat-screen .contact-group { margin: 0; }
        #wechat-screen .contact-group-header { padding: 2px 15px; font-size: 13px; color: #888; background-color: #f0f0f0; }
        #wechat-screen .contact-item { display: flex; align-items: center; background: white; padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
        #wechat-screen .contact-item img { width: 40px; height: 40px; border-radius: 8px; margin-right: 12px; }
        #wechat-screen .contact-item span { font-size: 16px; }
        #wechat-screen #settings-page .page-content-scrollable { padding-left: 15px; padding-right: 15px; background-color: var(--bg-color); }
        #wechat-screen .settings-section { background: white; border-radius: 20px; padding: 10px 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #wechat-screen .settings-header { font-size: 16px; font-weight: 500; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        #wechat-screen .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; font-size: 15px; }
        /* MODIFIED: Styling for all buttons/labels in settings */
        #wechat-screen .settings-item button, #wechat-screen .settings-item .upload-label {
            background: var(--accent-pink-medium);
            color: #000000;
            border: none;
            padding: 5px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            box-shadow: 0 2px 4px rgba(248, 205, 224, 0.4);
            transition: all 0.2s ease;
        }
        #wechat-screen .settings-item button:hover, #wechat-screen .settings-item .upload-label:hover {
            background-color: var(--accent-pink-dark);
            box-shadow: 0 4px 8px rgba(243, 180, 208, 0.5);
            transform: translateY(-1px);
        }
        #wechat-screen .settings-item button:active, #wechat-screen .settings-item .upload-label:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(243, 180, 208, 0.5);
        }
        #wechat-screen .input-group { display: flex; gap: 10px; width: 60%; }
        #wechat-screen .color-input { border: 1px solid #ddd; border-radius: 12px; padding: 6px 10px; font-size: 12px; flex-grow: 1; color: #000; }
        #wechat-screen .apply-btn {
            background-color: var(--accent-pink-medium);
            color: #000000;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(248, 205, 224, 0.4);
            transition: all 0.2s ease;
        }
        #wechat-screen .apply-btn:hover {
            background-color: var(--accent-pink-dark);
            box-shadow: 0 4px 8px rgba(243, 180, 208, 0.5);
            transform: translateY(-1px);
        }
        #wechat-screen .apply-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(243, 180, 208, 0.5);
        }
        #wechat-screen #back-to-profile { margin-top: 10px; width: 100%; }
        #wechat-screen .alert-popup { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: #f8cde0; color: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 2000; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none; }
        #wechat-screen .alert-popup.show { opacity: 1; top: 70px; }
        #wechat-screen #ai-chat-page.active ~ .status-bar, #wechat-screen #ai-chat-page.active ~ .status-bar-overlay, #wechat-screen #ai-chat-page.active ~ .dynamic-island-container, #wechat-screen #ai-chat-page.active ~ .add-heart-btn, #wechat-screen #ai-chat-page.active ~ .bottom-nav,
        #wechat-screen #publish-moment-page.active ~ .status-bar, #wechat-screen #publish-moment-page.active ~ .status-bar-overlay, #wechat-screen #publish-moment-page.active ~ .dynamic-island-container, #wechat-screen #publish-moment-page.active ~ .add-heart-btn, #wechat-screen #publish-moment-page.active ~ .bottom-nav,
        #wechat-screen #view-moments-page.active ~ .status-bar, #wechat-screen #view-moments-page.active ~ .status-bar-overlay, #wechat-screen #view-moments-page.active ~ .dynamic-island-container, #wechat-screen #view-moments-page.active ~ .add-heart-btn,
        #wechat-screen #chat-settings-page.active ~ .status-bar, #wechat-screen #chat-settings-page.active ~ .status-bar-overlay, #wechat-screen #chat-settings-page.active ~ .dynamic-island-container, #wechat-screen #chat-settings-page.active ~ .add-heart-btn, #wechat-screen #chat-settings-page.active ~ .bottom-nav,
        #wechat-screen #view-moments-page.active ~ .bottom-nav { display: none; }
        #wechat-screen #ai-chat-page { display: flex; flex-direction: column; background-color: #f7f7f7; }
        #wechat-screen .chat-header { display: flex; flex-direction: column; justify-content: flex-start; padding: 0; background-color: var(--accent-pink-light); position: absolute; top: 0; left: 0; width: 100%; height: 90px; z-index: 101; box-sizing: border-box; }
        #wechat-screen .chat-page-statusbar { width: 100%; padding: 15px 25px 0; display: flex; justify-content: space-between; font-size: 15px; font-weight: 500; color: #555; box-sizing: border-box; flex-shrink: 0; align-items: center;}
        #wechat-screen .chat-header-controls { display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 5px 15px; flex-grow: 1; }
        #wechat-screen .back-to-list-btn { background: none; border: none; font-size: 24px; font-weight: bold; color: #333; cursor: pointer; }
        #wechat-screen .chat-title { text-align: center; }
        #wechat-screen #chat-contact-name { font-size: 16px; font-weight: 500; }
        #wechat-screen #chat-contact-status { font-size: 12px; color: #888; display: flex; align-items: center; justify-content: center; }
        #wechat-screen .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        #wechat-screen .status-dot.online { background-color: #4caf50; }
        #wechat-screen .status-dot.offline { background-color: #9e9e9e; }
        #wechat-screen .chat-settings-icon { width: 24px; height: 24px; cursor: pointer; }
        #wechat-screen .chat-messages { flex-grow: 1; overflow-y: auto; padding: 100px 10px 80px; display: flex; flex-direction: column; gap: 15px; background-size: cover; background-position: center; }
        #wechat-screen .chat-messages::-webkit-scrollbar { display: none; }
        #wechat-screen .message-bubble { display: flex; max-width: 75%; align-items: flex-start; gap: 10px; }
        
        #wechat-screen .chat-avatar-wrapper {
            position: relative;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        #wechat-screen .message-bubble .avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
            flex-shrink: 0;
            border-radius: 8px;
        }

        #wechat-screen .message-content { padding: 10px 15px; border-radius: 18px; position: relative; }
        #wechat-screen .message-meta { font-size: 10px; color: #aaa; text-align: right; margin-top: 5px; white-space: nowrap; }
        #wechat-screen .ai-message { align-self: flex-start; }
        #wechat-screen .ai-message .message-content { background-color: #ffffff; border-top-left-radius: 4px; }
        #wechat-screen .user-message { align-self: flex-end; flex-direction: row-reverse; }
        #wechat-screen .user-message .message-content { background-color: #e1ffc7; border-top-right-radius: 4px; }
        #wechat-screen .chat-input-area { position: absolute; bottom: 0; left: 0; width: 100%; min-height: 60px; background-color: var(--accent-pink-light); border-top: 1px solid #f0f0f0; display: flex; align-items: center; padding: 8px 10px; gap: 10px; z-index: 103; }
        #wechat-screen #chat-message-input { flex-grow: 1; border: none; border-radius: 15px; padding: 10px 15px; font-size: 15px; color: #000; }
        #wechat-screen #chat-message-input:focus { outline: none; }
        #wechat-screen .input-icon-btn { background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; }
        #wechat-screen .input-icon-btn img { width: 36px; height: 36px; }
        #wechat-screen .input-icon { cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; }
        #wechat-screen #send-message-btn:disabled img { opacity: 0.5; }
        #wechat-screen .action-panel, #wechat-screen .emoji-picker { position: absolute; bottom: 60px; left: 0; width: 100%; background-color: #f7f7f7; border-top: 1px solid #eee; z-index: 102; padding: 15px; display: none; }
        #wechat-screen .action-panel { display: none; flex-wrap: wrap; gap: 20px; justify-content: space-around; }
        #wechat-screen .action-item { display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 12px; color: #555; cursor: pointer; }
        #wechat-screen .action-item span { font-size: 24px; width: 50px; height: 50px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        #wechat-screen .emoji-picker { display: none; flex-wrap: wrap; gap: 10px; height: 200px; overflow-y: auto; }
        #wechat-screen .emoji-item { font-size: 24px; cursor: pointer; padding: 5px; border-radius: 5px; }
        #wechat-screen .emoji-item:hover { background-color: #eee; }
        #wechat-screen #add-local-emoji-btn { width: 100%; padding: 10px; margin-top: 10px; border: 1px dashed #ccc; background: #f0f0f0; border-radius: 10px; cursor: pointer; }
        #wechat-screen #publish-moment-page { background-color: #fff; flex-direction: column; display: flex;}
        #wechat-screen .publish-page-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; height: 50px; background-color: #f7f7f7;
            border-bottom: 1px solid #eee; position: absolute; top: 0; width: 100%; z-index: 10;
        }
        #wechat-screen .publish-page-header button { background: none; border: none; cursor: pointer; }
        #wechat-screen .publish-page-header .publish-back-btn { font-size: 22px; width: 50px; text-align: left; }
        #wechat-screen .publish-page-header span { font-size: 17px; font-weight: 500; }
        #wechat-screen .publish-page-header .publish-submit-btn {
            background-color: #d1d5db; color: white; padding: 6px 15px;
            border-radius: 6px; font-size: 15px; transition: background-color 0.2s;
        }
        #wechat-screen .publish-page-header .publish-submit-btn:not(:disabled) { background-color: #16a34a; }
        #wechat-screen .publish-page-content { flex-grow: 1; padding: 65px 15px 15px; }
        #wechat-screen #moment-text-input {
            width: 100%; height: 200px; border: none; outline: none;
            font-size: 16px; line-height: 1.6; resize: none; color: #000;
        }
        #wechat-screen .publish-options { margin-top: 20px; }
        #wechat-screen .publish-option-item {
            display: flex; align-items: center; padding: 15px 0; cursor: pointer;
            border-bottom: 1px solid #f0f0f0; font-size: 15px;
        }
        #wechat-screen .publish-option-item:first-child { border-top: 1px solid #f0f0f0; }
        #wechat-screen .publish-option-item span { font-size: 20px; margin-right: 10px; }
        #wechat-screen #view-moments-page { background-color: #f7f7f7; }
        #wechat-screen #view-moments-contact-list .contact-item { display: flex; align-items: center; cursor: pointer; }
        #wechat-screen #view-moments-contact-list label { display: flex; align-items: center; width: 100%; }
        #wechat-screen #view-moments-contact-list input[type="checkbox"] { margin-right: 15px; width: 20px; height: 20px; }
        #wechat-screen .view-moments-footer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 70px; background-color: #fff; border-top: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        }
        #wechat-screen .view-moments-footer .footer-btn {
            font-size: 30px; border: none; background: none; cursor: pointer;
            width: 50px; height: 50px; border-radius: 50%;
        }
        #wechat-screen .view-moments-footer .confirm-btn { color: #059669; background-color: #a7f3d0; }
        #wechat-screen .view-moments-footer .cancel-btn { color: #dc2626; background-color: #fecaca; }
        #wechat-screen #back-to-home-from-wechat {
            position: absolute;
            top: 48px;
            left: 1rem;
            z-index: 2000;
            font-size: 1.5rem;
            font-weight: bold;
            color: black;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding-bottom: 2px;
            border: none;
            cursor: pointer;
            display: none;
        }
        
        /* --- BROWSER STYLES START --- */
        @keyframes progress {
          0% { width: 0%; left: 0; }
          50% { width: 100%; left: 0; }
          100% { width: 0%; left: 100%; }
        }
        @keyframes browserSpin { 100% { transform: rotate(360deg); } }
        @keyframes fadeInOut {
          0% { opacity: 0; transform: translate(-50%, -40%); }
          20% { opacity: 1; transform: translate(-50%, -50%); }
          80% { opacity: 1; transform: translate(-50%, -50%); }
          100% { opacity: 0; transform: translate(-50%, -60%); }
        }
        .progress-active {
            animation: progress 1.5s infinite;
        }
        #backFeedback {
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* --- BROWSER STYLES END --- */
        /* --- WORLD BOOK STYLES START --- */
        #worldbook-entry-list .entry-item {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid transparent;
        }
        #worldbook-entry-list .entry-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        #worldbook-entry-list .entry-item.selecting {
            border-left-color: #3b82f6; /* 蓝色边框表示正在进行长按选择 */
            background-color: #eff6ff;
        }
        /* --- WORLD BOOK STYLES END --- */
         /* 新增：这是朋友圈主要内容的容器，我们将用它来定位按钮 */
        #wechat-screen .moment-body {
            position: relative;
            padding-bottom: 30px; /* 为下方的“meta”信息和按钮留出空间 */
        }
        
        /* 更新：“三个点”按钮现在相对于 moment-body 定位 */
        #wechat-screen .moment-actions-btn {
            position: absolute;
            bottom: 10px; /* 距离 .moment-body 底部 10px */
            right: 0;     /* 距离 .moment-body 右侧 0px */
            background: #f0f2f5;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding-bottom: 4px;
        }
        
        /* NEW: AI Notification Popup Styles */
        .notification-popup {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translate(-50%, -150%);
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            padding: 8px 12px;
            z-index: 9999;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: #333;
        }
        .notification-popup.show {
            transform: translate(-50%, 0);
        }
        .notification-popup img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
                .notification-popup {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translate(-50%, -150%);
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            padding: 8px 15px; /* Adjusted padding */
            z-index: 9999;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: #333;
            width: 250px; /* Added width to make it longer */
            justify-content: center; /* Center the content inside */
        }
        .notification-popup.show {
            transform: translate(-50%, 0);
        }
        .notification-popup img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        .notification-popup p {
            font-size: 14px;
            font-weight: 500;
        }
    </style>
        <style>
        /* --- 音乐播放器专属样式 --- */
        #music-screen {
            /* 定义播放器内部使用的颜色变量和字体 */
            --primary-color: #c20c0c;
            --text-color-light: #fff;
            --text-color-dark: #333;
            --text-shadow: 0 2px 6px rgba(0,0,0,0.6); 
            --border-color: rgba(255, 255, 255, 0.3);
            --button-bg: rgba(0, 0, 0, 0.25);
            --button-hover-bg: rgba(0, 0, 0, 0.35);
            --milky-blue: #a7c7e7;
            --background-blur: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #music-screen .music-player {
            width: 100%; height: 100%;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            overflow: hidden; display: flex; flex-direction: column;
            position: relative; background-size: cover; background-position: center;
            transition: background-image 0.5s ease-in-out;
            background-image: url('https://picsum.photos/id/1015/400/700');
        }
        #music-screen .player-background-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.05); 
            backdrop-filter: blur(var(--background-blur)); 
            -webkit-backdrop-filter: blur(var(--background-blur));
            transition: backdrop-filter 0.2s ease, -webkit-backdrop-filter 0.2s ease;
            z-index: 1;
        }
        #music-screen .player-content {
            position: relative; z-index: 2; display: flex; flex-direction: column;
            height: 100%; color: var(--text-color-light); text-shadow: var(--text-shadow);
        }
        #music-screen .player-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        #music-screen .header-actions { display: flex; align-items: center; gap: 10px; width: 90px; }
        #music-screen .header-actions.left { justify-content: flex-start; }
        #music-screen .header-actions.right { justify-content: flex-end; }
        #music-screen .song-info { text-align: center; flex-grow: 1; }
        #music-screen .settings-panel {
            position: absolute; top: 75px; right: 20px; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; z-index: 100;
            display: flex; flex-direction: column; align-items: flex-start; gap: 15px;
            opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease;
        }
        #music-screen .settings-panel.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        #music-screen .setting-group { display: flex; align-items: center; gap: 10px; width: 100%; }
        #music-screen .settings-panel label { font-size: 14px; white-space: nowrap; }
        #music-screen #blur-slider { -webkit-appearance: none; width: 120px; height: 5px; background: rgba(255,255,255,0.3); border-radius: 5px; }
        #music-screen #blur-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: white; cursor: pointer; }
        #music-screen .weather-options label { cursor: pointer; }
        #music-screen #weather-effect-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 3; }
        #music-screen .snow-flake { position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; opacity: 0.8; animation: snowfall linear infinite; }
        @keyframes snowfall {
            0% { transform: translateY(-10px) translateX(0); }
            100% { transform: translateY(100vh) translateX(20px); } /* Use vh for vertical height */
        }
        #music-screen .rain-drop { position: absolute; width: 1px; height: 20px; background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.2)); animation: rainfall linear infinite; }
        @keyframes rainfall {
            0% { transform: translateY(-20px); }
            100% { transform: translateY(100vh); } /* Use vh for vertical height */
        }
        #music-screen svg{filter:drop-shadow(0 1px 3px rgba(0,0,0,.5))}
        #music-screen .header-btn{background:var(--button-bg);border:1px solid var(--border-color);border-radius:50%;cursor:pointer;width:40px;height:40px;display:flex;justify-content:center;align-items:center;transition:background-color .2s ease}
        #music-screen .header-btn:hover{background-color:var(--button-hover-bg)}
        #music-screen #song-title{font-size:20px;font-weight:600;margin:0}
        #music-screen #song-artist{font-size:14px;margin:4px 0 0;opacity:.9}
        #music-screen .main-content-area{flex-grow:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:10px 20px}
        #music-screen .listener-avatars{display:flex;justify-content:center;align-items:center;gap:15px;margin-bottom:25px;height:65px}
        #music-screen .avatar{width:65px;height:65px;border-radius:50%;border:2px solid hsla(0,0%,100%,.8);box-shadow:0 4px 10px rgba(0,0,0,.2);cursor:pointer;transition:all .3s ease}
        #music-screen .avatar:hover{transform:scale(1.1)}
        #music-screen #guest-avatar{display:none}
        #music-screen .music-player.listening-together #guest-avatar{display:block}
        #music-screen .listen-together-controls{display:none;align-items:center;gap:15px}
        #music-screen .music-player.listening-together .listen-together-controls{display:flex}
        #music-screen .listen-together-controls button{width:40px;height:40px;border-radius:50%;background:var(--button-bg);border:1px solid var(--border-color);cursor:pointer;display:flex;justify-content:center;align-items:center;transition:all .3s ease}
        #music-screen .listen-together-controls button:hover{background-color:var(--button-hover-bg)}
        #music-screen .listen-together-info{display:none;color:var(--text-color-light);font-size:12px;text-shadow:0 1px 3px rgba(0,0,0,.5);margin-top:-15px;margin-bottom:20px;text-align:center}
        #music-screen .music-player.listening-together .listen-together-info{display:block}
        #music-screen .vinyl { width: 230px; height: 230px; border-radius: 50%; background: rgba(220, 220, 225, 0.25); border: 1px solid rgba(255, 255, 255, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; box-shadow: inset 0 0 20px rgba(255,255,255,0.5), 0 5px 20px rgba(0,0,0,0.1); animation: rotate 12s linear infinite; animation-play-state: paused; }
        #music-screen .vinyl.playing { animation-play-state: running; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #music-screen #album-art{width:90px;height:90px;border-radius:50%;object-fit:cover;cursor:pointer;transition:transform .2s ease}
        #music-screen #album-art:hover{transform:scale(1.1);opacity:.8}
        #music-screen input[type=range]{-webkit-appearance:none;width:100%;background:0 0}
        #music-screen input[type=range]:focus{outline:0}
        #music-screen input[type=range]::-webkit-slider-runnable-track{width:100%;height:6px;cursor:pointer;background:hsla(0,0%,100%,.3);border-radius:3px}
        #music-screen input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:20px;width:20px;margin-top:-7px;background:0 0;cursor:pointer;position:relative}
        #music-screen input[type=range]::-webkit-slider-thumb:after,#music-screen input[type=range]::-webkit-slider-thumb:before{content:"";position:absolute;width:10px;height:16px;top:2px;border-radius:5px 5px 0 0;background:rgba(167,199,231,.8);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px)}
        #music-screen input[type=range]::-webkit-slider-thumb:before{left:5px;transform:rotate(-45deg);transform-origin:0 100%}
        #music-screen input[type=range]::-webkit-slider-thumb:after{left:0;transform:rotate(45deg);transform-origin:100% 100%}
        #music-screen #progress-wrapper{width:100%;background:hsla(0,0%,100%,.3);border-radius:3px;position:relative;height:6px}
        #music-screen #progress-fill{height:100%;background-color:var(--milky-blue);border-radius:3px;width:0}
        #music-screen #progress-bar{position:absolute;top:-5px;left:-2px;height:16px;margin:0;padding:0}
        #music-screen #play-pause-btn{background:var(--milky-blue);border:none}
        #music-screen #play-pause-btn:hover{background:#b8d4f4}
        #music-screen .controls-wrapper{padding:0 25px 20px;flex-shrink:0;z-index:5;background:linear-gradient(to top,rgba(0,0,0,.2),transparent)}
        #music-screen .time-controls{display:flex;justify-content:space-between;font-size:12px;margin-bottom:5px}
        #music-screen .controls{display:flex;justify-content:space-between;align-items:center}
        #music-screen .control-btn{background:var(--button-bg);border:1px solid var(--border-color);border-radius:50%;cursor:pointer;padding:10px;display:flex;justify-content:center;align-items:center;transition:all .2s ease}
        #music-screen .control-btn:hover{background-color:var(--button-hover-bg)}
        #music-screen .control-btn:active{transform:scale(.92)}
        #music-screen .control-btn svg{width:24px;height:24px}
        #music-screen #play-pause-btn svg{width:28px;height:28px}
        #music-screen .chat-dialog{position:absolute;top:0;left:0;right:0;bottom:0;z-index:80;background:rgba(0,0,0,.3);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);display:flex;flex-direction:column;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease}
        #music-screen .chat-dialog.visible{opacity:1;visibility:visible}
        #music-screen .chat-header{padding:15px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);flex-shrink:0}
        #music-screen .chat-header h3{margin:0;font-size:16px}
        #music-screen #close-chat-btn{background:0 0;border:none;cursor:pointer;color:#fff;font-size:24px;line-height:1}
        #music-screen #chat-messages{flex-grow:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px}
        #music-screen .chat-message{padding:8px 12px;border-radius:12px;max-width:75%;line-height:1.4;word-wrap:break-word}
        #music-screen .chat-message.me{background-color:var(--primary-color);color:#fff;border-bottom-right-radius:2px;align-self:flex-end}
        #music-screen .chat-message.ai{background-color:hsla(0,0%,100%,.9);color:var(--text-color-dark);text-shadow:none;border-bottom-left-radius:2px;align-self:flex-start}
        #music-screen .chat-input-area{display:flex;padding:15px;border-top:1px solid var(--border-color);background:rgba(0,0,0,.2);flex-shrink:0}
        #music-screen #chat-input{flex-grow:1;border:none;padding:10px;border-radius:20px;background:hsla(0,0%,100%,.8);color:var(--text-color-dark);text-shadow:none}
        #music-screen #chat-input:focus{outline:0}
        #music-screen #send-btn{background:var(--primary-color);color:#fff;border:none;border-radius:50%;width:40px;height:40px;margin-left:10px;cursor:pointer;display:flex;justify-content:center;align-items:center}
        #music-screen .modal{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:100;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:all .3s ease} /* Changed from position:fixed */
        #music-screen .modal.visible{opacity:1;visibility:visible}
        #music-screen .modal-dialog{background:hsla(0,0%,100%,.85);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:25px;border-radius:20px;text-align:center;transform:scale(.9);transition:transform .3s ease;width:320px;color:var(--text-color-dark)}
        #music-screen .modal.visible .modal-dialog{transform:scale(1)}
        #music-screen .modal-dialog h3{margin:0 0 10px;font-size:18px}
        #music-screen .modal-dialog p{margin:0 0 20px;font-size:14px;opacity:.7}
        #music-screen .modal-actions button{padding:12px 25px;border:none;border-radius:10px;cursor:pointer;margin:0 10px;font-size:14px;transition:background-color .2s}
        #music-screen .modal-confirm-btn{background:var(--primary-color);color:#fff}
        #music-screen .modal-confirm-btn:disabled{background:#999;cursor:not-allowed}
        #music-screen #playlist-url-input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:20px;box-sizing:border-box}
        #music-screen .character-list{list-style:none;padding:0;margin:0 0 20px;max-height:250px;overflow-y:auto}
        #music-screen .character-item{display:flex;align-items:center;padding:10px;border-radius:10px;margin-bottom:8px;cursor:pointer;border:2px solid transparent;transition:all .2s ease}
        #music-screen .character-item:hover{background-color:rgba(0,0,0,.05)}
        #music-screen .character-item label{display:flex;align-items:center;width:100%;cursor:pointer}
        #music-screen .character-item input[type=radio]{margin-right:15px;width:18px;height:18px}
        #music-screen .character-item img{width:50px;height:50px;border-radius:50%;margin-right:10px}
        #music-screen .character-item-info{text-align:left}
        #music-screen .character-item-info strong{font-size:16px}
        #music-screen .character-item-info span{font-size:12px;opacity:.7;display:block}
        #music-screen #add-ai-avatar-preview{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:10px;background:#eee;cursor:pointer}
        #music-screen #add-ai-modal .form-group{margin-bottom:15px;text-align:left}
        #music-screen #add-ai-modal label{font-size:14px;font-weight:700;margin-bottom:5px;display:block}
        #music-screen #add-ai-modal input,#music-screen #add-ai-modal textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;box-sizing:border-box;font-family:inherit}
        #music-screen #add-ai-modal textarea{resize:vertical;min-height:60px}
        #music-screen .playlist-sidebar{position:absolute;top:0;right:-100%;width:85%;height:100%;background:hsla(0,0%,100%,.85);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);z-index:90;transition:right .4s ease-in-out;display:flex;flex-direction:column;color:var(--text-color-dark)}
        #music-screen .playlist-sidebar.visible{right:0;box-shadow:-10px 0 30px rgba(0,0,0,.1)}
        #music-screen .playlist-header{display:flex;justify-content:space-between;align-items:center;padding:20px;font-size:18px;font-weight:700;border-bottom:1px solid rgba(0,0,0,.1);flex-shrink:0}
        #music-screen .playlist-header-title{flex-grow:1;text-align:center;padding-left:32px}
        #music-screen .playlist-header button{background:0 0;border:none;cursor:pointer}
        #music-screen #playlist-list{flex-grow:1;overflow-y:auto;padding:0;margin:0;list-style:none}
        #music-screen .playlist-item{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;cursor:pointer;border-bottom:1px solid rgba(0,0,0,.05)}
        #music-screen .playlist-item:hover{background:rgba(0,0,0,.05)}
        #music-screen .playlist-item-info{flex-grow:1}
        #music-screen .playlist-item:hover .remove-song-btn{opacity:1}
        #music-screen .remove-song-btn{opacity:.3;transition:opacity .2s;padding:5px}
        #music-screen .playlist-item.active{color:var(--primary-color);font-weight:700}
        #music-screen .playlist-item-title{font-size:16px}
        #music-screen .playlist-item-artist{font-size:12px;opacity:.7}
        #music-screen .import-section{padding:15px;border-top:1px solid rgba(0,0,0,.1);display:grid;grid-template-columns:1fr 1fr;gap:10px;flex-shrink:0}
        #music-screen .import-btn{padding:12px;background:rgba(0,0,0,.05);border:none;border-radius:8px;cursor:pointer;text-align:center;font-size:14px;transition:background-color .2s}
        #music-screen .import-btn:hover{background:rgba(0,0,0,.1)}
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="resizable-container">
        <div class="phone-frame bg-black rounded-[40px] border-[10px] border-black overflow-hidden relative flex flex-col">
            
            <input type="file" id="wallpaper-input" class="hidden" accept="image/*"><input type="file" id="top-bg-input" class="hidden" accept="image/*"><input type="file" id="bottom-bg-input" class="hidden" accept="image/*"><input type="file" id="avatar-input" class="hidden" accept="image/*"><input type="file" id="island-avatar-input" class="hidden" accept="image/*"><input type="file" id="widget-icon-input-1" class="hidden" accept="image/*"><input type="file" id="widget-icon-input-2" class="hidden" accept="image/*"><input type="file" id="app-icon-input-1" class="hidden" accept="image/*"><input type="file" id="app-icon-input-2" class="hidden" accept="image/*"><input type="file" id="app-icon-input-3" class="hidden" accept="image/*"><input type="file" id="app-icon-input-4" class="hidden" accept="image/*"><input type="file" id="dock-icon-input-1" class="hidden" accept="image/*"><input type="file" id="dock-icon-input-2" class="hidden" accept="image/*"><input type="file" id="dock-icon-input-3" class="hidden" accept="image/*"><input type="file" id="dock-icon-input-4" class="hidden" accept="image/*"><input type="file" id="xiaohongshu-image-input" class="hidden" accept="image/*"><input type="file" id="import-file-input" class="hidden" accept=".json"><input type="file" id="font-input" class="hidden" accept=".ttf,.otf,.woff,.woff2">
            <input type="file" id="chat-ai-avatar-input" style="display:none;" accept="image/*">
            <input type="file" id="chat-ai-frame-input" style="display:none;" accept="image/*">
            <input type="file" id="chat-user-avatar-input" style="display:none;" accept="image/*">
            <input type="file" id="chat-user-frame-input" style="display:none;" accept="image/*">
            <input type="file" id="chat-wallpaper-input" style="display:none;" accept="image/*">


            <div id="phone-background" class="absolute inset-0 w-full h-full bg-white background-container"></div>

            <div id="ai-notification-popup" class="notification-popup">
                <img id="notification-avatar" src="">
                <p>收到了好友的新消息</p>
            </div>
            
            <div class="relative w-full h-full flex flex-col">
                <div id="home-screen" class="screen active main-screen w-full h-full flex flex-col">
                    <div class="absolute top-0 left-0 w-full h-12 text-black z-50 px-6 flex justify-between items-center">
                        <div id="time" class="font-semibold text-sm w-1/4 text-left"></div>
                        <div id="dynamic-island" class="flex items-center justify-between h-9 bg-black rounded-full px-2 flex-grow-0 flex-shrink-0" style="width: 12rem;">
                            <div id="island-avatar-container" class="w-7 h-7 rounded-full overflow-hidden bg-gray-700"><img id="island-avatar-img" src="https://placehold.co/28x28/FFFFFF/333333?text=ICON" class="icon-image"></div>
                            <span class="text-xl">🤍</span>
                        </div>
                        <div id="status-icons" class="w-1/4 flex justify-end items-center space-x-1">
                            <span id="battery-level" class="font-semibold text-sm">--%</span>
                            </div>
                    </div>
                    <div class="flex-1 flex flex-col items-center pt-24 px-6 text-center">
                        <div class="absolute top-[100px] left-1/2 -translate-x-1/2 w-[90%] h-[250px] rounded-3xl overflow-hidden shadow-lg z-10">
                            <div id="top-bg-container" class="h-1/2 w-full background-container"></div>
                            <div id="bottom-bg-container" class="h-1/2 w-full background-container"></div>
                        </div>
                        <div class="relative z-20 flex flex-col items-center mt-16">
                            <div id="avatar-container" class="w-24 h-24 rounded-full border-4 border-white shadow-lg overflow-hidden bg-gray-200"><img id="avatar-img" src="https://placehold.co/100x100/EFEFEF/333333?text=头像" alt="Avatar" class="icon-image"></div>
                            <h1 id="user-name" class="text-2xl font-bold text-gray-800 mt-4" contenteditable="true">小夜</h1>
                            <div class="flex items-center justify-center mt-1">
                                <p id="user-bio" class="text-gray-500" contenteditable="true">祝夜森活鱼块(・ω<)★</p>
                            </div>
                        </div>
                        <div class="w-full flex justify-between items-start mt-16 z-20">
                            <div class="w-40 h-40 bg-white/30 backdrop-blur-md rounded-3xl p-3 text-left flex flex-col justify-between shadow-md">
                                <p class="font-bold text-gray-800 editable text-sm" contenteditable="true">ପ૮【sweet cake】୨୧</p>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-2"><div class="widget-icon w-8 h-8 rounded-full overflow-hidden bg-gray-200"><img id="widget-icon-img-1" src="https://placehold.co/32x32/cccccc/999999?text=ICON" class="icon-image icon-base"></div><p class="text-xs text-gray-700 editable" contenteditable="true">✩°｡⋆星ボトル⋆｡°✩</p></div>
                                    <div class="flex items-center space-x-2"><div class="widget-icon w-8 h-8 rounded-full overflow-hidden bg-gray-200"><img id="widget-icon-img-2" src="https://placehold.co/32x32/cccccc/999999?text=ICON" class="icon-image icon-base"></div><p class="text-xs text-gray-700 editable" contenteditable="true">白ウサギ島</p></div>
                                </div>
                            </div>
                            <div class="w-1/2 grid grid-cols-2 gap-y-8 gap-x-6 pl-4 text-center">
                                <div id="settings-app-icon" class="app-icon flex flex-col items-center cursor-pointer"><div class="w-14 h-14 rounded-2xl shadow-md overflow-hidden"><img id="app-icon-img-1" src="https://placehold.co/56x56/f0f0f0/aaaaaa?text=App" class="icon-image icon-base"></div><span class="text-xs mt-2 text-gray-700 font-medium">设置</span></div>
                                <div id="wechat-app-icon" class="app-icon flex flex-col items-center cursor-pointer"><div class="w-14 h-14 rounded-2xl shadow-md overflow-hidden"><img id="app-icon-img-2" src="https://placehold.co/56x56/f0f0f0/aaaaaa?text=App" class="icon-image icon-base"></div><span class="text-xs mt-2 text-gray-700 font-medium">微信</span></div>
                                <div id="xiaohongshu-app-icon" class="app-icon flex flex-col items-center cursor-pointer"><div class="w-14 h-14 rounded-2xl shadow-md overflow-hidden"><img id="app-icon-img-3" src="https://placehold.co/56x56/f0f0f0/aaaaaa?text=App" class="icon-image icon-base"></div><span class="text-xs mt-2 text-gray-700 font-medium">浏览器</span></div>
                                <div id="worldbook-app-icon" class="app-icon flex flex-col items-center cursor-pointer"><div class="w-14 h-14 rounded-2xl shadow-md overflow-hidden"><img id="app-icon-img-4" src="https://placehold.co/56x56/f0f0f0/aaaaaa?text=App" class="icon-image icon-base"></div><span class="text-xs mt-2 text-gray-700 font-medium">世界书</span></div>
                            </div>
                        </div>
                        <div class="flex-grow"></div>
                        <div class="w-full bg-white/60 backdrop-blur-lg rounded-t-3xl py-3 px-10 shadow-lg z-20">
                            <div class="flex justify-between items-center">
                                <div id="music-app-icon" class="dock-icon flex flex-col items-center cursor-pointer"><div class="w-12 h-12 rounded-2xl overflow-hidden"><img id="dock-icon-img-1" src="https://placehold.co/48x48/fde68a/854d0e?text=🎵" class="icon-image icon-base"></div></div>
                                <div id="game-app-icon" class="dock-icon flex flex-col items-center cursor-pointer"><div class="w-12 h-12 rounded-2xl overflow-hidden"><img id="dock-icon-img-2" src="https://placehold.co/48x48/d8b4fe/581c87?text=🎮" class="icon-image icon-base"></div></div>
                                <div id="dock-placeholder-1" class="dock-icon flex flex-col items-center cursor-pointer"><div class="w-12 h-12 rounded-2xl overflow-hidden"><img id="dock-icon-img-3" src="https://placehold.co/48x48/f0f0f0/aaaaaa?text=⚙️" class="icon-image icon-base"></div></div>
                                <div id="dock-placeholder-2" class="dock-icon flex flex-col items-center cursor-pointer"><div class="w-12 h-12 rounded-2xl overflow-hidden"><img id="dock-icon-img-4" src="https://placehold.co/48x48/f0f0f0/aaaaaa?text=❓" class="icon-image icon-base"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="settings-container" class="screen main-screen hidden absolute inset-0 z-[60]">
                    <div id="settings-screen" class="screen active w-full h-full bg-gray-100 flex flex-col">
                        <div class="settings-header"><div class="w-16"></div><h2 class="font-bold text-xl text-center">设置</h2><button id="back-to-home-from-settings" class="text-blue-500 text-lg font-bold">完成</button></div>
                        <div class="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar">
                            <div class="bg-white rounded-lg shadow divide-y">
                                <div class="settings-menu-item p-4 flex justify-between items-center cursor-pointer" data-target="api-settings-screen"><span>API 设定 🔑</span><span>&gt;</span></div>
                                <div class="settings-menu-item p-4 flex justify-between items-center cursor-pointer" data-target="homescreen-settings-screen"><span>主屏幕自定义 🖼️</span><span>&gt;</span></div>
                                <div class="settings-menu-item p-4 flex justify-between items-center cursor-pointer" data-target="appearance-settings-screen"><span>外观美化 🎨</span><span>&gt;</span></div>
                                <div class="settings-menu-item p-4 flex justify-between items-center cursor-pointer" data-target="data-settings-screen"><span>数据管理 💾</span><span>&gt;</span></div>
                            </div>
                            <style>.settings-menu-item {transition: background-color 0.2s;} .settings-menu-item:hover { background-color: #f3f4f6; }</style>
                        </div>
                    </div>
                    
                    <div id="api-settings-screen" class="screen hidden w-full h-full bg-gray-100 flex flex-col">
                        <div class="settings-header"><button class="back-to-main-settings text-blue-500 text-lg">&lt; 设置</button><h2 class="font-bold text-xl">API 设定</h2><div class="w-16"></div></div>
                        <div class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                            <div class="bg-white rounded-lg shadow p-4 space-y-4">
                                <div><label class="text-sm font-medium text-gray-700">API (OpenAI 格式)</label><input type="text" id="api-base-url-input" class="w-full mt-1 p-2 border rounded-md" placeholder="https://api.your-proxy.com/v1"></div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">API Key (金钥)</label>
                                    <span id="api-status-indicator" class="ml-2 font-bold text-sm"></span>
                                    <input type="password" id="api-key-input" class="w-full mt-1 p-2 border rounded-md" placeholder="在此输入你的 API Key">
                                </div>
                                <div><label class="text-sm font-medium text-gray-700">API 模型名称</label><input type="text" id="api-model-name-input" class="w-full mt-1 p-2 border rounded-md" placeholder="例如: gemini-pro"><select id="model-selector-dropdown" class="w-full mt-2 p-2 border rounded-md hidden"></select></div>
                                <div class="flex space-x-2">
                                    <button id="fetch-models-btn" class="flex-1 mt-2 p-3 bg-gray-200 text-black rounded-lg font-bold hover:bg-gray-300">获取模型</button>
                                    <button id="test-api-btn" class="flex-1 mt-2 p-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600">测试连接</button>
                                </div>
                                <button id="save-api-settings-btn" class="w-full mt-2 p-3 bg-black text-white rounded-lg font-bold hover:bg-gray-800">储存全部设定</button>
                            </div>
                        </div>
                    </div>
                   <div id="homescreen-settings-screen" class="screen hidden w-full h-full bg-gray-100 flex flex-col">
                        <div class="settings-header"><button class="back-to-main-settings text-blue-500 text-lg">&lt; 设置</button><h2 class="font-bold text-xl">主屏幕自定义</h2><div class="w-16"></div></div>
                        <div class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                             <div class="bg-white rounded-lg shadow p-4"><div class="grid grid-cols-2 gap-2">
                                 <button class="settings-change-btn" data-input="wallpaper-input" data-target="phone-background">修改壁纸</button>
                                 <button class="settings-change-btn" data-input="avatar-input" data-target="avatar-img">修改头像</button>
                                 <button class="settings-change-btn" data-input="island-avatar-input" data-target="island-avatar-img">修改灵动岛图标</button>
                                 <button class="settings-change-btn" data-input="top-bg-input" data-target="top-bg-container">修改顶部背景</button>
                                 <button class="settings-change-btn" data-input="bottom-bg-input" data-target="bottom-bg-container">修改底部背景</button>
                                 <button class="settings-change-btn" data-input="widget-icon-input-1" data-target="widget-icon-img-1">修改小组件图标1</button>
                                 <button class="settings-change-btn" data-input="widget-icon-input-2" data-target="widget-icon-img-2">修改小组件图标2</button>
                                 <button class="settings-change-btn" data-input="app-icon-input-1" data-target="app-icon-img-1">修改App图标1</button>
                                 <button class="settings-change-btn" data-input="app-icon-input-2" data-target="app-icon-img-2">修改App图标2</button>
                                 <button class="settings-change-btn" data-input="app-icon-input-3" data-target="app-icon-img-3">修改App图标3</button>
                                 <button class="settings-change-btn" data-input="app-icon-input-4" data-target="app-icon-img-4">修改App图标4</button>
                                 <button class="settings-change-btn" data-input="dock-icon-input-1" data-target="dock-icon-img-1">修改Dock图标1</button>
                                 <button class="settings-change-btn" data-input="dock-icon-input-2" data-target="dock-icon-img-2">修改Dock图标2</button>
                                 <button class="settings-change-btn" data-input="dock-icon-input-3" data-target="dock-icon-img-3">修改Dock图标3</button>
                                 <button class="settings-change-btn" data-input="dock-icon-input-4" data-target="dock-icon-img-4">修改Dock图标4</button>
                             </div></div>
                             <button id="save-homescreen-settings-btn" class="w-full mt-4 p-3 bg-black text-white rounded-lg font-bold hover:bg-gray-800">保存主屏幕设置</button>
                             <style>.settings-change-btn { padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; text-align: center; font-size: 0.875rem; transition: background-color 0.2s; cursor: pointer; } .settings-change-btn:hover { background-color: #f3f4f6; }</style>
                        </div>
                    </div>
                    <div id="appearance-settings-screen" class="screen hidden w-full h-full bg-gray-100 flex flex-col">
                        <div class="settings-header"><button class="back-to-main-settings text-blue-500 text-lg">&lt; 设置</button><h2 class="font-bold text-xl">外观美化</h2><div class="w-16"></div></div>
                        <div class="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar">
                            <div class="bg-white rounded-lg shadow p-4 space-y-4">
                                <div class="flex justify-between items-center p-2 border-b">
                                    <span class="font-medium text-gray-700">夜间美化</span>
                                    <label for="night-mode-toggle" class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="night-mode-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label>
                                </div>
                                <div class="p-2 border-b space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-700">界面字体</span>
                                        <select id="font-selector" class="rounded-md border-gray-300 bg-white"><option value="'Inter', sans-serif">默认字体</option><option value="'Noto Serif SC', serif">思源宋体</option><option value="'ZCOOL KuaiLe', cursive">站酷快乐体</option></select>
                                    </div>
                                    <button id="import-font-btn" class="w-full p-2 text-sm bg-gray-100 rounded-md hover:bg-gray-200">从本地导入字体</button>
                                </div>
                                <div class="p-2 space-y-2">
                                    <span class="font-medium text-gray-700">聊天气泡主题</span>
                                    <div class="flex justify-around mt-1">
                                        <button class="chat-bubble-style-btn p-2 border-2 rounded-lg text-sm" data-style="default">默认</button>
                                        <button class="chat-bubble-style-btn p-2 border-2 rounded-lg text-sm" data-style="rounded">圆角</button>
                                        <button class="chat-bubble-style-btn p-2 border-2 rounded-lg text-sm" data-style="gradient">渐变</button>
                                    </div>
                                      <div class="mt-4 pt-4 border-t">
                                          <label for="custom-style-selector" class="text-sm font-medium text-gray-700">我的气泡主题库</label>
                                          <div class="flex space-x-2 mt-1">
                                              <select id="custom-style-selector" class="w-full p-2 border rounded-md"></select>
                                              <button id="delete-custom-style-btn" class="p-2 bg-red-500 text-white rounded-md hover:bg-red-600">删除</button>
                                          </div>
                                          <label for="custom-css-input" class="text-sm text-gray-600 mt-2 block">自定义气泡 CSS (例如: .chat-bubble-user { ... })</label>
                                          <textarea id="custom-css-input" rows="4" class="w-full p-2 mt-1 border rounded-md text-xs font-mono" placeholder="在此处编辑或粘贴新的 CSS 代码..."></textarea>
                                          <button id="save-custom-css-btn" class="w-full mt-1 p-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600">添加到主题库</button>
                                      </div>
                                </div>
                            </div>
                             <button id="save-appearance-settings-btn" class="w-full p-3 bg-black text-white rounded-lg font-bold hover:bg-gray-800">保存外观设置</button>
                        </div>
                    </div>
                        <div id="data-settings-screen" class="screen hidden w-full h-full bg-gray-100 flex flex-col">
                        <div class="settings-header"><button class="back-to-main-settings text-blue-500 text-lg">&lt; 设置</button><h2 class="font-bold text-xl">数据管理</h2><div class="w-16"></div></div>
                        <div class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                            <div class="bg-white rounded-lg shadow p-4">
                                <button id="export-data-btn" class="w-full mb-2 p-3 bg-purple-500 text-white rounded-lg font-bold hover:bg-purple-600 transition-colors">提取 (导出) 资料</button>
                                <button id="import-data-btn" class="w-full p-3 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition-colors">倒入资料</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="wechat-screen" class="screen main-screen hidden absolute inset-0 w-full h-full z-[70] flex flex-col" style="background-color: #fdf6f8;">
                    <button id="back-to-home-from-wechat">&lt;</button>
                    <div class="mobile-container" id="mobile-container">
                        <div id="alert-popup" class="alert-popup">操作成功!</div>
                        <div class="status-switcher-popup" id="status-switcher">
                            <ul><li>♡ 在线</li><li>◎ 离线</li><li>🎮 游玩</li><li>🎵 在听歌</li><li>😴 睡觉</li></ul>
                        </div>
                        <div class="modal-overlay" id="add-contact-modal">
                            <div class="modal-content">
                                <h3>填写备注名</h3>
                                <input type="text" id="add-contact-name" class="modal-input" placeholder="..."><div class="modal-selector">
                                    <label> <input type="radio" name="contact-type" value="contact" checked> <span class="custom-radio"></span> 联系人 </label>
                                    <label> <input type="radio" name="contact-type" value="group"> <span class="custom-radio"></span> 群聊 </label>
                                </div><div class="modal-actions">
                                    <button class="modal-btn modal-save-btn" id="modal-add-confirm">✓</button>
                                    <button class="modal-btn modal-cancel-btn" id="modal-add-cancel">✗</button>
                                </div>
                            </div>
                        </div>
                         <div class="modal-overlay" id="edit-profile-modal">
                            <div class="modal-content">
                                <h3>编辑主页</h3>
                                <label for="edit-profile-name-input">个人主页微信名:</label>
                                <input type="text" id="edit-profile-name-input" class="modal-input">
                                <label for="edit-profile-id-input">个人主页ID:</label>
                                <input type="text" id="edit-profile-id-input" class="modal-input">
                                <label for="edit-moments-name-input">朋友圈名字:</label>
                                <input type="text" id="edit-moments-name-input" class="modal-input">
                                <label for="wechat-profile-avatar-input" class="upload-label-btn">更换我的页面头像</label>
                                <label for="moments-avatar-input" class="upload-label-btn">更换朋友圈头像</label>
                                <label for="moments-cover-input" class="upload-label-btn">更换朋友圈背景</label>
                                <div class="modal-actions">
                                    <button class="modal-btn modal-save-btn" id="modal-edit-save">✓</button>
                                    <button class="modal-btn modal-cancel-btn" id="modal-edit-cancel">✗</button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-overlay" id="voice-message-modal">
                            <div class="modal-content">
                                <h3>发送语音消息</h3>
                                <input type="text" id="voice-message-text" class="modal-input" placeholder="输入要模拟的语音内容...">
                                <div class="modal-actions">
                                    <button class="modal-btn modal-save-btn" id="send-voice-confirm">✓</button>
                                    <button class="modal-btn modal-cancel-btn" id="cancel-voice-message">✗</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-overlay" id="moments-options-modal">
                            <div class="modal-content">
                                <h3>朋友圈设置</h3>
                                <div class="modal-actions" style="flex-direction: column; gap: 10px;">
                                    <button class="modal-btn" id="go-to-publish-btn" style="width: 100%; background-color: #d1fae5; color: #065f46;">发布朋友圈</button>
                                    <button class="modal-btn" id="go-to-view-btn" style="width: 100%; background-color: #e0e7ff; color: #3730a3;">查看朋友圈</button>
                                    <button class="modal-btn modal-cancel-btn" id="cancel-moments-options" style="width: 100%; margin-top: 10px;">取消</button>
                                </div>
                            </div>
                        </div>
                         <div class="modal-overlay" id="location-input-modal">
                            <div class="modal-content">
                                <h3>输入位置</h3>
                                <input type="text" id="custom-location-input" class="modal-input" placeholder="例如：月亮之上">
                                <div class="modal-actions">
                                    <button class="modal-btn modal-save-btn" id="confirm-location-btn">✓</button>
                                    <button class="modal-btn modal-cancel-btn" id="cancel-location-btn">✗</button>
                                </div>
                            </div>
                        </div>

                        <div class="modal-overlay" id="worldbook-linker-modal">
                            <div class="modal-content" style="width: 90%; max-width: 380px;">
                                <h3>关联世界书</h3>
                                <div id="modal-worldbook-list" class="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar my-4">
                                </div>
                                <div class="modal-actions">
                                    <button class="modal-btn modal-save-btn" id="apply-worldbook-link-btn">✓ 应用</button>
                                    <button class="modal-btn modal-cancel-btn" id="cancel-worldbook-link-btn">✗ 取消</button>
                                </div>
                            </div>
                        </div>
                        
                        <input type="file" id="avatar-input" style="display:none;" accept="image/*">
                        <input type="file" id="moments-avatar-input" style="display:none;" accept="image/*">
                        <input type="file" id="moments-cover-input" style="display:none;" accept="image/*">
                        <input type="file" id="wechat-profile-avatar-input" style="display:none;" accept="image/*">   
                        <input type="file" id="profile-bg-input" style="display:none;" accept="image/*">
                        <input type="file" id="avatar-frame-input" style="display:none;" accept="image/*">
                        <input type="file" id="statusbar-bg-input" style="display:none;" accept="image/*">
                        <input type="file" id="nav-icon-input" style="display:none;" accept="image/*">
                        <input type="file" id="nav-bg-input" style="display:none;" accept="image/*">
        
                        <div id="chat-list-page" class="page">
                             <div class="page-content-scrollable">
                                <div class="chat-page-header">
                                    <div class="search-container"><div class="search-bar">Q 搜索</div></div>
                                    <div class="chat-tabs">
                                        <div class="tab-item active">全部</div><div class="tab-item">恰恰喵</div><div class="tab-item">TωT</div>
                                    </div>
                                </div>
                                <div id="contacts-list" class="chat-section"></div>
                                <div id="groups-list" class="chat-section"></div>
                            </div>
                        </div>
        
                        <div id="profile-page" class="page">
                            <div class="page-content-scrollable" id="profile-page-content">
                                <div class="profile-main-card">
                                    <div class="profile-avatar-wrapper">
                                        <img src="https://i.pinimg.com/564x/a9/a7/63/a9a76313f8c29215886d2675d9c73e16.jpg" alt="Profile Avatar" class="profile-avatar" id="profile-avatar">
                                        <img src="https://files.catbox.moe/xbjlnm.png" alt="Avatar Frame" class="avatar-frame" id="avatar-frame">
                                    </div>
                                    <div class="profile-details">
                                        <div class="profile-name" id="profile-page-name">黄桃</div>
                                        <div class="profile-id" id="profile-page-id">微信号: 已注销</div>
                                        <div class="profile-status" id="profile-status-btn">
                                            <span>♡ 在线</span>
                                        </div>
                                    </div>
                                    <img src="https://i.imgs.ovh/2025/08/22/GzsQp.png" alt="decoration" class="decoration-icon">
                                </div>
                                <div class="profile-list-item" id="edit-profile-btn">
                                    <div class="profile-details">编辑主页</div><img src="https://i.imgs.ovh/2025/08/22/GzsQp.png" alt="decoration" class="decoration-icon">
                                </div>
                                <div class="profile-list-item">
                                    <div class="profile-details">日记 ( ´͈ ᵕ `͈ )◞♡</div><img src="https://i.imgs.ovh/2025/08/22/GzsQp.png" alt="decoration" class="decoration-icon">
                                </div>
                                <div class="profile-list-item">
                                    <div class="profile-details">购物 ⋆⁺₊⋆ ☾⋆⁺₊⋆</div><img src="https://i.imgs.ovh/2025/08/22/GzsQp.png" alt="decoration" class="decoration-icon">
                                </div>
                                <div class="profile-list-item" id="go-to-settings-btn">
                                    <div class="profile-details">ʚїɞ 进入主题设置</div><img src="https://i.imgs.ovh/2025/08/22/GzsQp.png" alt="decoration" class="decoration-icon">
                                </div>
                            </div>
                        </div>
                        
                        <div id="discover-page" class="page active">
                            <div class="page-content-scrollable" id="discover-page-content">
                                <div class="moments-settings-btn" id="moments-settings-btn">⚙️</div>
                                <button id="discover-back-btn" class="page-back-btn">&lt;</button>
                                <div class="moments-header">
                                    <img src="https://img.zcool.cn/community/01a4395a536ce3a8012163ba3758b9.jpg@1280w_1l_2o_100sh.jpg" class="cover-photo" id="moments-cover-photo" alt="Cover Photo">
                                    <div class="user-info">
                                        <span class="name" id="discover-page-name">小鱼.</span>
                                        <img src="https://i.pinimg.com/564x/1a/88/96/1a8896b39d73ad3c3e1c442a5c86292b.jpg" alt="User Avatar" class="avatar" id="discover-page-avatar">
                                    </div>
                                </div>
                                <div class="moments-feed" id="moments-feed"></div>
                                <div class="moment-action-popup" id="moment-action-popup">
                                    <button class="like-btn">♡ 赞</button>
                                    <button class="comment-btn">💬 评论</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="contacts-page" class="page">
                            <div class="page-content-scrollable">
                                <div class="contacts-header">
    <input type="search" id="contact-search-input" placeholder="搜索">
    <button id="sort-contacts-btn">···</button>
    <!-- 新增的删除按钮 -->
    <button id="delete-contacts-btn" class="hidden" style="color: white; background-color: #ef4444; padding: 5px 10px; border-radius: 8px; font-size: 14px;">删除</button>
    <button id="cancel-delete-btn" class="hidden" style="font-size: 14px;">取消</button>
    <!-- 新增结束 -->
    <div id="sort-options-popup">
        <button data-sort="pinyin">按字母排序</button>
        <button data-sort="newest">按最新添加</button>
        <button data-sort="oldest">按最早添加</button>
    </div>
</div>
                                <div class="contact-list" id="contact-list-container"></div>
                            </div>
                        </div>
        
                        <div id="settings-page" class="page">
                             <div class="page-content-scrollable">
                                <div class="page-content-padded">
                                    <div class="settings-section">
                                        <div class="settings-header">♡ 顶部设置</div>
                                        <div class="settings-item"> <span>状态栏壁纸</span> <label class="upload-label" for="statusbar-bg-input">选择图片</label> </div>
                                         <div class="settings-item">
                                            <span>灵动岛背景</span>
                                            <div class="input-group">
                                                <input type="text" class="color-input" id="island-color-input" placeholder="输入CSS颜色代码...">
                                                <button id="apply-island-color-btn" class="apply-btn">应用</button>
                                            </div>
                                         </div>
                                    </div>
                                    <div class="settings-section">
                                        <div class="settings-header">♡ 头像框设置</div>
                                        <div class="settings-item">
                                            <span>本地上传</span><label class="upload-label" for="avatar-frame-input">选择图片</label>
                                        </div>
                                        <div class="settings-item">
                                            <span>URL (链接)</span>
                                            <div class="input-group">
                                                <input type="text" class="color-input" id="avatar-frame-url" placeholder="粘贴图片URL...">
                                                <button id="apply-avatar-frame-url-btn" class="apply-btn">应用</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="settings-section">
                                        <div class="settings-header">♡ 页面设置</div>
                                        <div class="settings-item">
                                            <span>页面背景颜色</span>
                                            <div class="input-group">
                                                <input type="text" class="color-input" id="bg-color-input" placeholder="#fdeaf2">
                                                <button id="apply-bg-color-btn" class="apply-btn">应用</button>
                                            </div>
                                        </div>
                                        <div class="settings-item">
                                            <span>我的页面背景</span>
                                            <label class="upload-label" for="profile-bg-input">本地上传</label>
                                        </div>
                                    </div>
                                    <div class="settings-section">
                                        <div class="settings-header">♡ 底部设置</div>
                                        <div class="settings-item"> <span>导航栏图标 (本地)</span> <label class="upload-label" for="nav-icon-input">统一替换</label> </div>
                                        <div class="settings-item">
                                            <span>导航栏图标 (URL)</span>
                                            <div class="input-group">
                                                <input type="text" class="color-input" id="nav-icon-url" placeholder="粘贴图片URL..."><button id="apply-url-btn" class="apply-btn">应用</button>
                                            </div>
                                        </div>
                                         <div class="settings-item"> <span>导航栏背景</span> <label class="upload-label" for="nav-bg-input">选择图片</label> </div>
                                    </div>
                                     <button id="back-to-profile" class="profile-list-item">返回个人主页</button>
                                </div>
                             </div>
                        </div>
                        
                        <div id="ai-chat-page" class="page">
                            <div class="chat-header">
                                <div class="chat-page-statusbar">
                                    <span class="chat-time-local"></span>
                                    <span class="chat-icons-local"></span>
                                </div>
                                <div class="chat-header-controls">
                                    <button id="ai-chat-back-btn" class="back-to-list-btn">&lt;</button>
                                    <div class="chat-title">
                                        <span id="chat-contact-name">Contact Name</span>
                                        <small id="chat-contact-status"><span class="status-dot online"></span>online</small>
                                    </div>
                                    <img src="https://i.imgs.ovh/2025/08/23/GdaHF.png" class="chat-settings-icon" alt="settings">
                                </div>
                            </div>
                            <div class="chat-messages" id="chat-messages-container">
                                </div>
                            <div class="emoji-picker" id="emoji-picker">
                                 <button id="add-local-emoji-btn">从本地添加</button>
                            </div>
                            <div class="action-panel" id="action-panel">
                                <div class="action-item" data-action="send-image"><span>📷</span><small>图片</small></div>
                                <div class="action-item" data-action="send-location"><span>📍</span><small>位置</small></div>
                                <div class="action-item" data-action="send-transfer"><span>💰</span><small>转账</small></div>
                                <div class="action-item" data-action="send-voice-msg"><span>🗣️</span><small>语音消息</small></div>
                                <div class="action-item" data-action="video-call"><span>📹</span><small>视频通话</small></div>
                                <div class="action-item" data-action="voice-call"><span>📞</span><small>语音通话</small></div>
                            </div>
                            <div class="chat-input-area">
                                <button id="toggle-actions-btn" class="input-icon-btn">
                                     <img src="https://i.imgs.ovh/2025/08/23/GRscO.png" alt="actions">
                                </button>
                                <input type="text" id="chat-message-input" placeholder="输入消息...">
                                <span id="toggle-emoji-btn" class="input-icon">😊</span>
                                <button id="send-message-btn" class="input-icon-btn">
                                     <img src="https://i.imgs.ovh/2025/08/23/GEobY.png" alt="send">
                                </button>
                            </div>
                        </div>

                        <div id="chat-settings-page" class="page">
                            <div class="page-content-scrollable" style="padding-top: 0; padding-bottom: 70px;">
                                <div class="publish-page-header" style="position:relative; border-bottom: 1px solid #f0f0f0;">
                                     <button id="back-to-chat-btn" class="publish-back-btn">&lt;</button>
                                     <span class="font-bold">聊天设置</span>
                                     <div style="width: 50px;"></div>
                                </div>
                                <div class="page-content-padded" style="padding: 15px;">
                                    <div class="settings-section">
                                        <div class="settings-header">♡ 对方 (AI) 设置</div>
                                        <div class="settings-item">
                                            <span>AI 头像</span>
                                            <label class="upload-label" for="chat-ai-avatar-input">选择图片</label>
                                        </div>
                                        <div class="settings-item">
                                            <span>AI 头像框 (URL)</span>
                                            <div class="input-group" style="width: 50%;"><input type="text" class="color-input" id="chat-ai-frame-url" placeholder="粘贴图片URL..."></div>
                                        </div>
                                        <div class="settings-item">
                                            <span>AI 头像框 (本地)</span>
                                             <label class="upload-label" for="chat-ai-frame-input">选择图片</label>
                                        </div>
                                        <div style="padding: 10px 0;">
                                            <label for="chat-ai-persona-input" class="text-sm font-medium" style="color: #333;">AI 预设信息 (Persona)</label>
                                            <textarea id="chat-ai-persona-input" rows="4" class="w-full p-2 mt-1 border rounded-md" placeholder="输入 AI 的角色设定..." style="color: #000;"></textarea>
                                        </div>
                                    </div>
                        
                                    <div class="settings-section">
                                        <div class="settings-header">♡ 我 (USER) 设置</div>
                                        <div class="settings-item">
                                            <span>我的头像</span>
                                            <label class="upload-label" for="chat-user-avatar-input">选择图片</label>
                                        </div>
                                         <div class="settings-item">
                                            <span>我的信息</span>
                                            <input type="text" class="color-input" id="chat-user-name-input" placeholder="输入你的名字..." style="flex-grow: 1;">
                                        </div>
                                         <div style="padding: 10px 0;">
                                            <label for="chat-user-persona-input" class="text-sm font-medium" style="color: #333;">我的预设信息 (Persona)</label>
                                            <textarea id="chat-user-persona-input" rows="3" class="w-full p-2 mt-1 border rounded-md" placeholder="输入你在此次对话中的角色设定..." style="color: #000;"></textarea>
                                        </div>
                                         <div class="settings-item">
                                         <span>我的头像框 (URL)</span>
                                            <div class="input-group" style="width: 50%;"><input type="text" class="color-input" id="chat-user-frame-url" placeholder="粘贴图片URL..."></div>
                                        </div>
                                         <div class="settings-item">
                                            <span>我的头像框 (本地)</span>
                                             <label class="upload-label" for="chat-user-frame-input">选择图片</label>
                                        </div>
                                    </div>

                                    <div class="settings-section">
                                        <div class="settings-header">📚 关联世界书</div>
                                        <div class="settings-item">
                                             <button id="open-worldbook-linker-btn" class="apply-btn" style="width:100%;">选择关联世界书</button>
                                        </div>
                                    </div>

                                    <div class="settings-section">
                                        <div class="settings-header">⚙️ 功能设置</div>
                                        <div class="settings-item">
                                            <span>开启感知时间</span>
                                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="setting-time-perception" class="sr-only peer"><div class="toggle-switch bg-gray-200 rounded-full peer peer-checked:bg-pink-400 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full toggle-switch-dot after:transition-all"></div></label>
                                        </div>
                                        <div class="settings-item">
                                            <span>开启线下模式 (剧情)</span>
                                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="setting-offline-mode" class="sr-only peer"><div class="toggle-switch bg-gray-200 rounded-full peer peer-checked:bg-pink-400 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full toggle-switch-dot after:transition-all"></div></label>
                                        </div>
                                        <div class="settings-item">
                                            <span>记忆轮数</span>
                                            <input type="number" id="setting-memory-rounds" class="color-input w-20 text-center" value="5" min="0" max="20">
                                        </div>
                                        <div class="settings-item">
                                            <span>开启主动搭话</span>
                                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="setting-proactive-chat" class="sr-only peer"><div class="toggle-switch bg-gray-200 rounded-full peer peer-checked:bg-pink-400 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full toggle-switch-dot after:transition-all"></div></label>
                                        </div>
                                        <div class="settings-item">
                                            <span>搭话频率</span>
                                            <select id="setting-proactive-frequency" class="color-input">
                                                <option value="high">高频率</option>
                                                <option value="medium" selected>中频率</option>
                                                <option value="low">低频率</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="settings-section">
                                        <div class="settings-header">🎨 外观设置</div>
                                        <div class="settings-item">
                                            <span>聊天背景壁纸</span>
                                            <label class="upload-label" for="chat-wallpaper-input">选择图片</label>
                                        </div>
                                        <div class="settings-item">
                                            <span>顶部状态栏颜色</span>
                                            <input type="text" id="setting-top-bar-color" class="color-input w-32" placeholder="#fdeaf2">
                                        </div>
                                        <div class="settings-item">
                                            <span>底部导航栏颜色</span>
                                            <input type="text" id="setting-bottom-bar-color" class="color-input w-32" placeholder="#fdeaf2">
                                        </div>
                                    </div>
                                    
                                     <div class="settings-section">
                                        <div class="settings-header">🗑️ 数据管理</div>
                                        <div class="settings-item">
                                             <button id="delete-chat-history-btn" class="apply-btn" style="width:100%; background-color: #fecaca; color: #dc2626;">删除所有聊天记录</button>
                                        </div>
                                    </div>

                                    <button id="save-all-chat-settings-btn" class="w-full p-3 mt-4 bg-pink-500 text-white rounded-lg font-bold hover:bg-pink-600 transition-colors">保存全部设置</button>

                                </div>
                            </div>
                        </div>
                        
                        <div id="publish-moment-page" class="page">
                            <div class="publish-page-header">
                                <button class="publish-back-btn">&lt;</button>
                                <span>发表文字</span>
                                <button class="publish-submit-btn" id="publish-submit-btn" disabled>发表</button>
                            </div>
                            <div class="publish-page-content">
                                <textarea id="moment-text-input" placeholder="这一刻的想法..."></textarea>
                                <div class="publish-options">
                                    <div class="publish-option-item" id="publish-location-btn">
                                        <span>📍</span>
                                        <span id="location-display-text">所在位置</span>
                                    </div>
                                    <div class="publish-option-item" id="publish-mention-btn">
                                        <span>@</span> 提醒谁看
                                    </div>
                                </div>
                            </div>
                        </div>
        
                        <div id="view-moments-page" class="page">
                            <div class="publish-page-header">
                                 <button class="view-moments-back-btn">&lt;</button>
                                 <span>选择可见联系人</span>
                            </div>
                            <div class="page-content-scrollable" style="padding-top: 60px; padding-bottom: 80px;">
                                <div id="view-moments-contact-list"></div>
                            </div>
                            <div class="view-moments-footer">
                                <button class="footer-btn confirm-btn" id="view-moments-confirm">✓</button>
                                <button class="footer-btn cancel-btn" id="view-moments-cancel">✗</button>
                            </div>
                        </div>
        
        
                        <div class="status-bar" id="status-bar"></div>
                        <div class="status-bar-overlay">
                            <div class="status-bar-time"></div><div class="status-bar-icons"></div>
                        </div>
                        <div class="dynamic-island-container">
                            <div class="dynamic-island" id="dynamic-island">*..+~ 少女の祈り ~+..*</div>
                        </div>
                        <div class="add-heart-btn" id="add-heart-btn">♥</div>
                        <nav class="bottom-nav" id="bottom-nav"></nav>
                    </div>
                </div>
                
                <div id="browser-screen" class="screen main-screen hidden absolute inset-0 w-full h-full z-[80] flex flex-col bg-white">
                    <div class="browser-main" style="width: 100%; height: 100%; overflow: hidden; position: relative; top: 0; left: 0; background-size: cover; background-position: center; z-index: 1;">
                        <div style="height: 65px; background:#EBECF0; display: flex; align-items: flex-end; padding: 0 10px 10px; position: relative; z-index:2;">
                            <div id="browser-back-to-home-btn" style="position: absolute; left: 12px; bottom: 12.5px; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2.5">
                                    <path d="M15 18l-6-6 6-6" />
                                </svg>
                            </div>
                            <input type="text" id="urlInput" style="width: 100%; height: 25px; border-radius: 12px; border: 1px solid #ddd; padding: 0 60px 0 35px; font-size: 12px;" placeholder="输入网址 (如：baidu.com）">
                            <div id="fullscreenButton" style="position: absolute; right: 40px; bottom: 12.5px; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                                </svg>
                            </div>
                            <div id="goButton" style="position: absolute; right: 15px; bottom: 12.5px; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7" />
                                </svg>
                            </div>
                            <div id="loadingSpinner" style="display:none; position: absolute; right: 16px; bottom: 15px; width: 12px; height: 12px; border: 1.5px solid #ddd; border-top: 1.5px solid #666; border-radius: 50%; animation: browserSpin 1s linear infinite;"></div>
                        </div>

                        <div id="progressBar" style="position: absolute; top: 65px; left: 0; width: 0%; height: 2px; background: #6645d1; display: none; z-index: 2;"></div>

                        <iframe id="browserFrame" style="width: 100%; height: calc(100% - 65px); border: none; margin-top: 0; background: url('https://files.catbox.moe/sqppbd.jpeg') center/cover no-repeat; transform-origin: center center; transition: transform 0.3s ease;" src="" sandbox="allow-same-origin allow-scripts allow-forms allow-popups" allow="storage-access 'self'; fullscreen" referrerpolicy="no-referrer-when-downgrade"></iframe>

                        <div id="loadingOverlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); justify-content: center; align-items: center; z-index:1;">
                            <div style="width: 24px; height: 24px; border: 2px solid #666; border-top-color: transparent; border-radius: 50%; animation: browserSpin 0.8s linear infinite;"></div>
                        </div>
                    </div>
                    
                    <div id="bottomSlider" style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 115px; height: 30px; background: transparent; z-index:5;"></div>
                    <div id="leftSlider" style="position: absolute; left: 0; top: 33.33%; bottom: 0; width: 30px; background: transparent; z-index:5;"></div>
                    <div id="rightSlider" style="position: absolute; right: 0; top: 33.33%; bottom: 0; width: 30px; background: transparent; z-index:5;"></div>

                    <div id="backFeedback" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); flex-direction: column; align-items: center; z-index: 9999; pointer-events: none; background: rgba(0,0,0,0.8); padding: 16px 24px; border-radius: 20px; color: white;">
                        <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                                <path d="M15 18l-6-6 6-6" />
                            </svg>
                        </div>
                        <div style="font-size: 13px; margin-top: 8px;">回退</div>
                    </div>
                    <div id="homeBackFeedback" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; pointer-events: none; background: rgba(0,0,0,0.8); padding: 16px 24px; border-radius: 20px; color: white; font-size: 13px;">
                        返回主页
                    </div>
                </div>
                <div id="worldbook-screen" class="screen main-screen hidden absolute inset-0 w-full h-full z-[90] flex flex-col bg-gray-50">
                    <div id="worldbook-list-page" class="w-full h-full flex flex-col">
                        <div class="settings-header">
                            <button id="back-to-home-from-worldbook" class="text-blue-500 text-lg font-bold w-16 text-left">&lt; 返回</button>
                            <h2 class="font-bold text-xl text-center flex-grow">世界书</h2>
                            <div class="w-16 text-right space-x-2">
                                <button id="add-entry-btn" class="text-blue-500 text-2xl font-bold">+</button>
                                <button id="delete-entries-btn" class="text-red-500 text-lg font-bold hidden">删除</button>
                            </div>
                        </div>
                        <div id="worldbook-entry-list" class="flex-grow p-4 overflow-y-auto custom-scrollbar space-y-3">
                            </div>
                    </div>

                    <div id="worldbook-edit-page" class="w-full h-full flex-col bg-gray-50 hidden">
                        <div class="settings-header">
                            <button id="back-to-list-from-edit" class="text-blue-500 text-lg font-bold w-16 text-left">&lt; 返回</button>
                            <h2 class="font-bold text-xl text-center flex-grow" id="worldbook-edit-title">新的篇章</h2>
                            <div class="w-16 text-right">
                                <button id="save-entry-btn" class="text-blue-500 text-lg font-bold">保存</button>
                            </div>
                        </div>
                        <div class="p-4 flex flex-col flex-grow">
                            <input type="text" id="worldbook-entry-name" class="w-full p-3 border rounded-md text-lg font-bold mb-4" placeholder="为这个世界命名...">
                            <textarea id="worldbook-entry-content" class="w-full flex-grow p-3 border rounded-md resize-none" placeholder="在这里书写它的故事..."></textarea>
                        </div>
                    </div>
                </div>
                                <div id="music-screen" class="screen main-screen hidden absolute inset-0 w-full h-full z-[80] flex flex-col">
                    <input type="file" id="music-wallpaper-input" accept="image/*" style="display: none;">
                    <input type="file" id="avatar-my-input" accept="image/*" style="display: none;">
                    <input type="file" id="avatar-guest-input" accept="image/*" style="display: none;">
                    <input type="file" id="music-file-input" accept="audio/*, .flac, .m4a" style="display: none;">
                    <input type="file" id="album-art-input" accept="image/*" style="display: none;">
                    <input type="file" id="add-ai-avatar-input" accept="image/*" style="display:none;">
                    <audio id="audio-player"></audio>
                    
                    <div class="music-player" id="music-player">
                        <div class="player-background-overlay" id="player-background-overlay"></div>
                        <div id="weather-effect-container"></div>
                        <div class="player-content">
                            <div class="player-header">
                                <div class="header-actions left">
                                    <button class="header-btn" id="invite-btn" title="邀请一起听">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7.5" r="4.5"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
                                    </button>
                                </div>
                                <div class="song-info"> <h2 id="song-title">歌曲名称</h2> <p id="song-artist">歌手</p> </div>
                                <div class="header-actions right">
                                    <button class="header-btn" id="change-wallpaper-btn" title="更换播放器壁纸">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                    </button>
                                    <button class="header-btn" id="settings-btn" title="设置">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="settings-panel" id="settings-panel">
                                <div class="setting-group">
                                    <label for="blur-slider">模糊度</label>
                                    <input type="range" id="blur-slider" min="0" max="30" step="1">
                                </div>
                                <div class="setting-group weather-options">
                                    <label>天气:</label>
                                    <input type="radio" name="weather-effect" value="none" id="weather-none" checked> <label for="weather-none">无</label>
                                    <input type="radio" name="weather-effect" value="rain" id="weather-rain"> <label for="weather-rain">雨</label>
                                    <input type="radio" name="weather-effect" value="snow" id="weather-snow"> <label for="weather-snow">雪</label>
                                </div>
                            </div>
                            <div class="main-content-area"> <div class="listener-avatars"> <img src="" alt="My Avatar" class="avatar" id="my-avatar"> <img src="https://i.pravatar.cc/130?u=ai-yuxi" alt="Guest Avatar" class="avatar" id="guest-avatar"> <div class="listen-together-controls"> <button id="chat-toggle-btn" title="打开/关闭聊天"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></button> <button id="exit-listen-together-btn" title="退出一起听"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button> </div> </div> <div class="listen-together-info" id="listen-together-info"></div> <div class="vinyl" id="vinyl"> <img src="https://picsum.photos/id/101/250/250" alt="Album Art" id="album-art" title="点击更换音乐图标"> </div> </div> <div class="controls-wrapper"> <div class="time-controls"> <span class="time-display" id="current-time">0:00</span> <span class="time-display" id="duration">0:00</span> </div> <div id="progress-wrapper"> <div id="progress-fill"></div> <input type="range" id="progress-bar" value="0" step="1" min="0"> </div> <div class="controls" style="margin-top: 10px;"> <button class="control-btn" id="mode-btn" title="列表循环"></button> <button class="control-btn" id="prev-btn" title="上一首"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg></button> <button class="control-btn" id="play-pause-btn" title="播放"></button> <button class="control-btn" id="next-btn" title="下一首"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg></button> <button class="control-btn" id="playlist-btn" title="播放列表"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></button> </div> </div> <div class="chat-dialog" id="chat-dialog"> <div class="chat-header"> <h3 id="chat-header-title">一起听 G-PT</h3> <button id="close-chat-btn">&times;</button> </div> <div id="chat-messages"></div> <form class="chat-input-area" id="chat-form"> <input type="text" id="chat-input" placeholder="说点什么..." autocomplete="off"> <button type="submit" id="send-btn" title="发送"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> </button> </form> </div>
                        </div>
                        <div class="playlist-sidebar" id="playlist-sidebar"> <div class="playlist-header"> <button id="playlist-back-btn" title="返回听歌界面"> <svg width="24" height="24" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="#333"/></svg> </button> <div class="playlist-header-title">当前播放</div> </div> <ul id="playlist-list"></ul> <div class="import-section"> <button class="import-btn" id="import-local-btn">本地音乐</button> <button class="import-btn" id="import-url-btn">网络 URL</button> <button class="import-btn" id="import-qq-btn">QQ 音乐歌单</button> <button class="import-btn" id="import-netease-btn">网易云歌单</button> </div> </div>
                    </div>
                    <div class="modal" id="character-select-modal"> <div class="modal-dialog"> <h3>请选择一位好友一起听</h3> <p>勾选你的听歌伴侣</p> <ul class="character-list" id="character-list"></ul> <div class="modal-actions"> <button id="add-ai-btn">添加新人设</button> <button class="modal-confirm-btn" id="character-modal-confirm" disabled>邀请一起听</button> </div> </div> </div> <div class="modal" id="add-ai-modal"> <div class="modal-dialog"> <h3>创建新的人设</h3> <img src="https://i.pravatar.cc/130?u=new-ai-placeholder" id="add-ai-avatar-preview" title="点击上传头像"> <form id="add-ai-form"> <div class="form-group"><label for="ai-name-input">名字</label><input type="text" id="ai-name-input" required></div> <div class="form-group"><label for="ai-persona-input">人设 (一句话描述)</label><textarea id="ai-persona-input" required></textarea></div> <div class="modal-actions"> <button type="button" id="add-ai-cancel-btn">取消</button> <button type="submit" class="modal-confirm-btn">保存</button> </div> </form> </div> </div> <div class="modal" id="playlist-import-modal"> <div class="modal-dialog"> <h3 id="playlist-modal-title">导入歌单</h3> <p>请输入歌单分享链接或ID</p> <input type="text" id="playlist-url-input" placeholder="例如: https://y.qq.com/n/ryqq/playlist/..."> <div class="modal-actions"> <button id="playlist-modal-cancel">取消</button> <button class="modal-confirm-btn" id="playlist-modal-confirm">导入</button> </div> </div> </div>

                    <script>
                    (()=>{
                        if (document.getElementById('music-player').dataset.initialized) return;
                        document.getElementById('music-player').dataset.initialized = 'true';
                        
                        const getEl = (id) => document.getElementById(id);
                        const musicPlayer=getEl("music-player"),audioPlayer=getEl("audio-player"),playPauseBtn=getEl("play-pause-btn"),prevBtn=getEl("prev-btn"),nextBtn=getEl("next-btn"),modeBtn=getEl("mode-btn"),vinyl=getEl("vinyl"),albumArtEl=getEl("album-art"),songTitleEl=getEl("song-title"),songArtistEl=getEl("song-artist"),progressBar=getEl("progress-bar"),myAvatar=getEl("my-avatar"),guestAvatar=getEl("guest-avatar"),characterSelectModal=getEl("character-select-modal"),characterList=getEl("character-list"),characterModalConfirmBtn=getEl("character-modal-confirm"),playlistBtn=getEl("playlist-btn"),playlistSidebar=getEl("playlist-sidebar"),playlistList=getEl("playlist-list");
                        const progressFill = getEl('progress-fill');
                        const playlistBackBtn = getEl('playlist-back-btn');
                        const addAiBtn = getEl('add-ai-btn'), addAiModal = getEl('add-ai-modal'), addAiForm = getEl('add-ai-form');
                        const addAiAvatarPreview = getEl('add-ai-avatar-preview'), addAiAvatarInput = getEl('add-ai-avatar-input');
                        const exitListenTogetherBtn = getEl('exit-listen-together-btn');
                        const chatDialog = getEl('chat-dialog'), chatToggleBtn = getEl('chat-toggle-btn'), chatHeaderTitle = getEl('chat-header-title');
                        const musicFileInput = getEl('music-file-input'), musicWallpaperInput = getEl('music-wallpaper-input'); // ID 已修改
                        const changeWallpaperBtn = getEl('change-wallpaper-btn');
                        const importLocalBtn = getEl('import-local-btn');
                        const settingsBtn = getEl('settings-btn'), settingsPanel = getEl('settings-panel'), blurSlider = getEl('blur-slider');
                        const weatherEffectContainer = getEl('weather-effect-container');
                        const weatherOptions = document.querySelectorAll('input[name="weather-effect"]');
                        const listenTogetherInfo = getEl('listen-together-info');
                        
                        const icons={play:`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="#333"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`,pause:`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="#333"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`,repeat:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>',repeatOne:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M17 2l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 22l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path><path d="M11 10h1v4"></path></svg>',shuffle:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="16 17 21 17 21 22"></polyline><line x1="4" y1="4" x2="15" y2="15"></line></svg>'};
                        let isPlaying = false, currentSongIndex = -1, currentModeIndex = 0;
                        const playbackModes = ['repeat', 'repeat-one', 'shuffle'];
                        let selectedCharacter = null, aiCharacters = [], playlist = [], activePlayer = null, newAiAvatarData = null;
                        let listenTogetherInterval = null, listenTogetherStartTime = null, randomDistance = 0;

                        const loadAIsFromStorage=()=>{const e=localStorage.getItem("aiCharacters");aiCharacters=e?JSON.parse(e):[]};const saveAIsToStorage=()=>localStorage.setItem("aiCharacters",JSON.stringify(aiCharacters));const savePlaylistToStorage = () => {
    // 在保存前，创建一个不包含庞大 file 对象的新数组
    const playlistMetadata = playlist.map(({ file, ...meta }) => meta);
    localStorage.setItem("musicPlaylist", JSON.stringify(playlistMetadata));
};
                        const createAuroraPlayer = (file) => new Promise((resolve,reject)=>{const reader=new FileReader;reader.onload=e=>{try{const asset=AV.Asset.fromBuffer(e.target.result);const auroraPlayer=new AV.Player(asset);resolve(auroraPlayer)}catch(err){console.error("Aurora Asset/Player 创建失败:",err),reject(err)}};reader.onerror=err=>{console.error("FileReader 读取文件失败:",err),reject(err)};reader.readAsArrayBuffer(file)});
                        const stopCurrentPlayer = () => { if (activePlayer) { if(activePlayer.stop) activePlayer.stop(); else {activePlayer.pause(); activePlayer.src = "";} activePlayer.off ? activePlayer.off() : null; activePlayer = null; } };
                        const loadSong = async (index) => {
                            if (index < 0 || index >= playlist.length) { stopCurrentPlayer(); songTitleEl.textContent = '播放列表为空'; songArtistEl.textContent = '请添加音乐'; isPlaying=false; vinyl.classList.remove('playing'); playPauseBtn.innerHTML = icons.play; return; }
                            stopCurrentPlayer();
                            currentSongIndex = index;
                            const song = playlist[index];
                            songTitleEl.textContent = song.title; songArtistEl.textContent = song.artist; albumArtEl.src = song.cover;
                            updatePlaylistUI();
                            getEl('current-time').textContent = '0:00'; getEl('duration').textContent = '0:00'; progressBar.value = 0; progressBar.max = 1; progressFill.style.width = '0%';
                            if (song.useNative) {
                                activePlayer = audioPlayer; activePlayer.src = song.src;
                            } else {
                                try {
                                    songTitleEl.textContent = `解码中: ${song.title}`; activePlayer = await createAuroraPlayer(song.file); songTitleEl.textContent = song.title;
                                    activePlayer.on('duration', (ms) => { progressBar.max = ms / 1000; getEl('duration').textContent = formatTime(ms / 1000); });
                                    activePlayer.on('progress', (ms) => { progressBar.value = ms / 1000; getEl('current-time').textContent = formatTime(ms / 1000); progressFill.style.width = `${(ms / activePlayer.duration) * 100}%`; });
                                    activePlayer.on('end', handleSongEnd);
                                } catch (error) { console.error("Aurora.js 解码失败:", error); alert(`无法播放文件 "${song.title}"`); songTitleEl.textContent = song.title; }
                            }
                        };

                        const playSong = () => { if (!activePlayer) return; isPlaying = true; vinyl.classList.add('playing'); playPauseBtn.innerHTML = icons.pause; activePlayer.play().catch(e => console.error("播放失败:", e)); };
                        const pauseSong = () => { if (!activePlayer) return; isPlaying = false; vinyl.classList.remove('playing'); playPauseBtn.innerHTML = icons.play; activePlayer.pause(); };
                        
                        audioPlayer.addEventListener('timeupdate', () => { if (activePlayer !== audioPlayer) return; const currentTime = audioPlayer.currentTime; const duration = audioPlayer.duration; progressBar.value = currentTime; getEl('current-time').textContent = formatTime(currentTime); progressFill.style.width = duration ? `${(currentTime / duration) * 100}%` : '0%'; });
                        audioPlayer.addEventListener('loadedmetadata', () => { if(activePlayer === audioPlayer) {progressBar.max = audioPlayer.duration; getEl('duration').textContent = formatTime(audioPlayer.duration);} });
                        audioPlayer.addEventListener('ended', () => { if(activePlayer === audioPlayer) handleSongEnd(); });
                        progressBar.addEventListener('input', () => { if (activePlayer) { const seekTime = parseFloat(progressBar.value); if (activePlayer.seek) { activePlayer.seek(seekTime * 1000); } else { activePlayer.currentTime = seekTime; } } });
                        const handleSongEnd = () => { const mode=playbackModes[currentModeIndex];if(mode==="repeat-one"){activePlayer.seek?activePlayer.seek(0):activePlayer.currentTime=0;playSong()}else if(mode==="shuffle"){let newIndex;do{newIndex=Math.floor(Math.random()*playlist.length)}while(newIndex===currentSongIndex&&playlist.length>1);loadSong(newIndex).then(playSong)}else{nextBtn.click()} };
                        const updateMode = () => { const mode=playbackModes[currentModeIndex];modeBtn.innerHTML=icons[mode];modeBtn.title={repeat:"列表循环","repeat-one":"单曲循环",shuffle:"随机播放"}[mode] };
                        const buildPlaylist = () => {
                            playlistList.innerHTML = '';
                            playlist.forEach((song, index) => {
                                const item = document.createElement('li'); item.className = 'playlist-item'; item.dataset.index = index;
                                item.innerHTML = `<div class="playlist-item-info"> <div class="playlist-item-title">${song.title}</div> <div class="playlist-item-artist">${song.artist}</div> </div> <button class="remove-song-btn" title="从列表删除"> <svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#777"/></svg> </button>`;
                                item.querySelector('.playlist-item-info').addEventListener('click', () => { loadSong(index).then(playSong); playlistSidebar.classList.remove('visible'); });
                                item.querySelector('.remove-song-btn').addEventListener('click', (e) => { e.stopPropagation(); removeSongFromPlaylist(index); });
                                playlistList.appendChild(item);
                            });
                            updatePlaylistUI();
                        };
                        const removeSongFromPlaylist = (indexToRemove) => {
                            const isCurrentlyPlaying = indexToRemove === currentSongIndex;
                            playlist.splice(indexToRemove, 1);
                            savePlaylistToStorage();
                            if (isCurrentlyPlaying) {
                                stopCurrentPlayer();
                                const nextIndex = (playlist.length > 0) ? (indexToRemove >= playlist.length ? 0 : indexToRemove) : -1;
                                loadSong(nextIndex).then(()=>{if(playlist.length>0 && isPlaying) playSong()});
                            } else {
                                if (indexToRemove < currentSongIndex) currentSongIndex--;
                            }
                            buildPlaylist();
                        };
                        const updatePlaylistUI = () => { document.querySelectorAll(".playlist-item").forEach(item=>{item.classList.toggle("active",parseInt(item.dataset.index)===currentSongIndex)}) };
                        playPauseBtn.addEventListener('click', () => isPlaying ? pauseSong() : playSong());
                        prevBtn.addEventListener('click', () => { const newIndex = currentSongIndex <= 0 ? playlist.length - 1 : currentSongIndex - 1; if(playlist.length>0) loadSong(newIndex).then(playSong); });
                        nextBtn.addEventListener('click', () => { const newIndex = (currentSongIndex + 1) % playlist.length; if(playlist.length>0) loadSong(newIndex).then(playSong); });
                        modeBtn.addEventListener('click', () => { currentModeIndex = (currentModeIndex + 1) % playbackModes.length; updateMode(); });
                        playlistBtn.addEventListener('click', () => playlistSidebar.classList.toggle('visible'));
                        playlistBackBtn.addEventListener('click', () => playlistSidebar.classList.remove('visible'));
                        changeWallpaperBtn.addEventListener('click', () => musicWallpaperInput.click()); // ID 已修改
                        importLocalBtn.addEventListener('click', () => musicFileInput.click());
                                            musicFileInput.addEventListener('change', async (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        const dbKey = `music_${Date.now()}_${file.name}`;
                        console.log(`[音乐保存] 准备保存文件，生成的Key是: ${dbKey}`); // 日志1：确认开始
                        try {
                            // 确保数据库已连接
                            if (!window.idbHelper.db) await window.idbHelper.initDB();
                            
                            await idbHelper.set(dbKey, file);
                            console.log(`[音乐保存] 文件已成功存入 IndexedDB。`); // 日志2：确认文件已存入

                            const fileExtension = file.name.split('.').pop().toLowerCase();
                            const nativeSupported = ['mp3', 'wav', 'ogg', 'm4a', 'aac'];
                            const useNative = nativeSupported.includes(fileExtension);

                            const newSong = {
                                title: file.name.replace(/\.[^/.]+$/, ""),
                                artist: '本地音乐',
                                src: URL.createObjectURL(file),
                                cover: 'https://picsum.photos/id/106/250/250',
                                useNative: useNative,
                                isLocal: true,
                                dbKey: dbKey,
                                file: useNative ? null : file
                            };

                            playlist.push(newSong);
                            savePlaylistToStorage(); // 这个函数会把歌曲信息（不含文件本身）存到localStorage
                            console.log(`[音乐保存] 歌曲信息已更新到 localStorage。`); // 日志3：确认信息已保存
                            
                            buildPlaylist();
                            loadSong(playlist.length - 1).then(playSong);
                            playlistSidebar.classList.remove('visible');

                            // 使用更明确的弹窗
                            alert(`歌曲 "${file.name}" 已成功保存到您的浏览器中！下次访问时它会自动加载。`);

                        } catch (err) {
                            console.error('保存或添加音乐文件失败:', err);
                            alert('保存音乐文件失败！请按F12打开控制台查看错误详情。');
                        }
                    });
                        const applyBlur = (value) => { getEl('player-background-overlay').style.setProperty('--background-blur', `${value}px`); };
                        const loadBlurSetting = () => { const savedBlur = localStorage.getItem('backgroundBlur') || 8; blurSlider.value = savedBlur; applyBlur(savedBlur); };
                        settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsPanel.classList.toggle('visible'); });
                        blurSlider.addEventListener('input', () => applyBlur(blurSlider.value));
                        blurSlider.addEventListener('change', () => localStorage.setItem('backgroundBlur', blurSlider.value));
                        document.body.addEventListener('click', () => settingsPanel.classList.remove('visible'), true);
                        settingsPanel.addEventListener('click', (e) => e.stopPropagation());
                        const setWeatherEffect=(e)=>{weatherEffectContainer.innerHTML="";if("none"===e)return;const t="snow"===e?50:100;for(let l=0;l<t;l++){const t=document.createElement("div");t.className="snow"===e?"snow-flake":"rain-drop",t.style.left=`${100*Math.random()}%`;const a="snow"===e?5+8*Math.random():.5+.5*Math.random(),s=5*Math.random();if(t.style.animationDuration=`${a}s`,t.style.animationDelay=`${s}s`,"snow"===e){const e=4+4*Math.random();t.style.width=`${e}px`,t.style.height=`${e}px`,t.style.opacity=.3+.5*Math.random()}weatherEffectContainer.appendChild(t)}};const loadWeatherSetting=()=>{const e=localStorage.getItem("weatherEffect")||"none";setWeatherEffect(e),getEl(`weather-${e}`).checked=!0};weatherOptions.forEach(e=>{e.addEventListener("change",()=>{const e=document.querySelector('input[name="weather-effect"]:checked').value;setWeatherEffect(e),localStorage.setItem("weatherEffect",e)})});
                                                                                     const init = async () => {
    // 等待主程序的数据库功能准备就绪
    while (!window.idbHelper || !window.idbHelper.db) {
        await new Promise(resolve => setTimeout(resolve, 50));
    }

    playPauseBtn.innerHTML = icons.play; 
    updateMode();
    
    // 1. 加载天气和模糊度设置
    loadWeatherSetting();
    loadBlurSetting();
    
    // 2. 加载用户头像 (现在可以安全执行了)
    try {
        const avatarFile = await window.idbHelper.get('music_user_avatar');
        if (avatarFile) {
            myAvatar.src = URL.createObjectURL(avatarFile);
        }
    } catch (err) {
        console.error('加载音乐播放器用户头像失败:', err);
    }

    // 3. 设置API接口
    window.musicPlayerAPI = {
        setPlaylistAndRender: (newPlaylist) => {
            playlist = newPlaylist || [];
            buildPlaylist();
            if (playlist.length > 0) {
                loadSong(0);
            } else {
                loadSong(-1);
            }
        },
        addToPlaylist: (song) => {
            playlist.push(song); // 确保是 h(song) 的正确实现
            buildPlaylist();
            if(playlist.length === 1) { // 如果是第一首歌，则加载并播放
                loadSong(0).then(playSong);
            }
            savePlaylistToStorage();
        }
    };
};
                        init();
                        
                        const formatTime=(s)=>s&&!isNaN(s)?`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,"0")}`:"0:00";
                        
                        const handleImageUpload=(e,t,l=!1)=>{const n=e.target.files[0];if(n){const r=new FileReader;r.onload=e=>{const a=e.target.result;t===musicPlayer?t.style.backgroundImage=`url('${a}')`:t.src=a;if(l&&currentSongIndex>=0)playlist[currentSongIndex].cover=a,savePlaylistToStorage()},r.readAsDataURL(n)}};

myAvatar.addEventListener("click", () => getEl("avatar-my-input").click());

getEl("avatar-my-input").addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    // 使用页面主脚本的 idbHelper 功能来保存文件
    window.idbHelper.set('music_user_avatar', file)
        .then(() => {
            // 成功保存后，立即更新界面上的头像
            myAvatar.src = URL.createObjectURL(file);
            console.log('音乐播放器用户头像已永久保存。');
        })
        .catch(err => {
            console.error('保存用户头像失败:', err);
            alert('保存头像失败！');
        });
});
                        guestAvatar.addEventListener("click", () => getEl("avatar-guest-input").click());
                        getEl("avatar-guest-input").addEventListener("change", e => handleImageUpload(e, guestAvatar));
                        albumArtEl.addEventListener("click", () => getEl("album-art-input").click());
                        getEl("album-art-input").addEventListener("change", e => handleImageUpload(e, albumArtEl, !0));
                        
                        const displayMessage = (text, sender, isThinking = false) => {
    const messageEl = document.createElement("div");
    messageEl.classList.add("chat-message", sender);
    messageEl.textContent = text;
    if (isThinking) {
        // 为“正在输入”的气泡添加一个临时ID，方便后续更新内容
        messageEl.id = 'music-thinking-bubble';
    }
    getEl("chat-messages").appendChild(messageEl);
    getEl("chat-messages").scrollTop = getEl("chat-messages").scrollHeight;
    return messageEl; // 返回创建的元素
};
                 const getAiResponse = async (userMessage) => {
                    const thinkingBubble = displayMessage("对方正在输入中...", "ai", true);
                    
                    if (!selectedCharacter) {
                        if(thinkingBubble) thinkingBubble.textContent = "(错误：未选择聊天伙伴。)";
                        return;
                    }

                    // 确保可以访问到全局的 callAI 函数
                    if (typeof window.callAI !== 'function') {
                         if(thinkingBubble) thinkingBubble.textContent = "(错误：AI 功能初始化失败。)";
                        return;
                    }

                    let messages = [
                        {
                            role: 'system',
                            content: `你是一个AI音乐伴侣，你的名字是 ${selectedCharacter.name}，人设是“${selectedCharacter.description}”。你正在和用户一起听歌聊天。请以这个身份进行简短、口语化的回复。`
                        },
                        { role: 'user', content: userMessage }
                    ];

                    const aiReply = await window.callAI(messages); // 使用 window.callAI

                    if (thinkingBubble) {
                        thinkingBubble.textContent = aiReply;
                        thinkingBubble.id = ''; 
                    }
                };
      getEl("chat-form").addEventListener("submit",e=>{e.preventDefault();const t=getEl("chat-input").value.trim();t&&(displayMessage(t,"me"),getEl("chat-input").value="",getAiResponse(t))});chatToggleBtn.addEventListener("click",()=>chatDialog.classList.toggle("visible"));getEl("close-chat-btn").addEventListener("click",()=>chatDialog.classList.remove("visible"));addAiBtn.addEventListener("click",()=>{characterSelectModal.classList.remove("visible"),addAiModal.classList.add("visible"),addAiForm.reset(),newAiAvatarData=null,addAiAvatarPreview.src="https://i.pravatar.cc/130?u=new-ai-placeholder"});addAiAvatarPreview.addEventListener("click",()=>addAiAvatarInput.click());addAiAvatarInput.addEventListener("change",e=>{const t=e.target.files[0];if(t){const l=new FileReader;l.onload=e=>{newAiAvatarData=e.target.result,addAiAvatarPreview.src=newAiAvatarData},l.readAsDataURL(t)}});addAiForm.addEventListener("submit",e=>{e.preventDefault();const t={id:`custom-${Date.now()}`,name:getEl("ai-name-input").value.trim(),description:getEl("ai-persona-input").value.trim(),avatarUrl:newAiAvatarData||"https://i.pravatar.cc/130?u=default-custom"};aiCharacters.push(t),saveAIsToStorage(),addAiModal.classList.remove("visible"),showCharacterSelectModal()});getEl("add-ai-cancel-btn").addEventListener("click",()=>{addAiModal.classList.remove("visible"),showCharacterSelectModal()});
const showCharacterSelectModal = () => {
    characterList.innerHTML = "";
    loadAIsFromStorage();
    let finalCharacters = [...aiCharacters];

    if (typeof window.getWeChatContacts === 'function' && typeof window.getAvatarUrl === 'function') {
        const weChatContacts = window.getWeChatContacts();
        // 修正：在映射数据时，直接调用 getAvatarUrl 将头像 ID 解析为可用的图片链接
        const weChatFormatted = weChatContacts.map(contact => ({
            id: contact.id,
            name: contact.name,
            description: contact.persona || '微信联系人',
            // 关键修复：确保这里调用了 window.getAvatarUrl
            avatarUrl: window.getAvatarUrl(contact.avatar) 
        }));

        const existingIds = new Set(finalCharacters.map(c => c.id));
        weChatFormatted.forEach(wc => {
            if (!existingIds.has(wc.id)) {
                finalCharacters.push(wc);
            }
        });
    }
    
    if (finalCharacters.length === 0) {
        characterList.innerHTML = '<li><div class="character-item-info" style="text-align:center; width:100%;">没有找到微信联系人或AI角色</div></li>';
    } else {
        finalCharacters.forEach(character => {
            const item = document.createElement("li");
            item.className = "character-item";
            // 现在 character.avatarUrl 将会是一个可以直接使用的图片链接
            item.innerHTML = `<label> 
                <input type="radio" name="ai-character" value="${character.id}"> 
                <img src="${character.avatarUrl || 'https://placehold.co/130x130'}" alt="${character.name}"> 
                <div class="character-item-info"> 
                    <strong>${character.name}</strong> 
                </div> 
            </label>`;
            characterList.appendChild(item);
        });
    }

    const addAiButton = getEl("add-ai-btn");
    if(addAiButton) addAiButton.style.display = 'block';

    characterModalConfirmBtn.disabled = true;
    characterSelectModal.classList.add("visible");
};
// ***** 核心修复：将按钮绑定事件移动到这里 *****
getEl("invite-btn").addEventListener("click", showCharacterSelectModal);
characterList.addEventListener("change", () => {
    const radio = characterList.querySelector('input[name="ai-character"]:checked');
    if (!radio) {
        characterModalConfirmBtn.disabled = true;
        return;
    }

    const selectedId = radio.value;
    
    // 为了修复Bug，我们在这里重新构建一份包含AI和微信联系人的完整列表
    let finalCharacters = [...aiCharacters]; 
    if (typeof window.getWeChatContacts === 'function' && typeof window.getAvatarUrl === 'function') {
        const weChatContacts = window.getWeChatContacts();
        // 关键：在这里也使用 getAvatarUrl，以确保数据一致
        const weChatFormatted = weChatContacts.map(contact => ({
            id: contact.id,
            name: contact.name,
            description: contact.persona || '微信联系人',
            avatarUrl: window.getAvatarUrl(contact.avatar) 
        }));
        const existingIds = new Set(finalCharacters.map(c => c.id));
        weChatFormatted.forEach(wc => {
            if (!existingIds.has(wc.id)) {
                finalCharacters.push(wc);
            }
        });
    }

    // 从这份完整的列表中查找我们选中的角色
    selectedCharacter = finalCharacters.find(c => c.id === selectedId);
    
    // 只有成功找到了角色，才激活“邀请一起听”按钮
    characterModalConfirmBtn.disabled = !selectedCharacter;
});
                        getEl("character-modal-confirm").addEventListener("click", () => {
                            if (selectedCharacter) {
                                guestAvatar.src = selectedCharacter.avatarUrl;
                                chatHeaderTitle.textContent = `与 ${selectedCharacter.name} 一起听`;
                                musicPlayer.classList.add("listening-together");
                                characterSelectModal.classList.remove("visible");
                                getEl("chat-messages").innerHTML = "";
                                displayMessage(`你好！我是${selectedCharacter.name}，很高兴和你一起听歌。`, "ai");
                                listenTogetherStartTime = Date.now();
                                randomDistance = (Math.random() * 2e3 + 10).toFixed(1);
                                if (listenTogetherInterval) clearInterval(listenTogetherInterval);
                                const updateListenInfo = () => {
                                    const elapsedMinutes = Math.floor((Date.now() - listenTogetherStartTime) / 6e4);
                                    listenTogetherInfo.textContent = `相隔 ${randomDistance} km，已经一起听了 ${elapsedMinutes} 分钟`
                                };
                                updateListenInfo();
                                listenTogetherInterval = setInterval(updateListenInfo, 3e4)
                            }
                        });
                        exitListenTogetherBtn.addEventListener("click", () => {
                            musicPlayer.classList.remove("listening-together");
                            getEl("chat-dialog").classList.remove("visible");
                            getEl("chat-messages").innerHTML = "";
                            selectedCharacter = null;
                            if (listenTogetherInterval) {
                                clearInterval(listenTogetherInterval);
                                listenTogetherInterval = null
                            }
                            listenTogetherInfo.textContent = ""
                        });
                        
                        const handlePlaylistImport = async (service) => {
                            const urlInput = getEl("playlist-url-input").value.trim();
                            if (!urlInput) return alert("请输入链接或ID");

                            let playlistId = urlInput;
                            const neteaseRegex = /(?:id=|\/playlist\/)(\d+)/;
                            const qqRegex = /\/playlist\/(\d+)/;
                            
                            if (service === 'netease') {
                                playlistId = (urlInput.match(neteaseRegex) || [])[1] || urlInput;
                            } else if (service === 'qq') {
                                playlistId = (urlInput.match(qqRegex) || [])[1] || urlInput;
                            }

                            const modalConfirmBtn = getEl("playlist-import-modal").querySelector(".modal-confirm-btn");
                            modalConfirmBtn.textContent = "解析中...";
                            modalConfirmBtn.disabled = true;

                            try {
                                // 1. 更换为全新的、更稳定的第三方音乐API接口
                                const targetApiUrl = `https://api.i-meto.com/meting/api?server=${service}&type=playlist&id=${playlistId}`;

                                // 2. 移除CORS代理，因为新的API自带跨域支持，可以直接请求
                                const response = await fetch(targetApiUrl);

                                if (!response.ok) {
                                    throw new Error(`网络请求失败, 状态码: ${response.status}`);
                                }
                                
                                const data = await response.json();

                                if (Array.isArray(data) && data.length > 0) {
                                    const newSongs = data.map(song => ({
                                        title: song.name,
                                        artist: song.artist.join(' / '), // 作者可能是个数组，用'/'拼接
                                        src: song.url,
                                        cover: song.pic,
                                        isLocal: false,
                                        useNative: true
                                    }));
                                    playlist.push(...newSongs);
                                    savePlaylistToStorage();
                                    buildPlaylist();
                                    getEl("playlist-import-modal").classList.remove("visible");
                                    alert(`成功导入 ${newSongs.length} 首歌曲！`);
                                } else {
                                    throw new Error("歌单为空或API解析失败，请检查链接是否有效。");
                                }
                            } catch (error) {
                                // 3. 增强错误处理，给出更具体的建议
                                console.error("歌单导入失败详情:", error);
                                alert(`导入失败: ${error.message}\n\n提示：请确认歌单是公开的，并且链接/ID完全正确。`);
                            } finally {
                                modalConfirmBtn.textContent = "导入";
                                modalConfirmBtn.disabled = false;
                            }
                        };
                        const openImportModal=e=>{getEl("playlist-modal-title").textContent=`导入${"netease"===e?"网易云":"QQ"}音乐歌单`,getEl("playlist-url-input").value="",getEl("playlist-import-modal").classList.add("visible");const t=getEl("playlist-import-modal").querySelector(".modal-confirm-btn"),l=t.cloneNode(!0);t.parentNode.replaceChild(l,t),l.addEventListener("click",()=>handlePlaylistImport(e))};getEl('import-netease-btn').addEventListener("click",()=>openImportModal("netease"));getEl('import-qq-btn').addEventListener("click",()=>openImportModal("qq"));getEl("playlist-modal-cancel").addEventListener("click",()=>getEl("playlist-import-modal").classList.remove("visible"));getEl('import-url-btn').addEventListener("click",()=>{const e=prompt("请输入音乐文件的 URL:");e&&(newSong={title:e.substring(e.lastIndexOf("/")+1),artist:"网络音乐",src:e,cover:"https://picsum.photos/id/107/250/250",isLocal:!1, useNative: true},playlist.push(newSong),savePlaylistToStorage(),buildPlaylist(),loadSong(playlist.length-1).then(playSong),playlistSidebar.classList.remove("visible"))});
                        
                        // [新增] 重新关联按钮点击事件，修复无响应的bug
                        changeWallpaperBtn.addEventListener('click', () => musicWallpaperInput.click());
                    })();
                    </script>
                </div>
                <div id="game-screen" class="screen main-screen hidden absolute inset-0 w-full h-full z-[80] flex flex-col bg-gray-100">
                     <div class="settings-header"><div class="w-16"></div><h2 class="font-bold text-xl text-center">游戏</h2><button class="back-to-home-btn text-blue-500 text-lg font-bold">完成</button></div>
                     <div class="flex-grow flex items-center justify-center text-gray-400">小游戏 App 功能待开发...</div>
                </div>

                <div id="loading-overlay" class="hidden absolute inset-0 bg-black/50 z-[110] flex items-center justify-center"><div class="loader"></div></div>
            </div>
        </div>
    </div>

   <script>
    document.addEventListener('DOMContentLoaded', function () {
        const phoneFrame = document.querySelector('.phone-frame');
        // --- 新增：音乐播放器壁纸更换与保存逻辑 ---
const musicWallpaperInput = document.getElementById('music-wallpaper-input');
const musicPlayer = document.getElementById('music-player');

musicWallpaperInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        // 1. 使用 idbHelper 保存文件到 IndexedDB
        idbHelper.set('music_wallpaper', file).then(() => {
            console.log('音乐播放器壁纸已成功保存到数据库。');
        }).catch(err => {
            console.error('保存音乐壁纸失败:', err);
            alert('保存壁纸文件失败！');
        });

        // 2. 立即使用 Object URL 在界面上显示预览，对大文件更高效
        const objectURL = URL.createObjectURL(file);
        musicPlayer.style.backgroundImage = `url('${objectURL}')`;
    }
});
        let apiSettings = {};
        let activeChatPageId = null;
                // =======================================================
        // ============= IndexedDB 助手 (用于存储大文件) ============
        // =======================================================
        window.idbHelper = {
            db: null,
            initDB() {
                return new Promise((resolve, reject) => {
                    if (this.db) return resolve(this.db);
                    const request = indexedDB.open('PhoneSimulatorDB', 1);
                    request.onupgradeneeded = event => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            db.createObjectStore('files');
                        }
                    };
                    request.onsuccess = event => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onerror = event => {
                        console.error("IndexedDB error:", event.target.errorCode);
                        reject(event.target.errorCode);
                    };
                });
            },
            set(key, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const request = store.put(value, key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            get(key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
             getAll() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.getAll();
                    const keysRequest = store.getAllKeys();

                    Promise.all([
                        new Promise(res => keysRequest.onsuccess = () => res(keysRequest.result)),
                        new Promise(res => request.onsuccess = () => res(request.result))
                    ]).then(([keys, values]) => {
                         const result = {};
                         keys.forEach((key, index) => {
                             result[key] = values[index];
                         });
                         resolve(result);
                    }).catch(reject);
                });
            }
        };
        // =======================================================
        // ================== 新增的设置保存/加载函数 =================
        // =======================================================
        function saveHomescreenSettings() {
            try {
                const settingsToSave = {};
                // 只保存可编辑的文本内容
                document.querySelectorAll('.editable, #user-name, #user-bio').forEach(el => {
                    const id = el.id || el.parentElement.parentElement.querySelector('.widget-icon > img')?.id;
                    if(id) settingsToSave[`text_${id}`] = el.textContent;
                });
    
                localStorage.setItem('homescreenTextSettings', JSON.stringify(settingsToSave)); // 使用新的键名
                alert('主屏幕文本内容已保存！图片在选择后会自动保存。');
            } catch (error) {
                console.error("保存主屏幕文本失败:", error);
                alert("保存文本失败！");
            }
        }
        async function loadHomescreenSettings() {
            // 1. 从 localStorage 加载文本
            const savedTextSettings = JSON.parse(localStorage.getItem('homescreenTextSettings'));
            if (savedTextSettings) {
                Object.keys(savedTextSettings).forEach(key => {
                    const [type, id] = key.split(/_(.*)/s);
                    if (type === 'text') {
                        const el = document.getElementById(id);
                         if(el) {
                             if(el.classList.contains('editable') || el.id === 'user-name' || el.id === 'user-bio') {
                                 el.textContent = savedTextSettings[key];
                             } else {
                                const textEl = el.closest('.flex.items-center.space-x-2')?.querySelector('p.editable') || document.querySelector(`#${id}`);
                                if(textEl) textEl.textContent = savedTextSettings[key];
                             }
                         }
                    }
                });
            }

            // 2. 从 IndexedDB 加载图片和背景
            const savedFiles = await idbHelper.getAll();
            Object.keys(savedFiles).forEach(key => {
                const [type, id] = key.split(/_(.*)/s);
                const el = document.getElementById(id);
                const file = savedFiles[key];
                if (el && file) {
                    const objectURL = URL.createObjectURL(file);
                    if (type === 'image') {
                        el.src = objectURL;
                    } else if (type === 'bg') {
                        el.style.backgroundImage = `url('${objectURL}')`;
                    }
                }
            });
        }
        
        function saveAppearanceSettings() {
            // 夜间模式
            localStorage.setItem('nightMode', document.getElementById('night-mode-toggle').checked ? 'enabled' : 'disabled');
            // 字体
            localStorage.setItem('customFont', phoneFrame.style.fontFamily || "'Inter', sans-serif");
            const customFontData = document.getElementById('custom-font-face-style').innerHTML;
            if (customFontData) localStorage.setItem('customFontData', customFontData);
            
            // 聊天气泡
            const activeCustomStyleName = localStorage.getItem('activeChatStyleName');
            if (!activeCustomStyleName) {
                 const activeSimpleStyle = document.getElementById('wechat-screen').className.match(/chat-bubble-style-(\w+)/);
                 localStorage.setItem('chatBubbleStyle', activeSimpleStyle ? activeSimpleStyle[1] : 'default');
            }
            alert('外观设置已保存！');
        }


        // =======================================================
        // ================== 通用 AI 调用函数 =================
        // =======================================================
                window.callAI = async function(messages) {
            // 检查API设置是否完整
            if (!apiSettings.baseUrl || !apiSettings.apiKey) {
                console.error("API settings are missing.");
                return "(AI调用出错：请先在主屏幕的【设置】->【API设定】中填写好信息。)";
            }
            try {
                // --- 修改开始 ---
                // 定义一个CORS代理服务器地址。您可以选用其他的公开代理。
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/'; 
                
                // 拼接最终请求的URL
                const targetUrl = apiSettings.baseUrl + '/chat/completions';

                const response = await fetch(proxyUrl + targetUrl, {
                // --- 修改结束 ---
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.apiKey}`,
                        // 注意：某些CORS代理需要这个额外的头信息
                        'X-Requested-With': 'XMLHttpRequest' 
                    },
                    body: JSON.stringify({
                        model: apiSettings.modelName,
                        messages: messages,
                        stream: false
                    })
                });
                if (!response.ok) {
                    throw new Error(`API 请求失败，状态码: ${response.status}`);
                }
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('AI call failed:', error);
                return `(AI调用出错：${error.message})`;
            }
        }
        // --- SCREEN NAVIGATION ---
        function showMainScreen(screenId) {
            const currentScreen = document.querySelector('.main-screen.active');
            if (currentScreen && currentScreen.id === 'wechat-screen' && activeChatPageId === 'ai-chat-page') {
                saveCurrentChatHistory();
            }
            document.querySelectorAll('.main-screen').forEach(s => s.classList.add('main-hidden'));
            const screenToShow = document.getElementById(screenId);
            screenToShow.classList.remove('main-hidden');
            setTimeout(() => {
                document.querySelectorAll('.main-screen').forEach(s => s.classList.add('hidden'));
                screenToShow.classList.remove('hidden');
            }, 10);
        }

        function showSettingsSubScreen(screenId) {
            document.querySelectorAll('#settings-container .screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        document.getElementById('settings-app-icon').addEventListener('click', () => showMainScreen('settings-container'));
        document.getElementById('wechat-app-icon').addEventListener('click', () => {
            showMainScreen('wechat-screen');
            const wechatApp = document.getElementById('wechat-screen');
            const activePage = wechatApp.querySelector('.page.active');
            const wechatSwitchPageFunc = wechatApp.switchPage;
            if (wechatSwitchPageFunc && activePage) {
                wechatSwitchPageFunc(activePage.id);
            }
        });
        document.getElementById('back-to-home-from-settings').addEventListener('click', () => showMainScreen('home-screen'));
        document.getElementById('back-to-home-from-wechat').addEventListener('click', () => showMainScreen('home-screen'));

        document.querySelectorAll('.settings-menu-item').forEach(item => {
            item.addEventListener('click', () => showSettingsSubScreen(item.dataset.target));
        });
        document.querySelectorAll('.back-to-main-settings').forEach(btn => {
            btn.addEventListener('click', () => showSettingsSubScreen('settings-screen'));
        });

        document.getElementById('music-app-icon').addEventListener('click', () => showMainScreen('music-screen'));
        document.getElementById('game-app-icon').addEventListener('click', () => showMainScreen('game-screen'));
        document.getElementById('dock-placeholder-1').addEventListener('click', () => alert('功能待开发'));
        document.getElementById('dock-placeholder-2').addEventListener('click', () => alert('功能待开发'));
        document.querySelectorAll('.back-to-home-btn').forEach(btn => {
            btn.addEventListener('click', () => showMainScreen('home-screen'));
        });

        // --- STATUS BAR ---
        const timeElement = document.getElementById('time');
        const batteryElement = document.getElementById('battery-level');
        function updateTime() { timeElement.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }); }
        function updateBattery(battery) { batteryElement.textContent = Math.floor(battery.level * 100) + '%'; }
        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                updateBattery(battery);
                battery.addEventListener('levelchange', () => updateBattery(battery));
            });
        } else {
            batteryElement.textContent = 'N/A';
        }
        updateTime(); 
        setInterval(updateTime, 1000);
        
        // --- GESTURE NAVIGATION ---
        const musicScreenForGesture = document.getElementById('music-screen');
        let musicTouchStartX = 0;

        musicScreenForGesture.addEventListener('touchstart', (e) => {
            musicTouchStartX = e.touches[0].clientX;
        }, { passive: true });

        musicScreenForGesture.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const deltaX = touchEndX - musicTouchStartX;
            const swipeThreshold = -75;

            if (deltaX < swipeThreshold) {
                const isModalVisible = musicScreenForGesture.querySelector('.modal.visible, .playlist-sidebar.visible, .chat-dialog.visible, .settings-panel.visible');
                if (!isModalVisible) {
                    showMainScreen('home-screen');
                }
            }
        }, { passive: true });
        // --- IMAGE UPLOADING ---
        function setupSimpleImageUploader(trigger, inputEl, isBackground) {
            const targetEl = document.getElementById(trigger.dataset.target);
            if (!trigger || !inputEl || !targetEl) return;
            
            trigger.addEventListener('click', (e) => { e.stopPropagation(); inputEl.click(); });
            
            inputEl.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    // 1. 立即存入 IndexedDB
                    const keyPrefix = isBackground ? 'bg_' : 'image_';
                    const key = keyPrefix + targetEl.id;
                    idbHelper.set(key, file).then(() => {
                        console.log(`${key} 已保存到 IndexedDB`);
                    }).catch(err => {
                        console.error(`保存 ${key} 到 IndexedDB 失败:`, err);
                        alert("保存图片文件失败！");
                    });

                    // 2. 立即在界面上显示预览
                    const objectURL = URL.createObjectURL(file);
                    if (isBackground) {
                        targetEl.style.backgroundImage = `url('${objectURL}')`;
                    } else {
                        targetEl.src = objectURL;
                    }
                }
            });
        }
        document.querySelectorAll('.settings-change-btn').forEach(btn => {
            const inputId = btn.dataset.input;
            const inputEl = document.getElementById(inputId);
            const isBackground = ['wallpaper-input', 'top-bg-input', 'bottom-bg-input'].includes(inputId);
            setupSimpleImageUploader(btn, inputEl, isBackground);
        });

        
        // --- API SETTINGS ---
        const apiBaseUrlInput = document.getElementById('api-base-url-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const apiModelNameInput = document.getElementById('api-model-name-input');
        const saveApiSettingsBtn = document.getElementById('save-api-settings-btn');
        const fetchModelsBtn = document.getElementById('fetch-models-btn');
        const modelSelector = document.getElementById('model-selector-dropdown');

        function loadApiSettings() {
            apiSettings = {
                baseUrl: localStorage.getItem('apiBaseUrl') || '',
                apiKey: localStorage.getItem('apiKey') || '',
                modelName: localStorage.getItem('apiModelName') || 'gemini-pro',
            };
            apiBaseUrlInput.value = apiSettings.baseUrl;
            apiKeyInput.value = apiSettings.apiKey;
            apiModelNameInput.value = apiSettings.modelName;
        }

        saveApiSettingsBtn.addEventListener('click', () => {
            apiSettings = {
                baseUrl: apiBaseUrlInput.value.trim(),
                apiKey: apiKeyInput.value.trim(),
                modelName: apiModelNameInput.value.trim()
            };
            localStorage.setItem('apiBaseUrl', apiSettings.baseUrl);
            localStorage.setItem('apiKey', apiSettings.apiKey);
            localStorage.setItem('apiModelName', apiSettings.modelName);
            alert('API 设定已储存！');
        });
          const testApiBtn = document.getElementById('test-api-btn');
        const apiStatusIndicator = document.getElementById('api-status-indicator');

        testApiBtn.addEventListener('click', async () => {
            const baseUrl = apiBaseUrlInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            if (!baseUrl || !apiKey) {
                alert('请先输入 API 地址和 Key！'); return;
            }
            apiStatusIndicator.textContent = '测试中...';
            apiStatusIndicator.style.color = 'orange';
            try {
                const response = await fetch(new URL('models', baseUrl).toString(), {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                if (response.ok) {
                    apiStatusIndicator.textContent = '✅ 连接成功';
                    apiStatusIndicator.style.color = 'green';
                } else {
                    throw new Error(`服务器返回错误: ${response.status}`);
                }
            } catch (error) {
                console.error('API Test Failed:', error);
                apiStatusIndicator.textContent = '❌ 连接失败';
                apiStatusIndicator.style.color = 'red';
                alert('连接测试失败，请检查 API 地址和 Key 是否正确，或按 F12 查看控制台错误信息。');
            }
        });      
        modelSelector.addEventListener('change', () => { if(modelSelector.value) { apiModelNameInput.value = modelSelector.value; } });


        // --- APPEARANCE SETTINGS ---
        const nightModeToggle = document.getElementById('night-mode-toggle');
        function setNightMode(enabled) {
            phoneFrame.classList.toggle('night-mode', enabled);
        }
        nightModeToggle.addEventListener('change', () => setNightMode(nightModeToggle.checked));
        
        const fontSelector = document.getElementById('font-selector');
        const importFontBtn = document.getElementById('import-font-btn');
        const fontInput = document.getElementById('font-input');
        const customFontFaceStyle = document.getElementById('custom-font-face-style');
        fontSelector.addEventListener('change', (e) => applyFont(e.target.value));
        importFontBtn.addEventListener('click', () => fontInput.click());

        function increaseCssSpecificity(css, prefix) {
            if (!css) return '';
            return css.replace(/([^\}]+?)({)/g, (match, selectors, brace) => {
                const prefixedSelectors = selectors.split(',')
                                                 .map(s => `${prefix} ${s.trim()}`)
                                                 .join(', ');
                return `${prefixedSelectors} ${brace}`;
            });
        }

        const wechatScreenForBubbles = document.getElementById('wechat-screen');
        const chatBubbleStyleBtns = document.querySelectorAll('.chat-bubble-style-btn');
        const customCssInput = document.getElementById('custom-css-input');
        const saveCustomCssBtn = document.getElementById('save-custom-css-btn');
        const deleteCustomStyleBtn = document.getElementById('delete-custom-style-btn');
        const customStyleSelector = document.getElementById('custom-style-selector');
        const customChatBubbleStyles = document.getElementById('custom-chat-bubble-styles');
        let savedChatStyles = [];

        function loadCustomChatStyles() {
            savedChatStyles = JSON.parse(localStorage.getItem('savedChatStyles') || '[]');
            customStyleSelector.innerHTML = '<option value="">选择一个主题...</option>';
            savedChatStyles.forEach(style => {
                const option = new Option(style.name, style.name);
                customStyleSelector.add(option);
            });
        }

        function applySimpleChatBubbleStyle(style) {
            customChatBubbleStyles.innerHTML = '';
            customStyleSelector.value = '';
            localStorage.removeItem('activeChatStyleName');
            wechatScreenForBubbles.classList.remove('custom-bubbles-active');
            
            wechatScreenForBubbles.className = wechatScreenForBubbles.className.replace(/chat-bubble-style-\w+/g, '');
            if (style !== 'default') {
                wechatScreenForBubbles.classList.add(`chat-bubble-style-${style}`);
            }
            
            chatBubbleStyleBtns.forEach(btn => {
                btn.classList.toggle('border-blue-500', btn.dataset.style === style);
                btn.classList.toggle('border-transparent', btn.dataset.style !== style);
            });
        }
        chatBubbleStyleBtns.forEach(btn => btn.addEventListener('click', () => {
            applySimpleChatBubbleStyle(btn.dataset.style)
            localStorage.setItem('chatBubbleStyle', btn.dataset.style);
        }));

        customStyleSelector.addEventListener('change', () => {
            const selectedName = customStyleSelector.value;
            wechatScreenForBubbles.className = wechatScreenForBubbles.className.replace(/chat-bubble-style-\w+/g, '');
            localStorage.setItem('chatBubbleStyle', 'default');
            chatBubbleStyleBtns.forEach(btn => {
                btn.classList.remove('border-blue-500');
                btn.classList.add('border-transparent');
            });
            document.querySelector('.chat-bubble-style-btn[data-style="default"]').classList.add('border-blue-500');
            
            if (selectedName) {
                wechatScreenForBubbles.classList.add('custom-bubbles-active');
                const style = savedChatStyles.find(s => s.name === selectedName);
                if (style) {
                    customChatBubbleStyles.innerHTML = increaseCssSpecificity(style.css, '#wechat-screen.custom-bubbles-active');
                    customCssInput.value = style.css;
                    localStorage.setItem('activeChatStyleName', selectedName);
                }
            } else {
                wechatScreenForBubbles.classList.remove('custom-bubbles-active');
                customChatBubbleStyles.innerHTML = '';
                customCssInput.value = '';
                localStorage.removeItem('activeChatStyleName');
            }
        });
        
        saveCustomCssBtn.addEventListener('click', () => {
            const cssCode = customCssInput.value.trim();
            if (!cssCode) { alert('CSS 代码不能为空！'); return; }
            const name = prompt('请输入这个新主题的名称:');
            if (name && name.trim()) {
                const existingIndex = savedChatStyles.findIndex(s => s.name === name);
                if (existingIndex > -1) {
                    savedChatStyles[existingIndex].css = cssCode;
                } else {
                    savedChatStyles.push({ name: name, css: cssCode });
                }
                localStorage.setItem('savedChatStyles', JSON.stringify(savedChatStyles));
                loadCustomChatStyles();
                customStyleSelector.value = name;
                customStyleSelector.dispatchEvent(new Event('change'));
                alert(`主题 "${name}" 已保存！`);
            }
        });

        deleteCustomStyleBtn.addEventListener('click', () => {
            const selectedName = customStyleSelector.value;
            if (!selectedName) { alert('请先选择一个要删除的主题。'); return; }
            if (confirm(`确定要删除主题 "${selectedName}" 吗？`)) {
                savedChatStyles = savedChatStyles.filter(s => s.name !== selectedName);
                localStorage.setItem('savedChatStyles', JSON.stringify(savedChatStyles));
                if (localStorage.getItem('activeChatStyleName') === selectedName) {
                    localStorage.removeItem('activeChatStyleName');
                    customChatBubbleStyles.innerHTML = '';
                    wechatScreenForBubbles.classList.remove('custom-bubbles-active');
                }
                customCssInput.value = '';
                loadCustomChatStyles();
                alert(`主题 "${selectedName}" 已删除。`);
            }
        });

        // --- PAGE INITIALIZATION ---
        async function initialize() {
            // 0. 初始化数据库（最先执行）
            await idbHelper.initDB();
           // --- 修复开始：在页面加载时，从数据库恢复已保存的微信主页图片 ---
           try {
                // 定义需要加载的图片和它们对应的位置
                const imagesToLoad = {
                    'wechat_profile_avatar': '#profile-avatar',
                    'wechat_moments_avatar': '#discover-page-avatar',
                    'wechat_moments_cover': '#moments-cover-photo'
                };

                // 遍历并加载每一张图片
                for (const dbKey in imagesToLoad) {
                    const file = await idbHelper.get(dbKey);
                    if (file) {
                        const objectURL = URL.createObjectURL(file);
                        const imgElement = wechatContainer.querySelector(imagesToLoad[dbKey]);
                        if (imgElement) {
                            imgElement.src = objectURL;
                        }
                    }
                }
                console.log("微信主页的永久图片已成功加载。");
            } catch (err) {
                console.error("从数据库加载个人主页图片失败:", err);
            }
            // --- 修复结束 ---
                    // [新增] 加载已保存的音乐播放器壁纸
        try {
            const wallpaperFile = await idbHelper.get('music_wallpaper');
            if (wallpaperFile) {
                const objectURL = URL.createObjectURL(wallpaperFile);
                document.getElementById('music-player').style.backgroundImage = `url('${objectURL}')`;
            }
        } catch (err) {
            console.error("加载已保存的音乐壁纸失败:", err);
        }
               // [新增] 加载并恢复整个音乐播放列表
        async function loadAndSetPlaylist() {
            const savedMeta = JSON.parse(localStorage.getItem('musicPlaylist') || '[]');
            if (!savedMeta.length) {
                if (window.musicPlayerAPI) window.musicPlayerAPI.setPlaylistAndRender([]);
                return;
            }

            const hydratedPlaylist = await Promise.all(savedMeta.map(async (song) => {
                // 如果是本地歌曲，就从数据库恢复文件
                if (song.dbKey && song.isLocal) {
                    try {
                        const file = await idbHelper.get(song.dbKey);
                        if (file) {
                            song.src = URL.createObjectURL(file);
                            if (!song.useNative) {
                                song.file = file; // 为 Aurora.js 重新附加 file 对象
                            }
                        } else {
                            console.warn(`未能从数据库恢复文件: ${song.dbKey}`);
                            return null; // 如果文件丢失，则标记为无效歌曲
                        }
                    } catch (err) {
                         console.error(`恢复文件 ${song.dbKey} 出错:`, err);
                         return null;
                    }
                }
                return song;
            }));

            const finalPlaylist = hydratedPlaylist.filter(song => song !== null); // 过滤掉恢复失败的歌曲

            if (window.musicPlayerAPI) {
                window.musicPlayerAPI.setPlaylistAndRender(finalPlaylist);
            }
        }
        await loadAndSetPlaylist(); 
                   // 1. 加载API设定
        loadApiSettings();
        
        // --- 在这里添加新代码 ---
        if (wechatContainer) {
    // 加载微信联系人数据
    loadContactsData(); 
     }
        // --- 新代码结束 ---

        // 2. 加载主屏幕设置
        await loadHomescreenSettings();
            
            // 3. 加载外观美化设置
            // 夜间模式
            const savedNightMode = localStorage.getItem('nightMode') === 'enabled';
            nightModeToggle.checked = savedNightMode;
            setNightMode(savedNightMode);
            
            // 字体
            const savedFontData = localStorage.getItem('customFontData');
            if (savedFontData) {
                customFontFaceStyle.innerHTML = savedFontData;
            }
            const savedFont = localStorage.getItem('customFont') || "'Inter', sans-serif";
            applyFont(savedFont);

            // 聊天气泡主题
            loadCustomChatStyles();
            const activeCustomStyleName = localStorage.getItem('activeChatStyleName');
            if (activeCustomStyleName && savedChatStyles.some(s => s.name === activeCustomStyleName)) {
                customStyleSelector.value = activeCustomStyleName;
                customStyleSelector.dispatchEvent(new Event('change'));
            } else {
                const savedBubbleStyle = localStorage.getItem('chatBubbleStyle') || 'default';
                applySimpleChatBubbleStyle(savedBubbleStyle);
            }
        }

          initialize().catch(err => console.error("初始化失败:", err));
     
        // --- 新增：AI主动发表朋友圈的定时器 ---
setInterval(() => {
    // 每2分钟，有50%的几率触发
    if (Math.random() < 0.50 && addressBookContacts.length > 0) {
        // 随机从通讯录里挑选一个AI联系人
        const randomContact = addressBookContacts[Math.floor(Math.random() * addressBookContacts.length)];
        console.log(`AI [${randomContact.name}] 将主动发朋友圈...`);
        generateAndPostAIMoment(randomContact); // 调用我们的新函数
    }
}, 120000); // 120000毫秒 = 2分钟
// --- 新增: 保存按钮事件监听 ---
        document.getElementById('save-homescreen-settings-btn').addEventListener('click', saveHomescreenSettings);
        document.getElementById('save-appearance-settings-btn').addEventListener('click', saveAppearanceSettings);

        fetchModelsBtn.addEventListener('click', async () => {
            const baseUrl = apiBaseUrlInput.value.trim(); const apiKey = apiKeyInput.value.trim();
            if (!baseUrl || !apiKey) { alert('提取失败: 请先输入 API 地址和 API Key！'); return; }
            const url = new URL(baseUrl); if (!url.pathname.endsWith('/')) url.pathname += '/'; url.pathname += 'models';
            fetchModelsBtn.textContent = '提取中...'; fetchModelsBtn.disabled = true;
            try {
                const response = await fetch(url.toString(), { method: 'GET', headers: { 'Authorization': `Bearer ${apiKey}` } });
                if (!response.ok) { throw new Error(`服务器响应错误, 状态码: ${response.status}`); }
                const data = await response.json(); const models = data.data || data;
                if (!Array.isArray(models) || models.length === 0) { throw new Error('未找到有效的模型列表。'); }
                modelSelector.innerHTML = '<option value="">-- 请选择一个模型 --</option>';
                models.forEach(model => { if(model.id) { const option = document.createElement('option'); option.value = model.id; option.textContent = model.id; modelSelector.appendChild(option); } });
                modelSelector.classList.remove('hidden'); alert(`提取成功！共找到 ${models.length} 个模型。`);
            } catch (error) { console.error(error); alert(`提取失败: ${error.message}。\n请检查 API 地址和 Key 是否正确，以及网络连接。`);
            } finally { fetchModelsBtn.textContent = '获取模型'; fetchModelsBtn.disabled = false; }
        });

        function applyFont(fontFamily) {
            phoneFrame.style.fontFamily = fontFamily;
            let exists = Array.from(fontSelector.options).some(opt => opt.value === fontFamily);
            if (!exists && fontFamily === "'CustomFont'") {
                let customOption = fontSelector.querySelector('option[value="\'CustomFont\'"]');
                if (!customOption) { customOption = new Option('导入的字体', "'CustomFont'", true, true); fontSelector.add(customOption); }
                customOption.selected = true;
            } else { fontSelector.value = fontFamily; }
        }
        fontInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fontDataUrl = e.target.result;
                    const fontFaceRule = `@font-face { font-family: 'CustomFont'; src: url(${fontDataUrl}); }`;
                    customFontFaceStyle.innerHTML = fontFaceRule; applyFont("'CustomFont'");
                };
                reader.readAsDataURL(file);
            }
        });
        
        // =======================================================
        // =========== WECHAT SCRIPT START HERE ===========
        // =======================================================
         let tempAiAvatarFile = null;
         let tempUserAvatarFile = null;
         let tempProfileAvatarFile = null;
         let tempMomentsAvatarFile = null;
         let tempMomentsCoverFile = null; 
        // --- 新增的辅助函数 ---
        async function applyChatAppearance(settings) {
            // 恢复默认样式
            chatMessagesContainer.style.backgroundImage = '';
            aiChatPage.querySelector('.chat-header').style.backgroundColor = '';
            aiChatPage.querySelector('.chat-input-area').style.backgroundColor = '';

            if (!settings) return;

            // 从数据库加载并应用独立的壁纸
            if (settings.wallpaper && settings.wallpaper.startsWith('wallpaper_')) {
                try {
                    const file = await idbHelper.get(settings.wallpaper);
                    if (file) {
                        chatMessagesContainer.style.backgroundImage = `url('${URL.createObjectURL(file)}')`;
                        chatMessagesContainer.style.backgroundSize = 'cover';
                        chatMessagesContainer.style.backgroundPosition = 'center';
                    }
                } catch (e) { console.error('加载独立壁纸失败:', e); }
            }
            
            // 应用独立的颜色
            if (settings.topBarColor) aiChatPage.querySelector('.chat-header').style.backgroundColor = settings.topBarColor;
            if (settings.bottomBarColor) aiChatPage.querySelector('.chat-input-area').style.backgroundColor = settings.bottomBarColor;
        }
        // --- 新增结束 ---
        const wechatContainer = document.getElementById('wechat-screen');
        if (wechatContainer) {
        // [新代码开始] - 这两段是新增的，用于保存和加载文字信息
function saveProfileData() {
    const profileData = {
        profileName: wechatContainer.querySelector('#profile-page-name').textContent,
        profileId: wechatContainer.querySelector('#profile-page-id').textContent,
        momentsName: wechatContainer.querySelector('#discover-page-name').textContent
    };
    localStorage.setItem('wechatProfileData', JSON.stringify(profileData));
}

function loadProfileData() {
    const savedData = localStorage.getItem('wechatProfileData');
    if (savedData) {
        const profileData = JSON.parse(savedData);
        wechatContainer.querySelector('#profile-page-name').textContent = profileData.profileName;
        wechatContainer.querySelector('#profile-page-id').textContent = profileData.profileId;
        wechatContainer.querySelector('#discover-page-name').textContent = profileData.momentsName;
    }
}
// [新代码结束]
        function saveProfileData() {
    const profileData = {
        profileName: wechatContainer.querySelector('#profile-page-name').textContent,
        profileId: wechatContainer.querySelector('#profile-page-id').textContent,
        momentsName: wechatContainer.querySelector('#discover-page-name').textContent
    };
    localStorage.setItem('wechatProfileData', JSON.stringify(profileData));
}

function loadProfileData() {
    const savedData = localStorage.getItem('wechatProfileData');
    if (savedData) {
        const profileData = JSON.parse(savedData);
        wechatContainer.querySelector('#profile-page-name').textContent = profileData.profileName;
        wechatContainer.querySelector('#profile-page-id').textContent = profileData.profileId;
        wechatContainer.querySelector('#discover-page-name').textContent = profileData.momentsName;
    }
}
            function saveContactsData() {
        try {
            localStorage.setItem('wechatInitialChats', JSON.stringify(initialChats));
            localStorage.setItem('wechatAddressBook', JSON.stringify(addressBookContacts));
            console.log("联系人数据已保存!");
        } catch (e) {
            console.error("保存联系人数据失败:", e);
        }
    }
// 新增：头像缓存区。用来存放从数据库取出的头像临时链接，避免重复读取。
let avatarCache = {};

// 新增：获取头像URL的工具函数。所有需要显示头像的地方都会用到它。
window.getAvatarUrl = function(avatarValue) {
    if (typeof avatarValue === 'string' && avatarValue.startsWith('avatar_')) {
        // 如果是永久ID，就从缓存里找对应的临时链接
        return avatarCache[avatarValue] || 'https://placehold.co/150x150/EFEFEF/333333?text=?';
    }
    // 如果不是永久ID（比如默认头像），直接返回原值
    return avatarValue;
}
function loadContactsData() {
    return new Promise((resolve) => {
        const savedChats = localStorage.getItem('wechatInitialChats');
        const savedAddressBook = localStorage.getItem('wechatAddressBook');

        if (savedChats) {
            initialChats = JSON.parse(savedChats);
        }
        if (savedAddressBook) {
            addressBookContacts = JSON.parse(savedAddressBook);
        }

        const populateAvatarCache = async () => {
            // 包含所有联系人和所有聊天中独立的用户头像
            const allContacts = [...initialChats, ...addressBookContacts];
            const processedKeys = new Set(); 

            for (const contact of allContacts) {
                // 缓存AI联系人头像
                const aiAvatarKey = contact.avatar;
                if (typeof aiAvatarKey === 'string' && aiAvatarKey.startsWith('avatar_') && !processedKeys.has(aiAvatarKey)) {
                    processedKeys.add(aiAvatarKey);
                    if (!avatarCache[aiAvatarKey]) {
                        try {
                            const file = await idbHelper.get(aiAvatarKey);
                            if (file) avatarCache[aiAvatarKey] = URL.createObjectURL(file);
                        } catch (err) { console.error(`恢复AI头像失败 (key: ${aiAvatarKey}):`, err); }
                    }
                }
                
                // 缓存该聊天中独立的用户头像
                const userProfileAvatarKey = contact.userProfile?.avatar;
                if (typeof userProfileAvatarKey === 'string' && userProfileAvatarKey.startsWith('avatar_') && !processedKeys.has(userProfileAvatarKey)) {
                    processedKeys.add(userProfileAvatarKey);
                     if (!avatarCache[userProfileAvatarKey]) {
                        try {
                            const file = await idbHelper.get(userProfileAvatarKey);
                            if (file) avatarCache[userProfileAvatarKey] = URL.createObjectURL(file);
                        } catch (err) { console.error(`恢复独立用户头像失败 (key: ${userProfileAvatarKey}):`, err); }
                    }
                }
            }

            // 单独处理用户的“默认”头像
            const defaultUserAvatarKey = defaultUserSettings.avatar;
            if (typeof defaultUserAvatarKey === 'string' && defaultUserAvatarKey.startsWith('avatar_') && !avatarCache[defaultUserAvatarKey]) {
                 try {
                    const file = await idbHelper.get(defaultUserAvatarKey);
                    if (file) avatarCache[defaultUserAvatarKey] = URL.createObjectURL(file);
                 } catch(err) { console.error('恢复默认用户头像失败:', err); }
            }
        };

        populateAvatarCache().then(() => {
            renderChatList();
            displayContacts();
            resolve();
        });
    });
}

            const mobileContainer = wechatContainer.querySelector('#mobile-container');
            const pages = wechatContainer.querySelectorAll('.page');
            const alertPopup = wechatContainer.querySelector('#alert-popup');
            const backToHomeBtn = document.getElementById('back-to-home-from-wechat');
            let currentChatPartner = {};
            // 这将作为新聊天会话的“默认”用户配置
            let defaultUserSettings = { name: '', avatar: '', avatarFrame: '', persona: '' }; 
            // 这个变量将动态持有当前聊天会话中“你”的配置信息
            let activeChatUserProfile = {}; 
            let chatSettings = {};
            let proactiveChatTimer = null;
            let tempAiFrameUrl = '';
            let tempUserFrameUrl = '';
            let isContactDeleteMode = false;
            let contactsToDelete = new Set();
            let chatHistories = JSON.parse(localStorage.getItem('chatHistories')) || {};
            // --- 新增函数：AI联系人评论朋友圈 ---
async function simulateAIComments(postElement, postText) {
    const userName = document.getElementById('profile-page-name').textContent;

    for (const contact of initialChats) {
        // 每个联系人都有一定几率（例如40%）进行评论
        if (Math.random() < 0.4) {
            // 等待一个随机的延迟，让评论看起来更自然
            const delay = Math.random() * 8000 + 2000; // 2到10秒
            await new Promise(resolve => setTimeout(resolve, delay));

            const systemPrompt = `你是 ${contact.name}。你的性格设定是：“${contact.persona}”。你的朋友 "${userName}" 刚刚发表了一条朋友圈，内容是：“${postText}”。请你用符合自己性格的、简短的口吻，为这条朋友圈写一条评论。`;

            const commentText = await window.callAI([{ role: 'system', content: systemPrompt }]);

            if (commentText && !commentText.startsWith('(AI调用出错')) {
                let commentsEl = postElement.querySelector('.moment-comments-list');
                if (!commentsEl) {
                    commentsEl = document.createElement('div');
                    commentsEl.className = 'moment-comments-list';
                    postElement.querySelector('.moment-interactions').appendChild(commentsEl);
                }
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `<span class="comment-author">${contact.name}: </span><span>${commentText}</span>`;
                commentsEl.appendChild(commentItem);
            }
        }
    }
}
// --- 粘贴这段全新的代码来替换旧的函数 ---
async function generateAndPostAIMoment(contact, isBatch = false) {
    if (!isBatch) {
        showAlert(`${contact.name} 正在编辑朋友圈...`);
    }

    // 智能解析函数：尝试从AI可能返回的杂乱文本中提取出有效的JSON数据
    const extractJSON = (text) => {
        try {
            // 优先尝试直接解析
            return JSON.parse(text);
        } catch (e) {
            // 如果直接解析失败，就用正则表达式寻找被代码块包裹的JSON
            const match = text.match(/```json\s*([\s\S]*?)\s*```/);
            if (match && match) {
                try {
                    return JSON.parse(match);
                } catch (e2) { return null; }
            }
            // 如果还是失败，就寻找第一个 '{' 到最后一个 '}' 的内容
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');
            if (firstBrace > -1 && lastBrace > firstBrace) {
                try {
                    return JSON.parse(text.substring(firstBrace, lastBrace + 1));
                } catch (e3) { return null; }
            }
        }
        return null; // 如果所有方法都失败了，返回null
    };

    const systemPrompt = `你是 ${contact.name}。你的性格设定是：“${contact.persona}”。你的任务是创建一条社交动态。你有两种动态类型可选: "text" 或 "image"。- 如果选择 "text", 请提供一段符合你性格的简短文字。- 如果选择 "image", 请提供一段简短的文字说明(caption)，以及一个用于图片搜索的简单英文短语(image_description)。同时，请根据你的性格设定，提供一个最合理的IP属地(location)。你必须只回复一个JSON对象，不要有任何其他文字。文字动态的格式: { "type": "text", "content": "动态文字", "location": "IP属地" } 图片动态的格式: { "type": "image", "caption": "图片说明文字", "image_description": "a cat is sleeping", "location": "IP属地" } 现在，请创建你的动态。`;
    
    const aiResponse = await window.callAI([{ role: 'system', content: systemPrompt }]);
    
    // 使用我们新的智能解析函数
    const postData = extractJSON(aiResponse);

    // 只有当成功解析出数据时，才继续执行
    if (postData) {
        let postContentHTML = '';
        let previewText = '';
        
        // 如果AI忘记提供IP地址，我们就再问一次，确保万无一失
        if (!postData.location) {
            const locationPrompt = `基于这个性格设定：“${contact.persona}”，请只提供一个最合理的IP属地，不要任何多余的文字。`;
            postData.location = await window.callAI([{ role: 'system', content: locationPrompt }]);
        }

        if (postData.type === 'image' && postData.image_description) {
            const imageUrl = `https://source.unsplash.com/random/240x240/?${encodeURIComponent(postData.image_description)}`;
            postContentHTML = `
                <div class="moment-text">${(postData.caption || '').replace(/\n/g, '<br>')}</div>
                <div class="moment-media"><img src="${imageUrl}" alt="AI generated image"></div>
            `;
            previewText = `[图片] ${postData.caption || postData.image_description}`;
        } else {
            postContentHTML = `<div class="moment-text">${(postData.content || '...').replace(/\n/g, '<br>')}</div>`;
            previewText = `[朋友圈] ${postData.content || '...'}`;
        }

        const newPost = document.createElement('div');
        newPost.className = 'moment-post';
        newPost.dataset.authorId = contact.id;
        newPost.dataset.authorName = contact.name;

        // 替换后的新代码片段
newPost.innerHTML = `
    <img src="${contact.avatar}" alt="Author Avatar" class="moment-avatar">
    <div class="moment-content">
        <div class="moment-body">
            <div class="moment-author">${contact.name}</div>
            ${postContentHTML}
            <div class="moment-meta" style="display: block;">
                 <div class="moment-time">刚刚</div>
                 ${postData.location ? `<div class="moment-location">IP属地: ${postData.location.trim()}</div>` : ''}
            </div>
            <span class="moment-actions-btn">...</span>
        </div>
          <div class="moment-interactions"></div>
            </div>`;
         document.getElementById('moments-feed').prepend(newPost);

                    if (!isBatch) {
                const finalPreview = previewText.substring(0, 20) + '...';

                // --- 核心修复逻辑开始 ---
                // 1. 从本地存储加载一份“干净”的数据，而不是直接修改内存中可能被污染的数据
                let cleanChats = JSON.parse(localStorage.getItem('wechatInitialChats') || '[]');
                let chatEntry = cleanChats.find(c => c.id === contact.id);

                if (chatEntry) {
                    // 2. 如果找到了，只更新它的朋友圈预览文本
                    chatEntry.preview = finalPreview;
                } else {
                    // 如果没找到（例如第一次发朋友圈），创建一个新的聊天条目
                    const contactFromMemory = addressBookContacts.find(c => c.id === contact.id) || contact;
                    chatEntry = { ...contactFromMemory, preview: finalPreview, time: '刚刚' };
                    cleanChats.unshift(chatEntry);
                }
                
                // 3. 将这份修改好的、干净的数据保存回去
                localStorage.setItem('wechatInitialChats', JSON.stringify(cleanChats));
                // --- 核心修复逻辑结束 ---
                
                // 4. 现在本地存储是安全的了，我们再重新加载数据来更新整个界面
                loadContactsData().then(() => {
                    // 确保在UI更新后再弹出通知
                     n({ ...contact, preview: finalPreview });
                });
            }
    } else {
        // 如果解析失败，弹窗告诉用户AI返回了什么，方便调试
        console.error(`为 ${contact.name} 生成朋友圈失败，原因: AI未返回有效JSON。`, "原始回复:", aiResponse);
        if (!isBatch) {
            alert(`为 ${contact.name} 生成朋友圈失败了。\n\nAI返回的原始信息是：\n${aiResponse}`);
        }
    }
}
// --- 新增函数：AI回复用户的评论 ---
async function triggerAIReply(postElement, userCommentText) {
    const authorId = postElement.dataset.authorId;
    const authorName = postElement.dataset.authorName;

    // 如果没有作者ID，或者作者是用户自己，则不回复
    if (!authorId || authorId === 'user_profile') {
        return;
    }

    const aiContact = initialChats.find(c => c.id === authorId);
    if (!aiContact) return; // 找不到AI作者信息

    const postText = postElement.querySelector('.moment-text').innerText;
    const userName = document.getElementById('profile-page-name').textContent;

    // 延迟一段时间再回复，显得更真实
    await new Promise(resolve => setTimeout(resolve, Math.random() * 4000 + 1500));

    const systemPrompt = `你是 ${authorName}。你的性格设定是：“${aiContact.persona}”。你认识的 "${userName}" 刚刚评论了你的朋友圈，你和{{user}}的关系是什么：“？”。
你的朋友圈内容是：“${postText}”
TA的评论是：“${userCommentText}”
请根据你的性格，对这条评论进行一个简短的回复。`;

    const replyText = await window.callAI([{ role: 'system', content: systemPrompt }]);

    if (replyText && !replyText.startsWith('(AI调用出错')) {
        let commentsEl = postElement.querySelector('.moment-comments-list');
        if (commentsEl) {
            const replyItem = document.createElement('div');
            replyItem.className = 'comment-item';
            replyItem.innerHTML = `<span class="comment-author">${authorName}: </span><span>${replyText}</span>`;
            commentsEl.appendChild(replyItem);
        }
    }
}
            // 在这里定义一个全局变量，用来记录是否已经自动生成过朋友圈
let hasGeneratedInitialMoments = false;

function switchPage(pageId) {
    if (!pageId) return;
    activeChatPageId = pageId;
    if (proactiveChatTimer && pageId !== 'ai-chat-page') {
        clearInterval(proactiveChatTimer);
        proactiveChatTimer = null;
    }
    pages.forEach(page => page.classList.toggle('active', page.id === pageId));
    wechatContainer.querySelectorAll('.nav-item').forEach(nav => {
        nav.classList.toggle('active', nav.dataset.page === pageId);
    });
    if (backToHomeBtn) {
        const mainPages = ['chat-list-page', 'discover-page', 'contacts-page', 'profile-page'];
        backToHomeBtn.style.display = mainPages.includes(pageId) ? 'flex' : 'none';
    }

    // 【⭐修改点(2/2) 在这里新增下面的代码块⭐】
    // 当切换到“发现”（朋友圈）页面时，触发下面的逻辑
    if (pageId === 'discover-page' && !hasGeneratedInitialMoments) {
        // 检查通讯录里是否有AI联系人
        if (addressBookContacts.length > 0) {
            // 找到朋友圈的容器，并检查里面是否有内容
            const momentsFeed = document.getElementById('moments-feed');
            if (momentsFeed && momentsFeed.children.length === 0) {
                
                // 显示一个提示，告诉用户正在做什么
                showAlert('AI朋友们正在赶来发朋友圈...');
                
                // 这个函数就是命令所有AI去生成朋友圈，原本只有点击按钮时才会触发
                const momentGenerationPromises = addressBookContacts.map(contact => 
                    generateAndPostAIMoment(contact, true)
                );

                // 等待所有AI都“发完”朋友圈
                Promise.all(momentGenerationPromises).then(() => {
                    showAlert('朋友圈已更新！');
                    // 标记为已经生成过，防止每次都重复生成，浪费资源
                    hasGeneratedInitialMoments = true; 
                });
            }
        }
    }
}
            wechatContainer.switchPage = switchPage;

            function showAlert(message) {
                alertPopup.textContent = message;
                alertPopup.classList.add('show');
                setTimeout(() => alertPopup.classList.remove('show'), 1500);
            }

            const timeEl = wechatContainer.querySelector('.status-bar-time');
            const iconsEl = wechatContainer.querySelector('.status-bar-icons');
            const localTimeEl = wechatContainer.querySelector('.chat-time-local');
            const localIconsEl = wechatContainer.querySelector('.chat-icons-local');
            function updateStatusBar() {
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if(timeEl) timeEl.textContent = timeString;
                if(localTimeEl) localTimeEl.textContent = timeString;
                const renderBattery = (level, container) => {
                    if (!container) return;
                    container.innerHTML = `<div class="status-bar-icons-container"><span class="heart-battery-text">${level}%</span><div class="heart-battery"><div class="heart-battery-level" style="height: ${level}%;"></div></div></div>`;
                };
                if (navigator.getBattery) {
                    navigator.getBattery().then(battery => {
                        const level = Math.floor(battery.level * 100);
                        renderBattery(level, iconsEl);
                        renderBattery(level, localIconsEl);
                    });
                } else {
                    renderBattery(100, iconsEl);
                    renderBattery(100, localIconsEl);
                }
            }
            updateStatusBar();
            setInterval(updateStatusBar, 30000);

            const bottomNav = wechatContainer.querySelector('#bottom-nav');
            const initialNavItems = [
                { page: 'chat-list-page', text: '消息', badge: 2 }, 
                { page: 'contacts-page', text: '通讯录' },
                { page: 'discover-page', text: '发现', active: true }, 
                { page: 'profile-page', text: '我的' }
            ];
            if (bottomNav) {
                bottomNav.innerHTML = '';
                initialNavItems.forEach(item => {
                    const navItem = document.createElement('div');
                    navItem.className = `nav-item ${item.active ? 'active' : ''}`;
                    navItem.dataset.page = item.page;
                    navItem.innerHTML = `<img src="https://i.imgs.ovh/2025/08/22/GzPed.png" class="icon nav-icon-img" alt="icon"><span>${item.text}</span>${item.badge ? `<span class="nav-badge">${item.badge}</span>` : ''}`;
                    navItem.addEventListener('click', () => switchPage(item.page));
                    bottomNav.appendChild(navItem);
                });
            }
            
            let initialChats = [];
            let addressBookContacts = [];
            window.getWeChatContacts = () => addressBookContacts;
            const contactsList = wechatContainer.querySelector('#contacts-list');
            const groupsList = wechatContainer.querySelector('#groups-list');

                        function createChatItem(chat) {
    const wrapper = document.createElement('div');
    wrapper.className = 'chat-item-wrapper';
    wrapper.dataset.id = chat.id;
    const chatItemDiv = document.createElement('div');
    chatItemDiv.className = `chat-item ${chat.pinned ? 'pinned' : ''}`;

    // 修改点：使用了 getAvatarUrl(chat.avatar)
    chatItemDiv.innerHTML = `<div class="chat-avatar"><img src="${getAvatarUrl(chat.avatar)}" alt="avatar"></div><div class="chat-details"><div class="chat-name">${chat.name}</div><div class="chat-preview">${chat.preview}</div></div><div class="chat-info"><div class="chat-time">${chat.time}</div>${chat.unread ? `<div class="unread-badge">${chat.unread}</div>` : ''}</div>`;

    const swipeActionsDiv = document.createElement('div');
    swipeActionsDiv.className = 'swipe-actions';
    swipeActionsDiv.innerHTML = `<button class="action-pin" data-action="${chat.pinned ? 'unpin' : 'pin'}">${chat.pinned ? '取消置顶' : '置顶'}</button><button class="action-delete" data-action="delete">删除</button>`;
    wrapper.append(chatItemDiv, swipeActionsDiv);
    chatItemDiv.addEventListener('click', () => openChat(chat));
    addSwipeFunctionality(wrapper);
    return wrapper;
}

                function renderChatList() {
                if (!contactsList || !groupsList) return;
                contactsList.innerHTML = ''; 
                groupsList.innerHTML = '';
                const contacts = initialChats.filter(c => c.type === 'contact').sort((a, b) => (b.pinned || false) - (a.pinned || false));
                const groups = initialChats.filter(c => c.type === 'group').sort((a, b) => (b.pinned || false) - (a.pinned || false));
                contacts.forEach(chat => contactsList.appendChild(createChatItem(chat)));
                groups.forEach(chat => groupsList.appendChild(createChatItem(chat)));
            }
            
            const resetActiveSwipeItem = () => { 
                const activeItem = wechatContainer.querySelector('.chat-item.swiped'); 
                if (activeItem) { 
                    activeItem.style.transform = 'translateX(0)'; 
                    activeItem.classList.remove('swiped'); 
                } 
            };

            function addSwipeFunctionality(wrapper) {
                let startX = 0, currentX = 0, isDragging = false;
                const item = wrapper.querySelector('.chat-item');
                const swipeThreshold = -160;
                item.addEventListener('touchstart', e => {
                    if (item.classList.contains('swiped')) return;
                    resetActiveSwipeItem();
                    startX = e.touches[0].clientX;
                    isDragging = true;
                    item.style.transition = 'none';
                }, { passive: true });
                item.addEventListener('touchmove', e => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX - startX;
                    if (currentX < 0) item.style.transform = `translateX(${currentX}px)`;
                }, { passive: true });
                item.addEventListener('touchend', () => {
                    if (!isDragging) return;
                    isDragging = false;
                    item.style.transition = 'transform 0.3s ease';
                    if (currentX < -60) {
                        item.style.transform = `translateX(${swipeThreshold}px)`;
                        item.classList.add('swiped');
                    } else {
                        item.style.transform = 'translateX(0)';
                        item.classList.remove('swiped');
                    }
                    currentX = 0;
                });
                wrapper.querySelector('.swipe-actions').addEventListener('click', e => { 
                    const button = e.target.closest('button');
                    if (!button) return;
                    const action = button.dataset.action;
                    const chatId = wrapper.dataset.id;
                    const chat = initialChats.find(c => c.id === chatId);
                    if (action === 'pin' || action === 'unpin') {
                        chat.pinned = !chat.pinned;
                        showAlert(chat.pinned ? '已置顶' : '已取消置顶');
                        renderChatList();
                    } 
                        else if (action === 'delete') {
                    // 只从消息列表数组中移除，不影响通讯录
                    initialChats = initialChats.filter(c => c.id !== chatId);
                    showAlert('会话已删除');
                    saveContactsData(); // 保存更改
                    renderChatList(); // 重新渲染消息列表
                   // 注意：我们不再调用 displayContacts()，因为通讯录没有变化
                    }
                    resetActiveSwipeItem();
                });
            }
            
            const contactListContainer = wechatContainer.querySelector('#contact-list-container');
            function renderContactsPage(contactsToRender) {
    contactListContainer.innerHTML = '';

    const createContactItem = (contact) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'contact-item';
        // 添加 data-id 属性，非常重要！
        itemEl.dataset.id = contact.id;
        
        // 在HTML中添加一个隐藏的复选框
        itemEl.innerHTML = `
            <input type="checkbox" class="contact-delete-checkbox hidden" style="width: 20px; height: 20px; margin-right: 10px;">
            <img src="${getAvatarUrl(contact.avatar)}" alt="">
            <span>${contact.name}</span>
        `;

        let pressTimer;
        // 点击事件处理
        // 点击事件处理
itemEl.addEventListener('click', () => {
    if (isContactDeleteMode) {
        const checkbox = itemEl.querySelector('.contact-delete-checkbox');
        checkbox.checked = !checkbox.checked;
        if (checkbox.checked) {
            contactsToDelete.add(contact.id);
            itemEl.style.backgroundColor = '#fee2e2';
        } else {
            contactsToDelete.delete(contact.id);
            itemEl.style.backgroundColor = '';
        }
        document.getElementById('delete-contacts-btn').textContent = `删除(${contactsToDelete.size})`;
    } else {
        // 【最终修复逻辑】
        // 1. 在消息列表里查找这个联系人
        let chatEntry = initialChats.find(c => c.id === contact.id);
        
        // 2. 如果没找到，说明是第一次从通讯录发起聊天
        if (!chatEntry) {
            // 创建一个新的消息条目对象
            chatEntry = { ...contact, preview: `// 在这里定义一个全局变量，用来记录是否已经自动生成过朋友圈
let hasGeneratedInitialMoments = false;

function switchPage(pageId) {
    if (!pageId) return;
    activeChatPageId = pageId;
    if (proactiveChatTimer && pageId !== 'ai-chat-page') {
        clearInterval(proactiveChatTimer);
        proactiveChatTimer = null;
    }
    pages.forEach(page => page.classList.toggle('active', page.id === pageId));
    wechatContainer.querySelectorAll('.nav-item').forEach(nav => {
        nav.classList.toggle('active', nav.dataset.page === pageId);
    });
    if (backToHomeBtn) {
        const mainPages = ['chat-list-page', 'discover-page', 'contacts-page', 'profile-page'];
        backToHomeBtn.style.display = mainPages.includes(pageId) ? 'flex' : 'none';
    }

    // 【⭐修改点(2/2) 在这里新增下面的代码块⭐】
    // 当切换到“发现”（朋友圈）页面时，触发下面的逻辑
    if (pageId === 'discover-page' && !hasGeneratedInitialMoments) {
        // 检查通讯录里是否有AI联系人
        if (addressBookContacts.length > 0) {
            // 找到朋友圈的容器，并检查里面是否有内容
            const momentsFeed = document.getElementById('moments-feed');
            if (momentsFeed && momentsFeed.children.length === 0) {
                
                // 显示一个提示，告诉用户正在做什么
                showAlert('AI朋友们正在赶来发朋友圈...');
                
                // 这个函数就是命令所有AI去生成朋友圈，原本只有点击按钮时才会触发
                const momentGenerationPromises = addressBookContacts.map(contact => 
                    generateAndPostAIMoment(contact, true)
                );

                // 等待所有AI都“发完”朋友圈
                Promise.all(momentGenerationPromises).then(() => {
                    showAlert('朋友圈已更新！');
                    // 标记为已经生成过，防止每次都重复生成，浪费资源
                    hasGeneratedInitialMoments = true; 
                });
            }
        }
    }
}`, time: '刚刚' };
            // 把它加到消息列表数据的最前面
            initialChats.unshift(chatEntry);
            // 刷新消息列表的显示
            renderChatList();
            // 保存这个变化
            saveContactsData();
        }
        
        // 3. 打开聊天界面
        openChat(chatEntry);
    }
});
        // 长按事件处理 (进入删除模式)
        itemEl.addEventListener('touchstart', (e) => {
            pressTimer = setTimeout(() => {
                if (!isContactDeleteMode) { // 只有在非删除模式下才能触发
                    e.preventDefault();
                    enterContactDeleteMode(contact.id);
                }
            }, 600); // 长按600毫秒
        });

        const clearPressTimer = () => clearTimeout(pressTimer);
        itemEl.addEventListener('touchend', clearPressTimer);
        itemEl.addEventListener('touchmove', clearPressTimer);

        return itemEl;
    };

    let contactsByGroup = {};
    if (currentSortOrder === 'pinyin') {
        contactsByGroup = contactsToRender.reduce((acc, contact) => {
            const firstLetter = (contact.pinyin || ' ').charAt(0).toUpperCase();
            (acc[firstLetter] = acc[firstLetter] || []).push(contact);
            return acc;
        }, {});
    }
    if (Object.keys(contactsByGroup).length > 0) {
        Object.keys(contactsByGroup).sort().forEach(group => {
            const groupEl = document.createElement('div');
            groupEl.className = 'contact-group';
            groupEl.innerHTML = `<div class="contact-group-header">${group}</div>`;
            contactsByGroup[group].forEach(contact => groupEl.appendChild(createContactItem(contact)));
            contactListContainer.appendChild(groupEl);
        });
    } else {
        contactsToRender.forEach(contact => contactListContainer.appendChild(createContactItem(contact)));
    }
}
 function enterContactDeleteMode(firstContactId) {
    isContactDeleteMode = true;
    contactsToDelete.clear();
    contactsToDelete.add(firstContactId);

    // 切换顶部按钮的显示状态
    document.getElementById('sort-contacts-btn').classList.add('hidden');
    document.getElementById('delete-contacts-btn').classList.remove('hidden');
    document.getElementById('cancel-delete-btn').classList.remove('hidden');
    document.getElementById('delete-contacts-btn').textContent = '删除(1)';

    // 显示所有复选框并高亮第一个选中的
    contactListContainer.querySelectorAll('.contact-item').forEach(item => {
        item.querySelector('.contact-delete-checkbox').classList.remove('hidden');
        if (item.dataset.id === firstContactId) {
            item.querySelector('.contact-delete-checkbox').checked = true;
            item.style.backgroundColor = '#fee2e2';
        }
    });
}

function exitContactDeleteMode() {
    isContactDeleteMode = false;
    contactsToDelete.clear();

    // 恢复顶部按钮
    document.getElementById('sort-contacts-btn').classList.remove('hidden');
    document.getElementById('delete-contacts-btn').classList.add('hidden');
    document.getElementById('cancel-delete-btn').classList.add('hidden');

    // 隐藏所有复选框并取消高亮
    contactListContainer.querySelectorAll('.contact-item').forEach(item => {
        item.querySelector('.contact-delete-checkbox').classList.add('hidden');
        item.querySelector('.contact-delete-checkbox').checked = false;
        item.style.backgroundColor = '';
    });
}

function deleteSelectedContacts() {
    if (contactsToDelete.size === 0) {
        showAlert('请选择要删除的联系人');
        return;
    }

    if (confirm(`确定要永久删除这 ${contactsToDelete.size} 位联系人吗？此操作无法撤销。`)) {
        // 从两个数据源中同时删除
        initialChats = initialChats.filter(c => !contactsToDelete.has(c.id));
        addressBookContacts = addressBookContacts.filter(c => !contactsToDelete.has(c.id));
        
        saveContactsData(); // **自动保存**
        
        showAlert('联系人已删除');
        exitContactDeleteMode();
        renderChatList(); // 刷新消息列表
        displayContacts(); // 刷新通讯录
    }
}           
            const addContactModal = wechatContainer.querySelector('#add-contact-modal');
           // 为新按钮绑定点击事件
document.getElementById('delete-contacts-btn').addEventListener('click', deleteSelectedContacts);
document.getElementById('cancel-delete-btn').addEventListener('click', exitContactDeleteMode);
            wechatContainer.querySelector('#add-heart-btn')?.addEventListener('click', () => { addContactModal.style.display = 'flex'; });
            wechatContainer.querySelector('#modal-add-cancel').addEventListener('click', () => { addContactModal.style.display = 'none'; });
            wechatContainer.querySelector('#modal-add-confirm').addEventListener('click', () => {
                const nameInput = wechatContainer.querySelector('#add-contact-name');
                const name = nameInput.value.trim();
                if (!name) { showAlert('请输入名称'); return; }
                const type = wechatContainer.querySelector('input[name="contact-type"]:checked').value;
                const creationTime = Date.now();
                const newContact = { id: `new${creationTime}`, type, avatar: `https://placehold.co/150x150/EFEFEF/333333?text=?`, name, preview: '我们已经是好友了', time: '刚刚', pinned: false, pinyin: name.toLowerCase(), createdAt: creationTime, avatarFrame: '', linkedWorldBookIds: [] };
                initialChats.unshift(newContact);
// 只有当类型是'contact'时，才添加到通讯录数据源
if (type === 'contact') {
    addressBookContacts.push(newContact);
}
// 无论如何都重新渲染两个列表，以确保界面同步
renderChatList();
displayContacts(); 
                nameInput.value = '';
                addContactModal.style.display = 'none';
                showAlert('添加成功!');
                saveContactsData();
              });
            
            const aiChatPage = wechatContainer.querySelector('#ai-chat-page');
            const chatMessagesContainer = wechatContainer.querySelector('#chat-messages-container');
            const messageInput = wechatContainer.querySelector('#chat-message-input');
            const sendBtn = wechatContainer.querySelector('#send-message-btn');
                        // =======================================================
            // =========== 核心聊天逻辑（已修复问题1, 2, 3） ===========
            // =======================================================

            // 【针对问题2的提醒】: 下面的`currentChatPartner`变量非常关键。它就像一个“对话锁定器”。
            // 每次你点击一个联系人打开聊天窗口时，`openChat`函数就会把这个联系人的所有信息（ID, 名字, 头像等）
            // 保存到`currentChatPartner`里。之后，所有发送消息、AI回复的操作，都会认准这个“锁”里的人。
            // 这样就保证了你给A发消息，回复的也绝对是A，不会窜到B那里去。
                        function openChat(chatData) {
                // 确保我们操作的是内存中的聊天对象
                const chatObjectInMemory = initialChats.find(c => c.id === chatData.id);
                currentChatPartner = chatObjectInMemory || JSON.parse(JSON.stringify(chatData));

                // 核心逻辑：为每个联系人初始化独立的设置和用户配置
                if (!currentChatPartner.userProfile) {
                    currentChatPartner.userProfile = JSON.parse(JSON.stringify(defaultUserSettings));
                }
                 if (!currentChatPartner.chatSettings) {
                    // 如果该联系人没有独立的设置，就为他创建一个默认的
                    currentChatPartner.chatSettings = { timePerception: false, offlineMode: false, memoryRounds: 5, proactiveChat: false, proactiveFrequency: 'medium', wallpaper: '', topBarColor: '', bottomBarColor: '' };
                }

                activeChatUserProfile = currentChatPartner.userProfile;
                if (!currentChatPartner.linkedWorldBookIds) currentChatPartner.linkedWorldBookIds = [];
                
                wechatContainer.querySelector('#chat-contact-name').textContent = chatData.name;
                const isOnline = Math.random() > 0.3;
                const statusEl = wechatContainer.querySelector('#chat-contact-status');
                statusEl.innerHTML = `<span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>${isOnline ? '在线' : '离线'}`;
                
                // 加载独立的聊天记录
                chatMessagesContainer.innerHTML = chatHistories[chatData.id] || '';
                if (!chatHistories[chatData.id]) {
                    createMessageBubble(`你好呀，我是 ${chatData.name}，很高兴认识你！`, 'ai');
                }

                // 强制刷新所有气泡的头像，确保它们显示正确
                chatMessagesContainer.querySelectorAll('.message-bubble').forEach(bubble => {
                    const avatarImg = bubble.querySelector('.avatar');
                    const wrapper = bubble.querySelector('.chat-avatar-wrapper');
                    
                    if (bubble.classList.contains('ai-message')) {
                        avatarImg.src = getAvatarUrl(currentChatPartner.avatar);
                        wrapper.style.backgroundImage = `url('${currentChatPartner.avatarFrame || ''}')`;
                    } else if (bubble.classList.contains('user-message')) {
                        avatarImg.src = getAvatarUrl(activeChatUserProfile.avatar);
                        wrapper.style.backgroundImage = `url('${activeChatUserProfile.avatarFrame || ''}')`;
                    }
                });

                // 应用这个聊天专属的外观
                applyChatAppearance(currentChatPartner.chatSettings);

                switchPage('ai-chat-page');
                setupProactiveChat();
            }
            function createMessageBubble(text, sender, isThinking = false) {
                const wrapper = document.createElement('div');
                wrapper.className = `message-bubble ${sender === 'user' ? 'user-message' : 'ai-message'}`;
                if (isThinking) {
                    wrapper.id = 'thinking-bubble';
                }
                
                // 核心修正：确保从 activeChatUserProfile 获取用户头像和头像框
                const avatarUrl = sender === 'user' ? getAvatarUrl(activeChatUserProfile.avatar) : getAvatarUrl(currentChatPartner.avatar);
                const frameUrl = sender === 'user' ? activeChatUserProfile.avatarFrame : (currentChatPartner.avatarFrame || '');
                
                wrapper.innerHTML = `
                    <div class="chat-avatar-wrapper" style="background-image: url('${frameUrl}')">
                        <img src="${avatarUrl}" class="avatar" alt="avatar">
                    </div>
                    <div class="message-content">
                        <div class="message-text">${text}</div>
                    </div>
                `;
                chatMessagesContainer.appendChild(wrapper);
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                return wrapper;
            }

            function saveCurrentChatHistory() {
                if (currentChatPartner && currentChatPartner.id) {
                    try {
                        chatHistories[currentChatPartner.id] = chatMessagesContainer.innerHTML;
                        localStorage.setItem('chatHistories', JSON.stringify(chatHistories));
                    } catch (e) {
                        console.error("无法保存聊天记录（可能因为图片太大导致存储超限）：", e);
                    }
                }
            }
            
            function n(contact) {
                if (!contact || document.getElementById('ai-chat-page').classList.contains('active')) {
                    return;
                }
                let popup = document.getElementById('ai-notification-popup'); 
                const avatar = popup.querySelector('#notification-avatar');
                const text = popup.querySelector('p');

                if (contact.avatar) {
                    avatar.src = getAvatarUrl(contact.avatar);
                }
                text.textContent = '你有条好友新发来的消息';
                const newPopup = popup.cloneNode(true);
                popup.parentNode.replaceChild(newPopup, popup);
                popup = newPopup; 
                popup.addEventListener('click', () => {
                    openChat(contact);
                    popup.classList.remove('show');
                }, { once: true });
                popup.classList.add('show');
                setTimeout(() => {
                    popup.classList.remove('show');
                }, 4000);
            }

            async function sendUserMessage() {
                const messageText = messageInput.value.trim();
                if (messageText === '') return;

                createMessageBubble(messageText, 'user');
                // 【修复方案 #3】: 先把“正在输入”的提示气泡显示出来
                const thinkingBubble = createMessageBubble('对方正在输入中...', 'ai', true);
                messageInput.value = '';

                const memoryRounds = parseInt(chatSettings.memoryRounds, 10) || 0;
                let messages = [];

                // --- 这是你要求的全新聊天模式逻辑整合 ---
                const beijingTime = new Date().toLocaleString("zh-CN", { timeZone: "Asia/Shanghai", hour12: false });
                let worldBookContext = '';
                 if (currentChatPartner.linkedWorldBookIds && currentChatPartner.linkedWorldBookIds.length > 0) {
                    worldBookContext += "你必须遵循以下世界书中的背景设定：\n";
                    currentChatPartner.linkedWorldBookIds.forEach(id => {
                        const entry = worldBookEntries.find(e => e.id === id);
                        if (entry) worldBookContext += `\n--- START OF [${entry.name}] ---\n${entry.content}\n--- END OF [${entry.name}] ---\n`;
                    });
                }
                
                const commonInstructions = `# 发送图片的能力\n- 你可以发送“文字描述的图片”，格式为：\`{"type": "ai_image", "description": "..."}\`。\n# 发送语音的能力\n- 你可以发送“模拟语音消息”，格式为：\`{"type": "voice_message", "content": "..."}\`。\n# 转账能力\n- 你可以给用户转账，格式为：\`{"type": "transfer", "amount": 520, "note": "..."}\`。\n# 撤回消息的能力 (新功能)\n- 你可以“撤回”消息来表现角色的犹豫或真心话。\n- 使用方法：\`{"type": "retractable_message", "content": "想说又不敢说的话", "delay": 2000}\`\n- "content": 是先显示再撤回的“真心话”。\n- "delay": 是显示时长(毫秒)，建议 1500 到 5000。\n- 请仅在剧情或情感需要时使用此功能。`;

                                          let systemPrompt = `你是${currentChatPartner.name}。你的角色设定是：“${currentChatPartner.persona}”。

# 对话背景
- **当前时间是：${beijingTime}**。
- 你必须遵循以下世界书中的设定：\n${worldBookContext}
- 对话者的设定：${activeChatUserProfile.persona || '一个普通人'}

# 重要规则
1.  **聊天模式**: 你正在通过短信等虚拟通讯方式进行线上聊天。你的回复必须是简短的口语化风格。
2.  **多条消息**: 你可以根据心情，一次性回复1-9条消息，以模拟真人的聊天习惯。
3.  **禁止内容**: 你的回复绝对不能包含任何旁白、动作描写或心理描写。
4.  **表情包/图片**: 你可以发送表情包或图片，但链接必须从下面的【世界书】内容中选择，并作为一条完整的消息发送，禁止拆分链接。严禁自己随机生成链接！
5.  **消息拆分规则**:
    - 你的完整回复必须被拆分成多个短句。
    - 每个短句作为一条独立消息发送。
    - **【硬性规定】** 每一条独立消息（聊天气泡）的长度【绝对不能超过20个字符】。
    - 超过20个字符的句子必须被拆分成更短的几条消息。

# 特殊功能格式 (必须严格遵守)
- **发送图片**: \`{"type": "ai_image", "description": "这里是图片的文字描述"}\`
- **发送语音**: \`{"type": "voice_message", "content": "这里是模拟的语音内容"}\`
- **发起转账**: \`{"type": "transfer", "amount": 520, "note": "转账说明"}\`
- **撤回消息**: \`{"type": "retractable_message", "content": "先发出后撤回的话", "delay": 2000}\`

# 输出格式
你的所有回复【必须】打包成一个JSON数组的格式返回，数组中的每个字符串就是一条消息。
【正确格式示例】:
["你好", "找我有什么事吗？", "我今天有点忙。"]

【绝对禁止的错误格式】:
- "你好，找我有什么事吗？我今天有点忙。" (错误：未拆分成长句)
- ["我今天真的非常非常忙没时间理你"] (错误：单条消息超过20字符)
- "第一条消息：你好\\n第二条消息：有事吗" (错误：不是JSON数组格式)
`;

                if (chatSettings.offlineMode) {
                     systemPrompt = `重要指示：你现在必须以{{char}}第三人称小说模式进行回复。你的回复必须是长段的剧情描写。不要以聊天的方式回应，而是续写故事，回复的字数在900字以上。`;
                }
                
                messages.push({ role: 'system', content: systemPrompt });

                if (memoryRounds > 0) {
                    const allBubbles = Array.from(chatMessagesContainer.querySelectorAll('.message-bubble'));
                    const historyBubbles = allBubbles.slice(-1 - (memoryRounds * 2), -1); 
                    historyBubbles.forEach(bubble => {
                        const role = bubble.classList.contains('user-message') ? 'user' : 'assistant';
                        const content = bubble.querySelector('.message-text').innerText;
                        messages.push({ role: role, content: content });
                    });
                }
                messages.push({ role: 'user', content: messageText });
                
                const aiReplyString = await callAI(messages);

                // 【修复方案 #3】: 收到回复后，立刻、马上、第一时间移除“正在输入”的气泡！
                if (thinkingBubble) {
                    thinkingBubble.remove();
                }

                // --- 这是处理新聊天逻辑返回内容的全新代码 ---
                try {
                    // 尝试将AI返回的文本解析成JSON数组
                    const replyArray = JSON.parse(aiReplyString);
                    if (Array.isArray(replyArray)) {
                        for (const message of replyArray) {
                            if (typeof message === 'string') {
                                createMessageBubble(message, 'ai');
                            } else if (typeof message === 'object' && message.type) {
                                // 处理特殊消息类型
                                switch (message.type) {
                                    case 'ai_image':
                                        const imageUrl = `https://source.unsplash.com/random/400x300/?${encodeURIComponent(message.description)}`;
                                        createMessageBubble(`<img src="${imageUrl}" class="rounded-md" alt="${message.description}">`, 'ai');
                                        break;
                                    case 'voice_message':
                                        createMessageBubble(`[语音] ${message.content}`, 'ai');
                                        break;
                                    case 'transfer':
                                        createMessageBubble(`[转账] ${message.amount}元 - ${message.note}`, 'ai');
                                        break;
                                    case 'retractable_message':
                                        const retractableBubble = createMessageBubble(message.content, 'ai');
                                        setTimeout(() => {
                                            retractableBubble.querySelector('.message-text').textContent = '[对方撤回了一条消息]';
                                            retractableBubble.classList.add('opacity-50');
                                            saveCurrentChatHistory();
                                        }, message.delay || 2000);
                                        break;
                                }
                            }
                            // 每条消息之间增加一点点延迟，看起来更真实
                            await new Promise(res => setTimeout(res, Math.random() * 500 + 300));
                        }
                    }
                } catch (e) {
                    // 如果JSON解析失败，说明AI可能返回了普通的文本（比如在剧情模式下）
                    createMessageBubble(aiReplyString.replace(/\n/g, '<br>'), 'ai');
                }

                saveCurrentChatHistory();
                n(currentChatPartner); // 弹出新消息通知
            }
            sendBtn.addEventListener('click', sendUserMessage);
            messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendUserMessage(); });
            document.getElementById('ai-chat-back-btn').addEventListener('click', () => {
                             saveCurrentChatHistory();
                                switchPage('chat-list-page');
                        });
                       aiChatPage.querySelector('.chat-settings-icon').addEventListener('click', () => {
                // AI设置部分不变
                document.getElementById('chat-ai-persona-input').value = currentChatPartner.persona || '';
                document.getElementById('chat-ai-frame-url').value = currentChatPartner.avatarFrame || '';

                // 用户设置部分，从 activeChatUserProfile 加载
                document.getElementById('chat-user-name-input').value = activeChatUserProfile.name || '';
                // 新增：加载用户人设
                // 为了实现这个功能，我们需要先给HTML添加一个输入框。
                // 暂时先跳过，我们将在第7步添加HTML。现在先写好逻辑。
                // document.getElementById('chat-user-persona-input').value = activeChatUserProfile.persona || '';
                document.getElementById('chat-user-frame-url').value = activeChatUserProfile.avatarFrame || '';

                tempAiFrameUrl = currentChatPartner.avatarFrame || '';
                tempUserFrameUrl = activeChatUserProfile.avatarFrame || '';
                populateModalWorldBookList();
                switchPage('chat-settings-page');
            });
            
            const actionPanel = wechatContainer.querySelector('#action-panel');
            const emojiPicker = wechatContainer.querySelector('#emoji-picker');
            wechatContainer.querySelector('#toggle-actions-btn').addEventListener('click', () => {
                emojiPicker.style.display = 'none';
                actionPanel.style.display = actionPanel.style.display === 'flex' ? 'none' : 'flex';
            });
            wechatContainer.querySelector('#toggle-emoji-btn').addEventListener('click', () => {
                actionPanel.style.display = 'none';
                emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
            });
            messageInput.addEventListener('focus', () => {
                actionPanel.style.display = 'none';
                emojiPicker.style.display = 'none';
            });

            const voiceMessageModal = wechatContainer.querySelector('#voice-message-modal');
            wechatContainer.querySelectorAll('.action-item').forEach(item => item.addEventListener('click', () => {
                const action = item.dataset.action;
                actionPanel.style.display = 'none';
                if (action === 'send-voice-msg') voiceMessageModal.style.display = 'flex';
                else showAlert(`${item.querySelector('small').textContent} 功能即将开放`);
            }));
            wechatContainer.querySelector('#send-voice-confirm').addEventListener('click', () => {
                const text = wechatContainer.querySelector('#voice-message-text').value.trim();
                if (text) createMessageBubble(`[语音] ${text}`, 'user');
                wechatContainer.querySelector('#voice-message-text').value = '';
                voiceMessageModal.style.display = 'none';
            });
            wechatContainer.querySelector('#cancel-voice-message').addEventListener('click', () => {
                wechatContainer.querySelector('#voice-message-text').value = '';
                voiceMessageModal.style.display = 'none';
            });

            function populateEmojis() {
                const emojis = ['😊', '😂', '❤️', '👍', '😢', '😍', '🎉', '🤔', '👋', '🙏', '💯', '🔥', '✨', '🌸', '🍓', '🍰', '( ´͈ ᵕ `͈ )', 'TωT', 'ovo', 'QAQ', '(*^▽^*)'];
                emojis.forEach(emoji => {
                    const span = document.createElement('span');
                    span.className = 'emoji-item';
                    span.textContent = emoji;
                    span.onclick = () => { messageInput.value += emoji; messageInput.focus(); };
                    emojiPicker.prepend(span);
                });
            }
            populateEmojis();
            wechatContainer.querySelector('#add-local-emoji-btn').addEventListener('click', () => showAlert('从本地添加功能正在开发中！'));

            wechatContainer.querySelector('#go-to-settings-btn')?.addEventListener('click', () => switchPage('settings-page'));
            wechatContainer.querySelector('#back-to-profile')?.addEventListener('click', () => switchPage('profile-page'));
            
            const statusBtn = wechatContainer.querySelector('#profile-status-btn'); 
            const statusSwitcher = wechatContainer.querySelector('#status-switcher');
            statusBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                const btnRect = statusBtn.getBoundingClientRect();
                const containerRect = mobileContainer.getBoundingClientRect();
                statusSwitcher.style.top = `${btnRect.bottom - containerRect.top + 5}px`;
                statusSwitcher.style.left = `${btnRect.left - containerRect.left}px`;
                statusSwitcher.classList.toggle('show');
            });
            statusSwitcher?.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    statusBtn.querySelector('span').textContent = e.target.textContent;
                    statusSwitcher.classList.remove('show');
                }
            });
            
            const editProfileModal = wechatContainer.querySelector('#edit-profile-modal');
            const profileNameEl = wechatContainer.querySelector('#profile-page-name');
            const profileIdEl = wechatContainer.querySelector('#profile-page-id');
            const momentsNameEl = wechatContainer.querySelector('#discover-page-name');
            wechatContainer.querySelector('#edit-profile-btn')?.addEventListener('click', () => {
                wechatContainer.querySelector('#edit-profile-name-input').value = profileNameEl.textContent;
                wechatContainer.querySelector('#edit-profile-id-input').value = profileIdEl.textContent;
                wechatContainer.querySelector('#edit-moments-name-input').value = momentsNameEl.textContent;
                editProfileModal.style.display = 'flex';
            });
            wechatContainer.querySelector('#modal-edit-cancel').addEventListener('click', () => { editProfileModal.style.display = 'none'; });
            // [替换后的代码]
            // --- 修复开始：为“编辑主页”的保存按钮添加完整的图片和文本保存功能 ---
            wechatContainer.querySelector('#modal-edit-save').addEventListener('click', async () => {
                // 1. 保存文字部分（保持不变）
                profileNameEl.textContent = wechatContainer.querySelector('#edit-profile-name-input').value;
                profileIdEl.textContent = wechatContainer.querySelector('#edit-profile-id-input').value;
                momentsNameEl.textContent = wechatContainer.querySelector('#edit-moments-name-input').value;
                saveProfileData();

                try {
                    // 2. 核心：检查并永久保存所有暂存的图片
                    if (tempProfileAvatarFile) {
                        await idbHelper.set('wechat_profile_avatar', tempProfileAvatarFile);
                        tempProfileAvatarFile = null; // 保存后清空临时变量
                    }
                    if (tempMomentsAvatarFile) {
                        await idbHelper.set('wechat_moments_avatar', tempMomentsAvatarFile);
                        tempMomentsAvatarFile = null;
                    }
                    if (tempMomentsCoverFile) {
                        await idbHelper.set('wechat_moments_cover', tempMomentsCoverFile);
                        tempMomentsCoverFile = null;
                    }
                    
                    showAlert('已永久保存');

                } catch (error) {
                    console.error("保存主页图片到数据库时出错:", error);
                    showAlert('图片保存失败，请重试！');
                } finally {
                    // 3. 无论成功与否，最后都关闭弹窗
                    editProfileModal.style.display = 'none';
                }
            });
            // --- 修复结束 ---
                        const actionPopup = wechatContainer.querySelector('#moment-action-popup');
            let currentPostElement = null;
            wechatContainer.querySelector('#discover-page-content').addEventListener('click', (e) => {
                const actionButton = e.target.closest('.moment-actions-btn');
                if (actionButton) {
                    currentPostElement = actionButton.closest('.moment-post');
                    const rect = actionButton.getBoundingClientRect();
                    const containerRect = mobileContainer.getBoundingClientRect();
                    actionPopup.style.display = 'flex';
                    actionPopup.style.top = `${rect.top - containerRect.top - (actionPopup.offsetHeight / 2) + (rect.height / 2)}px`;
                    actionPopup.style.left = `${rect.left - containerRect.left - actionPopup.offsetWidth - 10}px`;
                } else if (!e.target.closest('.moment-action-popup') && !e.target.closest('.comment-input-wrapper')) {
                    actionPopup.style.display = 'none';
                    wechatContainer.querySelectorAll('.comment-input-wrapper').forEach(el => el.remove());
                }
            });
            actionPopup.addEventListener('click', (e) => {
                if (e.target.classList.contains('like-btn')) {
                    let likesEl = currentPostElement.querySelector('.moment-likes');
                    if (!likesEl) {
                        likesEl = document.createElement('div'); likesEl.className = 'moment-likes';
                        currentPostElement.querySelector('.moment-interactions').prepend(likesEl);
                    }
                    likesEl.textContent = '♡ ' + profileNameEl.textContent;
                }
                if (e.target.classList.contains('comment-btn')) {
                    document.querySelectorAll('.comment-input-wrapper').forEach(el => el.remove());
                    const inputWrapper = document.createElement('div');
                    inputWrapper.className = 'comment-input-wrapper';
                    inputWrapper.innerHTML = `<input type="text" class="comment-input" placeholder="评论..."><button class="comment-input-btn send-comment">✓</button><button class="comment-input-btn cancel-comment">✗</button>`;
                    currentPostElement.after(inputWrapper);
                    const input = inputWrapper.querySelector('input');
                    input.focus();
                                        inputWrapper.querySelector('.send-comment').addEventListener('click', () => {
                        const userCommentText = input.value.trim();
                        if (userCommentText !== '') {
                            let commentsEl = currentPostElement.querySelector('.moment-comments-list');
                            if (!commentsEl) {
                                commentsEl = document.createElement('div'); commentsEl.className = 'moment-comments-list';
                                 currentPostElement.querySelector('.moment-interactions').appendChild(commentsEl);
                            }
                            const myComment = document.createElement('div'); myComment.className = 'comment-item';
                            myComment.innerHTML = `<span class="comment-author">${profileNameEl.textContent}: </span><span>${userCommentText}</span>`;
                            commentsEl.appendChild(myComment);
                            
                            // --- 新增：调用AI回复函数 ---
                            triggerAIReply(currentPostElement, userCommentText);
                            
                            inputWrapper.remove();
                        }
                    });
                    inputWrapper.querySelector('.cancel-comment').addEventListener('click', () => inputWrapper.remove());
                }
                actionPopup.style.display = 'none';
            });
            
            function handleImageUpload(event, callback) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = e => callback(e.target.result); reader.readAsDataURL(file); } }
            
            // --- 修复开始：为微信主页图片上传添加“预览并暂存”功能 ---

            // 辅助函数：当选择文件后，更新预览并暂存文件
            const setupImagePreviewer = (inputId, imgSelector, setTempFileCallback) => {
                const inputElement = wechatContainer.querySelector(inputId);
                const imageElement = wechatContainer.querySelector(imgSelector);
                if (!inputElement || !imageElement) return;

                inputElement.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    // 1. 将选择的文件对象存入对应的临时变量
                    setTempFileCallback(file);
                    
                    // 2. 在界面上生成临时URL以供预览
                    imageElement.src = URL.createObjectURL(file);

                    // 特殊处理：如果更换的是朋友圈头像，需要同步更新已发表动态中的“我”的头像
                    if (inputId === '#moments-avatar-input') {
                        wechatContainer.querySelectorAll('.my-moment-avatar').forEach(img => {
                           img.src = imageElement.src;
                        });
                    }
                });
            };

            // 为三个上传按钮绑定新的“预览并暂存”逻辑
            setupImagePreviewer('#wechat-profile-avatar-input', '#profile-avatar', file => { tempProfileAvatarFile = file; });
            setupImagePreviewer('#moments-avatar-input', '#discover-page-avatar', file => { tempMomentsAvatarFile = file; });
            setupImagePreviewer('#moments-cover-input', '#moments-cover-photo', file => { tempMomentsCoverFile = file; });
            
            // --- 修复结束 ---
            wechatContainer.querySelector('#statusbar-bg-input')?.addEventListener('change', e => handleImageUpload(e, url => wechatContainer.querySelector('#status-bar').style.backgroundImage = `url(${url})`));
            wechatContainer.querySelector('#nav-bg-input')?.addEventListener('change', e => handleImageUpload(e, url => wechatContainer.querySelector('#bottom-nav').style.backgroundImage = `url(${url})`));
            wechatContainer.querySelector('#nav-icon-input')?.addEventListener('change', e => handleImageUpload(e, url => wechatContainer.querySelectorAll('.nav-icon-img').forEach(icon => icon.src = url)));
            wechatContainer.querySelector('#apply-url-btn')?.addEventListener('click', () => { const url = wechatContainer.querySelector('#nav-icon-url').value.trim(); if(url) wechatContainer.querySelectorAll('.nav-icon-img').forEach(icon => icon.src = url); });
            wechatContainer.querySelector('#avatar-frame-input')?.addEventListener('change', e => handleImageUpload(e, url => wechatContainer.querySelector('#avatar-frame').src = url));
            wechatContainer.querySelector('#apply-avatar-frame-url-btn')?.addEventListener('click', () => { const url = wechatContainer.querySelector('#avatar-frame-url').value.trim(); if(url) wechatContainer.querySelector('#avatar-frame').src = url; });
            wechatContainer.querySelector('#apply-island-color-btn')?.addEventListener('click', () => { const color = wechatContainer.querySelector('#island-color-input').value.trim(); if(color) wechatContainer.querySelector('#dynamic-island').style.background = color; });
            const profileBgContainer = wechatContainer.querySelector('#profile-page .page-content-scrollable');
            wechatContainer.querySelector('#profile-bg-input')?.addEventListener('change', e => handleImageUpload(e, url => { profileBgContainer.style.backgroundImage = `url(${url})`; profileBgContainer.style.backgroundSize = 'cover'; }));
            wechatContainer.querySelector('#apply-bg-color-btn')?.addEventListener('click', () => { const color = wechatContainer.querySelector('#bg-color-input').value.trim(); if(color) { profileBgContainer.style.backgroundImage = 'none'; profileBgContainer.style.backgroundColor = color; } });

            let currentSortOrder = 'pinyin';
            const searchInput = wechatContainer.querySelector('#contact-search-input');
            const sortBtn = wechatContainer.querySelector('#sort-contacts-btn');
            const sortPopup = wechatContainer.querySelector('#sort-options-popup');

            function displayContacts() {
                let contacts = [...addressBookContacts];
                const searchTerm = searchInput.value.toLowerCase();
                if (searchTerm) {
                    contacts = contacts.filter(c => c.name.toLowerCase().includes(searchTerm) || c.pinyin.toLowerCase().includes(searchTerm));
                }
                if (currentSortOrder === 'newest') contacts.sort((a, b) => b.createdAt - a.createdAt);
                else if (currentSortOrder === 'oldest') contacts.sort((a, b) => a.createdAt - b.createdAt);
                else contacts.sort((a, b) => a.pinyin.localeCompare(b.pinyin));
                renderContactsPage(contacts);
            }
            searchInput.addEventListener('input', displayContacts);
            sortBtn.addEventListener('click', e => { e.stopPropagation(); sortPopup.style.display = sortPopup.style.display === 'block' ? 'none' : 'block'; });
            sortPopup.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    currentSortOrder = e.target.dataset.sort;
                    displayContacts();
                    sortPopup.style.display = 'none';
                }
            });

            document.body.addEventListener('click', e => {
                if (!e.target.closest('#sort-contacts-btn') && !e.target.closest('#sort-options-popup')) if(sortPopup) sortPopup.style.display = 'none';
                if (!e.target.closest('.chat-item-wrapper')) resetActiveSwipeItem();
                if(!e.target.closest('#profile-status-btn') && !e.target.closest('#status-switcher')) statusSwitcher?.classList.remove('show');
            });
            
            const momentsOptionsModal = wechatContainer.querySelector('#moments-options-modal');
            const locationInputModal = wechatContainer.querySelector('#location-input-modal');
            const momentTextInput = wechatContainer.querySelector('#moment-text-input');
            const publishSubmitBtn = wechatContainer.querySelector('#publish-submit-btn');
            const locationDisplayText = wechatContainer.querySelector('#location-display-text');
            
            wechatContainer.querySelector('#moments-settings-btn').addEventListener('click', () => {
                momentsOptionsModal.style.display = 'flex';
            });
            wechatContainer.querySelector('#cancel-moments-options').addEventListener('click', () => {
                momentsOptionsModal.style.display = 'none';
            });
                    // --- 核心修改：为发表页的返回按钮使用更精确的选择器 ---
        wechatContainer.querySelector('#publish-moment-page .publish-back-btn').addEventListener('click', () => switchPage('discover-page'));
        
        momentTextInput.addEventListener('input', () => {
            publishSubmitBtn.disabled = momentTextInput.value.trim() === '';
        });
        
        wechatContainer.querySelector('#publish-location-btn').addEventListener('click', () => {
            locationInputModal.style.display = 'flex';
        });
        wechatContainer.querySelector('#publish-mention-btn').addEventListener('click', () => {
            showAlert('该功能暂未开放');
        });

        wechatContainer.querySelector('#cancel-location-btn').addEventListener('click', () => {
            locationInputModal.style.display = 'none';
        });
        wechatContainer.querySelector('#confirm-location-btn').addEventListener('click', () => {
            const locationInput = wechatContainer.querySelector('#custom-location-input');
            const location = locationInput.value.trim();
            if (location) {
                locationDisplayText.textContent = location;
                locationDisplayText.dataset.location = location; 
            }
            locationInput.value = '';
            locationInputModal.style.display = 'none';
        });
            wechatContainer.querySelector('#go-to-publish-btn').addEventListener('click', () => {
                momentsOptionsModal.style.display = 'none';
                momentTextInput.value = '';
                locationDisplayText.textContent = '所在位置';
                locationDisplayText.dataset.location = '';
                publishSubmitBtn.disabled = true;
                switchPage('publish-moment-page');
            });
            // --- 在这里粘贴新代码 ---
wechatContainer.querySelector('#go-to-view-btn').addEventListener('click', async () => {
    momentsOptionsModal.style.display = 'none';
    
    if (addressBookContacts.length === 0) {
        showAlert('通讯录是空的，没有AI可以发朋友圈。');
        return;
    }

    showAlert('正在通知AI们更新朋友圈...');
    
    // 创建一个任务列表，让所有AI同时去生成内容
    const momentGenerationPromises = addressBookContacts.map(contact => 
        generateAndPostAIMoment(contact, true) // 传入true表示这是批量生成
    );

    // 等待所有任务完成
    await Promise.all(momentGenerationPromises);

    showAlert('AI朋友圈已更新！');
    switchPage('discover-page'); // 跳转到发现页查看
});
// --- 新代码到此结束 ---
            publishSubmitBtn.addEventListener('click', () => {
    const text = momentTextInput.value;
    const location = locationDisplayText.dataset.location || '';
    const newPost = document.createElement('div');
    newPost.className = 'moment-post';
    newPost.dataset.authorId = 'user_profile'; 
    
// 【⭐修改点】将时间和IP地址的span改为div，使其垂直排列
newPost.innerHTML = `
    <img src="${wechatContainer.querySelector('#discover-page-avatar').src}" alt="Author Avatar" class="moment-avatar my-moment-avatar">
    <div class="moment-content">
        <div class="moment-body">
            <div class="moment-author">${momentsNameEl.textContent}</div>
            <div class="moment-text">${text.replace(/\n/g, '<br>')}</div>
            <div class="moment-meta" style="display: block;">
                <div class="moment-time">刚刚</div>
                ${location ? `<div class="moment-location">IP属地: ${location}</div>` : ''}
            </div>
            <span class="moment-actions-btn">...</span>
        </div>
        <div class="moment-interactions">
            <div class="moment-likes"></div>
            <div class="moment-comments-list"></div>
        </div>
    </div>`;
    wechatContainer.querySelector('#moments-feed').prepend(newPost);
    // 触发AI评论模拟
    simulateAIComments(newPost, text);
    showAlert('发表成功!');
    switchPage('discover-page');
});
            // --- 新增函数：AI生成并发表朋友圈 ---
                momentTextInput.addEventListener('input', () => {
                publishSubmitBtn.disabled = momentTextInput.value.trim() === '';
            });
            
            wechatContainer.querySelector('#publish-location-btn').addEventListener('click', () => {
                locationInputModal.style.display = 'flex';
            });
            wechatContainer.querySelector('#publish-mention-btn').addEventListener('click', () => {
                showAlert('该功能暂未开放');
            });

            wechatContainer.querySelector('#cancel-location-btn').addEventListener('click', () => {
                locationInputModal.style.display = 'none';
            });
            wechatContainer.querySelector('#confirm-location-btn').addEventListener('click', () => {
                const locationInput = wechatContainer.querySelector('#custom-location-input');
                const location = locationInput.value.trim();
                if (location) {
                    locationDisplayText.textContent = location;
                    locationDisplayText.dataset.location = location; 
                }
                locationInput.value = '';
                locationInputModal.style.display = 'none';
            });

            const viewMomentsContactList = wechatContainer.querySelector('#view-moments-contact-list');
            function populateViewMomentsList() {
                viewMomentsContactList.innerHTML = '';
                addressBookContacts.forEach(contact => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'contact-item';
                    itemEl.innerHTML = `<label><input type="checkbox" data-name="${contact.name}"><img src="${contact.avatar}" alt=""><span>${contact.name}</span></label>`;
                    viewMomentsContactList.appendChild(itemEl);
                });
            }

            wechatContainer.querySelector('#go-to-view-btn').addEventListener('click', async () => {
    momentsOptionsModal.style.display = 'none';
    
    if (addressBookContacts.length === 0) {
        showAlert('通讯录是空的，没有AI可以发朋友圈。');
        return;
    }

    showAlert('正在通知AI们更新朋友圈...');
    
    // 创建一个任务列表，让所有AI同时去生成内容
    const momentGenerationPromises = addressBookContacts.map(contact => 
        generateAndPostAIMoment(contact, true) // 传入true表示这是批量生成
    );

    // 等待所有任务完成
    await Promise.all(momentGenerationPromises);

    showAlert('AI朋友圈已更新！');
    switchPage('discover-page'); // 跳转到发现页查看
});
            
            const chatSettingsPage = document.getElementById('chat-settings-page');

            function initializeUserSettings() {
                loadProfileData(); 
                // 加载并设置默认用户配置
                const savedDefaultSettings = JSON.parse(localStorage.getItem('wechatDefaultUserSettings'));
                if (savedDefaultSettings) {
                    defaultUserSettings = savedDefaultSettings;
                } else {
                    // 如果没有保存过，就从主页获取初始信息
                    defaultUserSettings.name = document.getElementById('profile-page-name').textContent;
                    defaultUserSettings.avatar = document.getElementById('profile-avatar').src; // 注意：这里只是一个初始引用
                    defaultUserSettings.avatarFrame = '';
                    defaultUserSettings.persona = '一个普通人类';
                }
                // 主页上的头像是全局的，应该从默认配置加载
                document.getElementById('profile-avatar').src = getAvatarUrl(defaultUserSettings.avatar);
            }
   function saveCurrentChatPartnerData() {
                const index = initialChats.findIndex(c => c.id === currentChatPartner.id);
                if (index !== -1) {
                    initialChats[index] = { ...initialChats[index], ...currentChatPartner };
                }
            }

             function updateCurrentChatDisplay() {
                wechatContainer.querySelector('#chat-contact-name').textContent = currentChatPartner.name;
                const messages = chatMessagesContainer.querySelectorAll('.message-bubble');
                messages.forEach(msg => {
                    const wrapper = msg.querySelector('.chat-avatar-wrapper');
                    const avatarImg = msg.querySelector('.avatar');
                    if (msg.classList.contains('ai-message')) {
                        avatarImg.src = getAvatarUrl(currentChatPartner.avatar);
                        wrapper.style.backgroundImage = `url('${currentChatPartner.avatarFrame || ''}')`;
                    } else { 
                        // 核心修改：从 activeChatUserProfile 获取用户信息
                        avatarImg.src = getAvatarUrl(activeChatUserProfile.avatar);
                        wrapper.style.backgroundImage = `url('${activeChatUserProfile.avatarFrame || ''}')`;
                    }
                });
            }
            document.getElementById('back-to-chat-btn').addEventListener('click', () => switchPage('ai-chat-page'));
            
            document.getElementById('chat-ai-avatar-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        // 只是临时存放文件，并显示预览图，等待用户点击保存
        tempAiAvatarFile = file;
        const objectURL = URL.createObjectURL(file);
        const messages = chatMessagesContainer.querySelectorAll('.message-bubble.ai-message .avatar');
        messages.forEach(img => img.src = objectURL);
        showAlert('头像已预览，点击下方保存按钮生效');
    }
});

            document.getElementById('chat-ai-frame-input').addEventListener('change', e => handleImageUpload(e, url => {
                 tempAiFrameUrl = url;
                 document.getElementById('chat-ai-frame-url').value = "已从本地选择";
            }));
            
            document.getElementById('chat-user-avatar-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        // 只是临时存放文件，并显示预览图，等待用户点击保存
        tempUserAvatarFile = file;
        const objectURL = URL.createObjectURL(file);
        document.getElementById('profile-avatar').src = objectURL;
        updateCurrentChatDisplay();
        showAlert('头像已预览，点击下方保存按钮生效');
    }
});


            document.getElementById('chat-user-frame-input').addEventListener('change', e => handleImageUpload(e, url => {
                tempUserFrameUrl = url;
                document.getElementById('chat-user-frame-url').value = "已从本地选择";
            }));

            function saveChatSettings() {
                localStorage.setItem('wechatChatSettings', JSON.stringify(chatSettings));
            }

            function loadChatSettings() {
                const savedSettings = JSON.parse(localStorage.getItem('wechatChatSettings'));
                chatSettings = { timePerception: false, offlineMode: false, memoryRounds: 5, proactiveChat: false, proactiveFrequency: 'medium', wallpaper: '', topBarColor: '', bottomBarColor: '', ...savedSettings };
                
                chatSettingsPage.querySelector('#setting-time-perception').checked = chatSettings.timePerception;
                chatSettingsPage.querySelector('#setting-offline-mode').checked = chatSettings.offlineMode;
                chatSettingsPage.querySelector('#setting-memory-rounds').value = chatSettings.memoryRounds;
                chatSettingsPage.querySelector('#setting-proactive-chat').checked = chatSettings.proactiveChat;
                chatSettingsPage.querySelector('#setting-proactive-frequency').value = chatSettings.proactiveFrequency;
                chatSettingsPage.querySelector('#setting-top-bar-color').value = chatSettings.topBarColor;
                chatSettingsPage.querySelector('#setting-bottom-bar-color').value = chatSettings.bottomBarColor;

                if (chatSettings.wallpaper) chatMessagesContainer.style.backgroundImage = `url(${chatSettings.wallpaper})`;
                if (chatSettings.topBarColor) aiChatPage.querySelector('.chat-header').style.backgroundColor = chatSettings.topBarColor;
                if (chatSettings.bottomBarColor) aiChatPage.querySelector('.chat-input-area').style.backgroundColor = chatSettings.bottomBarColor;
            }

                       let tempWallpaperDbKey = null; // 用于临时存储待保存的壁纸ID

            document.getElementById('chat-wallpaper-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file || !currentChatPartner) return;

                // 为当前聊天的壁纸创建一个唯一的数据库ID
                const dbKey = `wallpaper_${currentChatPartner.id}`;
                try {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    loadingOverlay.classList.remove('hidden');
                    
                    await idbHelper.set(dbKey, file); // 立即保存到数据库
                    tempWallpaperDbKey = dbKey; // 将ID存入临时变量，等待用户点击“保存全部设置”
                    
                    // 立即显示壁纸预览
                    const objectURL = URL.createObjectURL(file);
                    chatMessagesContainer.style.backgroundImage = `url('${objectURL}')`;
                    chatMessagesContainer.style.backgroundSize = 'cover';
                    chatMessagesContainer.style.backgroundPosition = 'center';

                    loadingOverlay.classList.add('hidden');
                    showAlert('壁纸已预览，点击下方保存按钮后将永久生效');
                } catch (err) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    console.error('保存壁纸失败:', err);
                    alert('保存壁纸失败！');
                }
            });
            document.getElementById('delete-chat-history-btn').addEventListener('click', () => {
                if (confirm('确定要删除所有聊天记录吗？此操作不可恢复。')) {
                    chatMessagesContainer.innerHTML = '';
                    saveCurrentChatHistory();
                    showAlert('聊天记录已清除');
                }
            });

            function setupProactiveChat() {
                if (proactiveChatTimer) { clearInterval(proactiveChatTimer); proactiveChatTimer = null; }
                if (chatSettings.proactiveChat && wechatContainer.querySelector('#ai-chat-page').classList.contains('active')) {
                    const frequencies = { high: 60000, medium: 300000, low: 900000 };
                    const interval = frequencies[chatSettings.proactiveFrequency];
                    proactiveChatTimer = setInterval(triggerAIProactiveMessage, interval);
                }
            }
            
            function triggerAIProactiveMessage() {
           if (!apiSettings.baseUrl || !apiSettings.apiKey) return;
           const prompt = `你是 ${currentChatPartner.name} (${currentChatPartner.persona}). 你已经有一段时间没说话了，请根据你的角色性格，主动发起一个新的话题或对我说些什么。`;
            callAI([{ role: 'system', content: prompt }]).then(response => { if (response && !response.startsWith('(AI调用出错')) { createMessageBubble(response, 'ai'); saveCurrentChatHistory(); n(currentChatPartner); } });
             }
            const worldbookLinkerModal = document.getElementById('worldbook-linker-modal');
            document.getElementById('open-worldbook-linker-btn').addEventListener('click', () => {
                worldbookLinkerModal.style.display = 'flex';
                populateModalWorldBookList();
            });
            document.getElementById('cancel-worldbook-link-btn').addEventListener('click', () => {
                worldbookLinkerModal.style.display = 'none';
            });
            document.getElementById('apply-worldbook-link-btn').addEventListener('click', () => {
                const selectedIds = [];
                worldbookLinkerModal.querySelectorAll('.worldbook-link-checkbox:checked').forEach(checkbox => {
                    selectedIds.push(checkbox.value);
                });
                currentChatPartner.linkedWorldBookIds = selectedIds;
                saveCurrentChatPartnerData();
                worldbookLinkerModal.style.display = 'none';
                showAlert('世界书关联已应用');
            });

            function populateModalWorldBookList() {
    worldBookEntries = JSON.parse(localStorage.getItem('worldBookEntries') || '[]'); // <-- 就是在这里添加了这一行代码
    const container = document.getElementById('modal-worldbook-list');
    container.innerHTML = '';
    if (worldBookEntries.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400">世界书是空的，请先去创建条目。</p>';
        return;
    }
    worldBookEntries.forEach(entry => {
        const isChecked = currentChatPartner.linkedWorldBookIds?.includes(entry.id) ? 'checked' : '';
        const itemHTML = `<div class="text-sm"><label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded-md"><input type="checkbox" value="${entry.id}" class="worldbook-link-checkbox" ${isChecked}><span>${entry.name}</span></label></div>`;
        container.insertAdjacentHTML('beforeend', itemHTML);
    });
}

                          // <-- 粘贴这段新的代码 -->
document.getElementById('save-all-chat-settings-btn').addEventListener('click', async () => {
    try {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.classList.remove('hidden');

        // ======== AI (对方) 设置 ========
        // 1. 处理AI的新头像（如果选择了）
        if (tempAiAvatarFile) {
            const dbKey = `avatar_${currentChatPartner.id}`;
            await idbHelper.set(dbKey, tempAiAvatarFile);
            currentChatPartner.avatar = dbKey;
            avatarCache[dbKey] = URL.createObjectURL(tempAiAvatarFile);
            tempAiAvatarFile = null;
        }
        // 2. 更新AI的人设和头像框
        currentChatPartner.persona = document.getElementById('chat-ai-persona-input').value;
        const aiFrameUrl = document.getElementById('chat-ai-frame-url').value.trim();
        currentChatPartner.avatarFrame = (aiFrameUrl === "已从本地选择" && tempAiFrameUrl) ? tempAiFrameUrl : aiFrameUrl;


        // ======== USER (我) 设置 (核心修改) ========
        // 3. 处理“我”的新头像（如果选择了）
        if (tempUserAvatarFile) {
            // 为这个特定聊天的用户头像创建一个唯一ID
            const userDbKey = `avatar_user_for_${currentChatPartner.id}_${Date.now()}`;
            await idbHelper.set(userDbKey, tempUserAvatarFile);
            activeChatUserProfile.avatar = userDbKey; // 保存到当前活动的配置中
            avatarCache[userDbKey] = URL.createObjectURL(tempUserAvatarFile);
            tempUserAvatarFile = null;
        }
        // 4. 更新“我”的昵称、人设和头像框
        activeChatUserProfile.name = document.getElementById('chat-user-name-input').value;
        // 下面这行代码对应第7步将要添加的HTML元素
        activeChatUserProfile.persona = document.getElementById('chat-user-persona-input').value; 
        const userFrameUrl = document.getElementById('chat-user-frame-url').value.trim();
        activeChatUserProfile.avatarFrame = (userFrameUrl === "已从本地选择" && tempUserFrameUrl) ? tempUserFrameUrl : userFrameUrl;

        
        // ======== 功能和外观设置 (保持不变) ========
        chatSettings.timePerception = document.getElementById('setting-time-perception').checked;
        chatSettings.offlineMode = document.getElementById('setting-offline-mode').checked;
        chatSettings.memoryRounds = document.getElementById('setting-memory-rounds').value;
        chatSettings.proactiveChat = document.getElementById('setting-proactive-chat').checked;
        chatSettings.proactiveFrequency = document.getElementById('setting-proactive-frequency').value;
        chatSettings.topBarColor = document.getElementById('setting-top-bar-color').value.trim();
        chatSettings.bottomBarColor = document.getElementById('setting-bottom-bar-color').value.trim();
        
        // ======== 数据同步与保存 ========
        // 5. 将更新后的 activeChatUserProfile 写回到 currentChatPartner
        currentChatPartner.userProfile = activeChatUserProfile;
        
        // 6. 将更新后的 currentChatPartner 同步到主数据源
        const contactId = currentChatPartner.id;
        const chatIndex = initialChats.findIndex(c => c.id === contactId);
        if (chatIndex > -1) initialChats[chatIndex] = currentChatPartner;
        
        const addressBookIndex = addressBookContacts.findIndex(c => c.id === contactId);
        if (addressBookIndex > -1) addressBookContacts[addressBookIndex] = currentChatPartner;

        // 7. 执行所有永久保存操作
        saveContactsData();
        saveChatSettings();
        // 不再需要保存全局的 wechatUserSettings，改为保存默认设置（如果需要）
        localStorage.setItem('wechatDefaultUserSettings', JSON.stringify(defaultUserSettings));


        // ======== 刷新界面显示 ========
        updateCurrentChatDisplay(); // 这个函数也需要修改，见下一步
        setupProactiveChat();
        if (chatSettings.topBarColor) aiChatPage.querySelector('.chat-header').style.backgroundColor = chatSettings.topBarColor;
        if (chatSettings.bottomBarColor) aiChatPage.querySelector('.chat-input-area').style.backgroundColor = chatSettings.bottomBarColor;

        loadingOverlay.classList.add('hidden');
        showAlert('全部设置已永久保存！');

    } catch (error) {
        console.error("保存设置时出错:", error);
        document.getElementById('loading-overlay').classList.add('hidden');
        alert(`保存失败: ${error.message}`);
    }
});
            loadChatSettings();
            initializeUserSettings();
            const activePageOnLoad = wechatContainer.querySelector('.page.active');
            if (activePageOnLoad) {
                switchPage(activePageOnLoad.id);
            }
        }
         // =======================================================
        // ================== BROWSER SCRIPT START =================
        // =======================================================
        let browserContentLoaded = false;
        document.getElementById('xiaohongshu-app-icon').addEventListener('click', () => {
            showMainScreen('browser-screen');
            if (!browserContentLoaded) {
                searchAndOpen();
                browserContentLoaded = true;
            }
        });
        document.getElementById('browser-back-to-home-btn').addEventListener('click', () => { showMainScreen('home-screen'); });
        const initBrowserSlider = (slider, direction) => {
            let startX = 0, startY = 0, validSlide = false;
            const feedback = direction === 'up' ? document.getElementById('homeBackFeedback') : document.getElementById('backFeedback');
            const threshold = 40;
            const showFeedback = () => { feedback.style.display = direction === 'up' ? 'block' : 'flex'; feedback.style.opacity = '1'; };
            const hideFeedback = () => { feedback.style.opacity = '0'; setTimeout(() => feedback.style.display = 'none', 300); };
            slider.ontouchstart = e => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; validSlide = false; };
            slider.ontouchmove = e => {
                const deltaX = e.touches[0].clientX - startX;
                const deltaY = e.touches[0].clientY - startY;
                if (direction === 'up') {
                    if (Math.abs(deltaY) > Math.abs(deltaX) && !validSlide && deltaY < -threshold) { validSlide = true; showFeedback(); }
                } else {
                    if (Math.abs(deltaX) > Math.abs(deltaY) && !validSlide && Math.abs(deltaX) > threshold) { validSlide = true; showFeedback(); }
                }
            };
            slider.ontouchend = e => {
                if (validSlide) {
                    if (direction === 'up') {
                        if (e.changedTouches[0].clientY - startY < -threshold) setTimeout(() => { hideFeedback(); showMainScreen('home-screen'); }, 300);
                    } else {
                        const deltaX = e.changedTouches[0].clientX - startX;
                        if ((direction === 'right' && deltaX > 0) || (direction === 'left' && deltaX < 0)) setTimeout(() => { hideFeedback(); history.back(); }, 300);
                    }
                }
                hideFeedback();
            };
            slider.ontouchcancel = () => { validSlide = false; hideFeedback(); };
        };
        initBrowserSlider(document.getElementById('leftSlider'), 'right');
        initBrowserSlider(document.getElementById('rightSlider'), 'left');
        initBrowserSlider(document.getElementById('bottomSlider'), 'up');
        let isBrowserLoading = false;
        const browserLoader = {
            show() {
                isBrowserLoading = true;
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('goButton').style.display = 'none';
                document.getElementById('progressBar').style.display = 'block';
                document.getElementById('progressBar').classList.add('progress-active');
            },
            hide() {
                isBrowserLoading = false;
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('goButton').style.display = 'flex';
                document.getElementById('progressBar').classList.remove('progress-active');
                document.getElementById('progressBar').style.display = 'none';
            }
        };
        function handleBrowserEnter(e) {
            if ((e.key === 'Enter' || e.type === 'click') && !isBrowserLoading) {
                const url = document.getElementById('urlInput').value.trim();
                if (!url) return;
                browserLoader.show();
                let finalUrl = !/^https?:\/\//i.test(url) ? 'http://' + url : url;
                const frame = document.getElementById('browserFrame');
                frame.style.background = 'white';
                const timeout = setTimeout(() => { browserLoader.hide(); showBrowserError('请求超时'); }, 8000);
                frame.onload = () => { clearTimeout(timeout); browserLoader.hide(); };
                frame.onerror = () => { clearTimeout(timeout); browserLoader.hide(); showBrowserError('加载失败'); };
                frame.src = finalUrl;
            }
        }
        document.getElementById('goButton').addEventListener('click', handleBrowserEnter);
        document.getElementById('urlInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleBrowserEnter(e); });
        function showBrowserError(msg) {
            const error = document.createElement('div');
            error.textContent = msg;
            error.style = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; z-index: 10000; animation: fadeInOut 2.5s forwards;`;
            document.body.appendChild(error);
            setTimeout(() => error.remove(), 2500);
        }
        let isLandscapeMode = false;
        function toggleFullscreen() {
            const frame = document.getElementById('browserFrame'), container = document.querySelector('#browser-screen .browser-main');
            const controlBar = container.querySelector('div[style*="height: 65px"]'), progressBar = document.getElementById('progressBar');
            if (isLandscapeMode) {
                frame.style.cssText = "width: 100%; height: calc(100% - 65px); border: none; margin-top: 0; transform-origin: center center; transition: transform 0.3s ease;";
                controlBar.style.display = 'flex';
                progressBar.style.top = '65px';
            } else {
                frame.style.cssText += `width: ${container.clientHeight}px; height: ${container.clientWidth}px; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) rotate(90deg);`;
                controlBar.style.display = 'none'; progressBar.style.top = '0px';
            }
            isLandscapeMode = !isLandscapeMode;
            updateFullscreenButtonStyle();
        }
        document.getElementById('fullscreenButton').addEventListener('click', toggleFullscreen);
        function updateFullscreenButtonStyle() {
            const tempButton = document.getElementById('tempFullscreenButton'); if (tempButton) tempButton.remove();
            if (isLandscapeMode) {
                const exitButton = document.createElement('div');
                exitButton.id = 'tempFullscreenButton';
                exitButton.style.cssText = `position: absolute; bottom: 20px; left: 20px; width: 30px; height: 30px; background: rgba(0,0,0,0.5); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1000;`;
                exitButton.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" /></svg>`;
                exitButton.onclick = toggleFullscreen;
                document.querySelector('#browser-screen .browser-main').appendChild(exitButton);
            }
        }
        function searchAndOpen() { document.getElementById('browserFrame').src = 'https://www.zhenhunxiaoshuo.com/'; }

        // =======================================================
        // ================= WORLD BOOK SCRIPT ===================
        // =======================================================
        const worldbookAppIcon = document.getElementById('worldbook-app-icon'), worldbookScreen = document.getElementById('worldbook-screen');
        const worldbookListPage = document.getElementById('worldbook-list-page'), worldbookEditPage = document.getElementById('worldbook-edit-page');
        const addEntryBtn = document.getElementById('add-entry-btn'), deleteEntriesBtn = document.getElementById('delete-entries-btn');
        const entryListContainer = document.getElementById('worldbook-entry-list'), saveEntryBtn = document.getElementById('save-entry-btn');
        const entryNameInput = document.getElementById('worldbook-entry-name'), entryContentInput = document.getElementById('worldbook-entry-content');
        let worldBookEntries = [], currentEditingId = null, isDeleteMode = false, itemsToDelete = new Set();
        // 新增：专门用于保存世界书数据的函数
function saveWorldBookData() {
    localStorage.setItem('worldBookEntries', JSON.stringify(worldBookEntries));
}
        function renderWorldBookList() {
            entryListContainer.innerHTML = worldBookEntries.length ? '' : `<p class="text-center text-gray-500 mt-8">你的世界空空如也，点击右上角 '+' 开始创造吧。</p>`;
            worldBookEntries.forEach(entry => {
                const item = document.createElement('div'); item.className = 'entry-item'; item.dataset.id = entry.id; item.innerHTML = `<h3 class="font-bold text-lg">${entry.name}</h3>`;
                item.addEventListener('click', () => {
                    if (isDeleteMode) {
                        item.classList.toggle('selecting');
                        itemsToDelete.has(entry.id) ? itemsToDelete.delete(entry.id) : itemsToDelete.add(entry.id);
                        deleteEntriesBtn.textContent = `删除(${itemsToDelete.size})`;
                    } else {
                        currentEditingId = entry.id; entryNameInput.value = entry.name; entryContentInput.value = entry.content;
                        document.getElementById('worldbook-edit-title').textContent = "编辑篇章"; showWorldBookPage('edit');
                    }
                });
                let pressTimer;
                item.addEventListener('touchstart', (e) => { pressTimer = setTimeout(() => { e.preventDefault(); if (!isDeleteMode) enterDeleteMode(entry.id); }, 500); });
                item.addEventListener('touchend', () => clearTimeout(pressTimer));
                item.addEventListener('touchmove', () => clearTimeout(pressTimer));
                entryListContainer.appendChild(item);
            });
        }
        function showWorldBookPage(page) { worldbookListPage.style.display = page === 'list' ? 'flex' : 'none'; worldbookEditPage.style.display = page === 'edit' ? 'flex' : 'none'; }
        function enterDeleteMode(firstItemId) {
            isDeleteMode = true; itemsToDelete.clear(); itemsToDelete.add(firstItemId);
            addEntryBtn.classList.add('hidden'); deleteEntriesBtn.classList.remove('hidden'); deleteEntriesBtn.textContent = `删除(1)`;
            document.querySelector(`#worldbook-entry-list .entry-item[data-id="${firstItemId}"]`)?.classList.add('selecting');
        }
        function exitDeleteMode() {
            isDeleteMode = false; itemsToDelete.clear();
            addEntryBtn.classList.remove('hidden'); deleteEntriesBtn.classList.add('hidden');
            document.querySelectorAll('#worldbook-entry-list .entry-item.selecting').forEach(el => el.classList.remove('selecting'));
        }
        worldbookAppIcon.addEventListener('click', () => { 
    worldBookEntries = JSON.parse(localStorage.getItem('worldBookEntries') || '[]'); // <-- 修改这行，先读档
    showMainScreen('worldbook-screen'); 
    renderWorldBookList(); 
});
        document.getElementById('back-to-home-from-worldbook').addEventListener('click', () => { if (isDeleteMode) exitDeleteMode(); showMainScreen('home-screen'); });
        addEntryBtn.addEventListener('click', () => {
            currentEditingId = null; entryNameInput.value = ''; entryContentInput.value = '';
            document.getElementById('worldbook-edit-title').textContent = "新的篇章"; showWorldBookPage('edit');
        });
        document.getElementById('back-to-list-from-edit').addEventListener('click', () => showWorldBookPage('list'));
        saveEntryBtn.addEventListener('click', () => {
            const name = entryNameInput.value.trim(), content = entryContentInput.value.trim();
            if (!name) { alert('请为你的世界命名！'); return; }
            if (currentEditingId) {
                const index = worldBookEntries.findIndex(e => e.id === currentEditingId);
                if (index > -1) { worldBookEntries[index].name = name; worldBookEntries[index].content = content; }
            } else {
                worldBookEntries.unshift({ id: Date.now().toString(), name, content });
            }
            saveWorldBookData(); // <-- 在这里添加
renderWorldBookList(); 
showWorldBookPage('list');
        });
        deleteEntriesBtn.addEventListener('click', () => {
            if (itemsToDelete.size === 0) return alert("请选择要删除的条目。");
            if (confirm(`确定要删除这 ${itemsToDelete.size} 个世界吗？`)) {
                worldBookEntries = worldBookEntries.filter(entry => !itemsToDelete.has(entry.id));
saveWorldBookData(); // <-- 在这里添加
exitDeleteMode(); 
renderWorldBookList();
            }
        });
    });
    </script>
</body>
</html>